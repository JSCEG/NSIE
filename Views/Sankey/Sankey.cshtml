@* 
🔧 Mejora visual de esta vista .cshtml sin afectar la lógica existente. Instrucciones para Copilot:

- Aplica estilos profesionales con Bootstrap 5 (cards, tablas, botones, alerts, etc.).
- Usa animaciones AOS en títulos y secciones importantes.
- Si hay una tabla, intégrala con DataTables:
  - Soporte de búsqueda en tiempo real, paginación y exportación (Excel, PDF, CSV).
  - Soporte para scroll horizontal si hay muchas columnas.
- Si hay métricas o datos que podrían visualizarse gráficamente, sugiere e incluye un gráfico tipo demo con Highcharts (sin romper la lógica actual).
- Mantén y respeta los scripts, modales y secciones @section que ya existen.
- Conserva todas las estructuras Razor y C# sin cambios en nombres ni flujos.
- Agrega mejoras tipo demo solo si son útiles para el usuario (por ejemplo, filtros por unidad, cards resumen, tooltips, badges, alertas informativas).
- Respeta la estructura general del layout y la vista parcial _ViewHeader ya integrada.
- Asegúrate de que todo sea responsive y se vea bien en móviles y escritorio.

IMPORTANTE: No elimines scripts de funcionalidad ya presentes. Si mejoras algo, que sea compatible.

Ahora, mejora esta vista debajo de este comentario.
*@

@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json
@using NSIE.Models
@inject IHttpContextAccessor HttpContextAccessor

@{
    var httpContext = HttpContextAccessor.HttpContext;
    var perfilUsuarioJson = httpContext.Session.GetString("PerfilUsuario");
    var perfilUsuario = JsonConvert.DeserializeObject<PerfilUsuario>(perfilUsuarioJson);
    ViewData["NombreUsuario"] = perfilUsuario.Nombre;
    ViewData["RolUsuario"] = perfilUsuario.Rol;
    ViewData["Title"] = "Balance Nacional de Energía";
}

@{
    var header = new HeaderViewModel
    {
        Title = "Balance Nacional de Energía",
        IconPath = "sankey.png",
        Description = "Visualiza flujo energético nacional",
        Section = "📊 Datos Públicos",
        ModuleInfo = JsonConvert.SerializeObject(new
        {
            title = "Balance Nacional de Energía",
            description = "Sistema de visualización del flujo energético nacional mediante diagramas Sankey.",
            functionality = "Permite analizar la transformación y flujo de energía en el sistema nacional.",
            stage = "Visualización Estratégica",
            roles = new[] {
new { icon = "building", text = "SENER: Validación oficial" },
new { icon = "graduation-cap", text = "Universidades: Investigación" },
new { icon = "microscope", text = "Centros de Investigación: Análisis" },
new { icon = "chart-bar", text = "INEGI: Datos estadísticos" }
},
            order = new { step = 2, description = "Sintetiza flujo energético nacional" }
        }),
        LegalDescription = "Visualización del balance energético conforme al Art. 70 del Reglamento.",
        Fundamentos = new List<FundamentoLegal> {
new() { Reference = "Art. 70 Reglamento", Description = "Establece los lineamientos para el balance energético nacional"
}
}
    };
}

@await Html.PartialAsync("_ViewHeader", header)

<div class="ps-2 pe-2 pt-5">
    <div class="row mb-4" data-aos="fade-down">
        <div class="col-12">
            <h2 class="fw-bold subtitulo">Seleccione un Año:</h2>
        </div>
    </div>

    <!-- Filtros y acciones -->
    <div class="row g-2 align-items-end mb-4" data-aos="fade-up">
        <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">Año</label>
            <select id="year" class="form-select">
                @foreach (var year in ViewBag.Years)
                {
                    if (year == 2022)
                    {
                        <option value="@year" selected>@year</option>
                    }
                    else
                    {
                        <option value="@year">@year</option>
                    }
                }
            </select>
        </div>
        <div class="col-6 col-md-4">
            <button id="btnEjecutar" class="btn btn-outline-primary w-100" data-aos="zoom-in">
                <i class="bi bi-search"></i> Consulta
            </button>
        </div>
        <div class="col-6 col-md-4">
            <button id="btnPantallaCompleta" class="btn btn-danger w-100" data-aos="zoom-in">
                <i class="bi bi-arrows-fullscreen"></i> Ver en Pantalla Completa
            </button>
        </div>
    </div>

    <!-- Mensaje de alerta -->
    <div class="row" data-aos="fade-left">
        <div class="col-12">
            <div id="message" class="alert alert-warning d-none" role="alert">
                <!-- Mensaje aquí -->
            </div>
        </div>
    </div>

    <div id="flujoPantallaCompleta" class="pt-3">
        <div class="alert alert-light" role="alert" data-aos="fade-up">
            <center>
                <h3 class="alert-heading" data-aos="fade-down">Totales</h3>
            </center>
            <!-- Tarjetas de totales generadas dinámicamente -->
            <div class="row justify-content-center g-3 flex-wrap" id="tarjetas-totales" data-aos="zoom-in-up">
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 d-flex align-items-stretch" data-aos="flip-left">
                    <div class="card shadow border-0 w-100 h-100">
                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                            <span class="badge bg-primary bg-opacity-75 mb-2 px-3 py-2 fs-6 shadow-sm">
                                <i class="bi bi-lightning-charge me-1"></i> Nivel FEP - Fuentes de Energía Primaria
                            </span>
                            <div class="fw-bold text-secondary mb-1" style="font-size:1.1rem;" id="total-fep">--</div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 d-flex align-items-stretch" data-aos="flip-left"
                    data-aos-delay="50">
                    <div class="card shadow border-0 w-100 h-100">
                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                            <span class="badge bg-info bg-opacity-75 mb-2 px-3 py-2 fs-6 shadow-sm">
                                <i class="bi bi-diagram-3 me-1"></i> Nivel FOCAL - Sector Energético
                            </span>
                            <div class="fw-bold text-secondary mb-1" style="font-size:1.1rem;" id="total-focal">--</div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 d-flex align-items-stretch" data-aos="flip-left"
                    data-aos-delay="100">
                    <div class="card shadow border-0 w-100 h-100">
                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                            <span class="badge bg-success bg-opacity-75 mb-2 px-3 py-2 fs-6 shadow-sm">
                                <i class="bi bi-gear me-1"></i> Nivel 1 - Provisión y Producción
                            </span>
                            <div class="fw-bold text-secondary mb-1" style="font-size:1.1rem;" id="total-nivel1">--
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 d-flex align-items-stretch" data-aos="flip-left"
                    data-aos-delay="150">
                    <div class="card shadow border-0 w-100 h-100">
                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                            <span class="badge bg-warning bg-opacity-75 mb-2 px-3 py-2 fs-6 shadow-sm">
                                <i class="bi bi-arrow-repeat me-1"></i> Nivel 2 - Transformaciones
                            </span>
                            <div class="fw-bold text-secondary mb-1" style="font-size:1.1rem;" id="total-nivel2">--
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 d-flex align-items-stretch" data-aos="flip-left"
                    data-aos-delay="200">
                    <div class="card shadow border-0 w-100 h-100">
                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                            <span class="badge bg-secondary bg-opacity-75 mb-2 px-3 py-2 fs-6 shadow-sm">
                                <i class="bi bi-layers me-1"></i> Nivel 3 - Tipos de Energía
                            </span>
                            <div class="fw-bold text-secondary mb-1" style="font-size:1.1rem;" id="total-nivel3">--
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 d-flex align-items-stretch" data-aos="flip-left"
                    data-aos-delay="250">
                    <div class="card shadow border-0 w-100 h-100">
                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                            <span class="badge bg-dark bg-opacity-75 mb-2 px-3 py-2 fs-6 shadow-sm">
                                <i class="bi bi-truck me-1"></i> Nivel 4 - Distribución
                            </span>
                            <div class="fw-bold text-secondary mb-1" style="font-size:1.1rem;" id="total-nivel4">--
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 d-flex align-items-stretch" data-aos="flip-left"
                    data-aos-delay="300">
                    <div class="card shadow border-0 w-100 h-100">
                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                            <span class="badge bg-danger bg-opacity-75 mb-2 px-3 py-2 fs-6 shadow-sm">
                                <i class="bi bi-people me-1"></i> Nivel 5 - Uso Final
                            </span>
                            <div class="fw-bold text-secondary mb-1" style="font-size:1.1rem;" id="total-nivel5">--
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico SVG Sankey -->
        <div style="overflow-x:auto;" data-aos="fade-up">
            <div class="map-container_sankey">
                <div class="container-fluid">
                    <div class="row mt-3">
                        <div class="col-12" data-aos="zoom-in">
                            <div
                                style="overflow-x:auto; display:flex; justify-content:center; align-items:center; position: relative; z-index: 2;">
                                <svg width="100%" height="1400px" id="sankeySvg" style="position: relative;">
                                    <g id="particlesGroup"></g>
                                    <!-- Otros elementos del gráfico Sankey -->
                                </svg>
                            </div>
                        </div>
                        <br>
                        <br>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fuente de datos -->
        <div class="row mt-3" style="position: relative;" data-aos="fade-right">
            <div class="col-12" style="text-align: left;">
                <i>
                    <span class="text-muted small">
                        Fuente: Inventario Nacional de Emisiones de Gases y Compuestos de Efecto Invernadero (INEGyCEI)
                        (<a href="https://datos.gob.mx/busca/dataset/inventario-nacional-de-emisiones-de-gases-y-compuestos-de-efecto-invernadero-inegycei"
                            target="_blank" style="color: #9f2241;">
                            datos.gob.mx/busca/dataset/inventario-nacional-de-emisiones-de-gases-y-compuestos-de-efecto-invernadero-inegycei
                        </a>)
                    </span>
                </i>
            </div>
        </div>

        <!-- Tabla de datos energéticos -->
        <div class="table-responsive" data-aos="fade-up">
            <div class="container-fluid">
                <div class="row mt-3">
                    <div class="col-12">
                        <table id="Tipos" class="table table-hover table-responsive table-bordered">
                            <thead>
                                <tr>
                                    <th>Año</th>
                                    <th>Nivel</th>
                                    <th>Dato</th>
                                    <th>Valores (PJ)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Los datos se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficas adicionales y controles -->
        <div class="row mt-3" style="position: relative;" data-aos="fade-up">
            <div style="position: relative;">
                <div style="position: absolute; top: 5px; right: 15px; z-index: 1000;">
                    <button id="regresarSankeyButton" class="btn btn-danger"
                        style="display: none; background-color: #9f2241; color: white; font-size: 15px; width: 80px; height: 40px; line-height: 1;">Ocultar</button>
                </div>
            </div>
            <!-- Gráfica original y controles -->
            <div class="col-md-6" style="position: relative;" data-aos="fade-right">
                <br>
                <br>
                <div id="highchartsContainer"
                    style="width: 100%; max-height: 400px; margin: 0 auto; display: none; position: relative; z-index: 1;">
                    <!-- Aquí se insertará el gráfico de Highcharts -->
                </div>
                <div class="d-flex justify-content-center align-items-center">
                    <button id="playButton" class="btn btn-danger"
                        style="display: none; background-color: #9f2241; color: white; font-size: 15px; width: 63px; height: 40px; line-height: 1; padding: 0; position: relative;">
                        <img src="/img/play.png" alt="Play"
                            style="width: 30%; height: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                    </button>
                    <input type="range" id="yearSlider" class="ml-3"
                        style="width: 80%; display: none; background-color: #9f2241; color: white; border: 1px solid white; -webkit-appearance: none;">
                    <style>
                        input[type="range"]::-webkit-slider-runnable-track {
                            width: 100%;
                            height: 8px;
                            background: #9f2241;
                            border-radius: 5px;
                            border: none;
                        }

                        input[type="range"]::-webkit-slider-thumb {
                            -webkit-appearance: none;
                            width: 20px;
                            height: 20px;
                            background: #BFBFBF;
                            border-radius: 50%;
                            border: 2px solid #9f2241;
                            cursor: pointer;
                            margin-top: -6px;
                        }

                        input[type="range"]::-webkit-slider-thumb:active {
                            background: white;
                            border-color: #9f2241;
                        }
                    </style>
                </div>
            </div>
            <!-- Nueva gráfica -->
            <div class="col-md-6" style="position: relative;" data-aos="fade-left">
                <br>
                <br>
                <div id="newChartContainer"
                    style="width: 100%; max-height: 400px; margin: 0 auto; position: relative; z-index: 1; height: 400px; display:none;">
                    <!-- Inserta tu nueva gráfica aquí -->
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="/js/sankey.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            iniciarSankey();
        });
    </script>
}
