@model IEnumerable<UserViewModel>
@inject IHttpContextAccessor HttpContextAccessor
@using NSIE.Models
@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json

@{
    var httpContext = HttpContextAccessor.HttpContext;
    var perfilUsuarioJson = httpContext.Session.GetString("PerfilUsuario");
    var perfilUsuario = JsonConvert.DeserializeObject<PerfilUsuario>(perfilUsuarioJson);
    ViewData["NombreUsuario"] = perfilUsuario.Nombre;
    ViewData["RolUsuario"] = perfilUsuario.Rol;
    ViewData["MercadoUsuario"] = perfilUsuario.Mercado_ID;
    ViewData["IDUsuario"] = perfilUsuario.IdUsuario;
    ViewData["Title"] = "Gestión de Usuarios y Perfiles";
}

@{
    var header = new HeaderViewModel
    {
        Title = "Gestión de Usuarios y Perfiles",
        IconPath = "usuarios_scel.png",
        Description = "Gestiona perfiles, roles y accesos según normativa.",
        Section = "Gobernanza y Seguridad",
        ModuleInfo = JsonConvert.SerializeObject(new
        {
            title = "Gestión de Usuarios y Perfiles",
            description = "Sistema de administración de usuarios y control de accesos del SNIEr.",
            functionality = "Permite gestionar usuarios, asignar roles y mantener la trazabilidad de accesos.",
            stage = "Inicialización",
            roles = new[] {
                new { icon = "user-cog", text = "Administrador: Control total de perfiles y accesos" },
                new { icon = "user-lock", text = "Supervisor: Revisión y asignación de roles" }
            },
            order = new { step = 1, description = "Primera configuración tras el registro del usuario" },
            manualUrl = "/Documentos/ManualUsuarios.pdf"
        })
    };
}

@await Html.PartialAsync("_ViewHeader", header)



<div class="container-fluid px-3 px-md-5">
    <div class="row mb-4">
        <div class="col">
            <a asp-controller="Usuarios" asp-action="NuevoUsuario" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> Agregar Nuevo Usuario
            </a>
        </div>
    </div>

<div class="table-responsive table-scroll-vertical shadow-sm rounded">
    <table id="usuariosTabla" class="table table-bordered table-hover align-middle table-striped text-nowrap w-100">
        <thead class="table-dark text-white">
            <tr class="text-center sticky-top z-3">
                <th scope="col">Acciones</th>
                <th scope="col">IdUsuario</th>
                <th scope="col">Nombre</th>
                <th scope="col">Cargo</th>
                <th scope="col">Unidad de Adscripción</th>
                <th scope="col">Sesión Activa</th>
                <th scope="col">Correo</th>
                <th scope="col">Clave</th>
                <th scope="col">Última Actualización</th>
                <th scope="col">RFC</th>
                <th scope="col">Vigente</th>
                <th scope="col">Clave Empleado</th>
                <th scope="col">Hora Inicio Sesión</th>
                <th scope="col">Rol</th>
                <th scope="col">Mercado ID</th>
                <th scope="col">Rol Usuario Vigente</th>
                <th scope="col">Rol Usuario Quien Registro</th>
                <th scope="col">Rol Usuario Fecha Modificación</th>
                <th scope="col">Rol Usuario Comentarios</th>
                <th scope="col">Rol Nombre</th>
                <th scope="col">Rol Vigente</th>
                <th scope="col">Rol Fecha Modificación</th>
                <th scope="col">Rol Comentario</th>
                <th scope="col">Mercado Nombre</th>
                <th scope="col">Mercado Vigente</th>
                <th scope="col">Mercado Fecha Modificación</th>
                <th scope="col">Mercado Comentario</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in Model)
            {
                <tr>
                    <td class="text-center">
                        <a class="btn btn-sm btn-primary me-1" href="@Url.Action("Edit", "Usuarios", new { id = user.IdUsuario })">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="@Url.Action("Eliminar", "Usuarios", new { id = user.IdUsuario })" class="btn btn-sm btn-danger delete-link">
                            <i class="fas fa-trash-alt"></i>
                        </a>
                    </td>
                    <td>@user.IdUsuario</td>
                    <td>@user.Nombre</td>
                    <td>@user.Cargo</td>
                    <td>@user.Unidad_de_Adscripcion</td>
                    <td>@user.SesionActiva</td>
                    <td>@user.Correo</td>
                    <td>@user.Clave</td>
                    <td>@user.UltimaActualizacion</td>
                    <td>@user.RFC</td>
                    <td>@user.Vigente</td>
                    <td>@user.ClaveEmpleado</td>
                    <td>@user.HoraInicioSesion</td>
                    <td>@user.Rol</td>
                    <td>@user.Mercado_ID</td>
                    <td>@user.RolUsuario_Vigente</td>
                    <td>@user.RolUsuario_QuienRegistro</td>
                    <td>@user.RolUsuario_FechaMod</td>
                    <td>@user.RolUsuario_Comentarios</td>
                    <td>@user.Rol_Nombre</td>
                    <td>@user.Rol_Vigente</td>
                    <td>@user.Rol_FechaMod</td>
                    <td>@user.Rol_Comentario</td>
                    <td>@user.Mercado_Nombre</td>
                    <td>@user.Mercado_Vigente</td>
                    <td>@user.Mercado_FechaMod</td>
                    <td>@user.Mercado_Comentario</td>
                </tr>
            }
        </tbody>
    </table>
</div>


    @*Modal para Confirmar la Eliminación*@
    <!-- Modal HTML -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ¿Estás seguro de que deseas eliminar este usuario?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <a href="#" class="btn btn-danger" id="confirmDeleteButton">Eliminar</a>
                </div>
            </div>
        </div>
    </div>


    @{
        var userMessage = TempData["UserMessage"] as string;
        var isSuccess = TempData["IsSuccess"] as bool?;
    }

    @if (!string.IsNullOrEmpty(userMessage))
    {
        <input type="hidden" id="userMessage" value="@userMessage" />
        <input type="hidden" id="isSuccess" value="@isSuccess" />

        <!-- Modal HTML -->
        <div class="modal" tabindex="-1" id="userMessageModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Mensaje</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="modalBody">
                        <!-- El mensaje al usuario se inserta aquí con JavaScript -->
                </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>


    }

</div>

@section scripts{
    @*Modal para confirmar la eliminación*@
<script>
            document.addEventListener("DOMContentLoaded", function () {
        var confirmDeleteButton = document.getElementById("confirmDeleteButton");
        var deleteLinks = document.querySelectorAll(".delete-link");

        deleteLinks.forEach(link => {
            link.addEventListener("click", function (e) {
                e.preventDefault();
                // Configurar el href del botón de confirmación con el href del enlace de eliminación.
                confirmDeleteButton.href = link.href;
                var confirmDeleteModal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));
                confirmDeleteModal.show();
            });
        });
    });

</script>



@*Modal Mensaje de Exito o error al eliminar*@
<!-- Script para mostrar el modal con el mensaje del usuario -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var userMessage = document.getElementById("userMessage").value;
        var isSuccess = document.getElementById("isSuccess").value.toLowerCase() === "true";

        // Puedes personalizar los colores de los mensajes según el éxito o el fracaso
        var messageColor = isSuccess ? "green" : "red";

        document.getElementById("modalBody").innerText = userMessage;
        document.getElementById("modalBody").style.color = messageColor;

        var userMessageModal = new bootstrap.Modal(document.getElementById("userMessageModal"));
        userMessageModal.show();
    });
</script>

<script>
    $(document).ready(function () {
        var table = $('#usuariosTabla').DataTable({
            lengthMenu: [[10, 50, 100, -1], [10, 50, 100, "Todos"]],
            dom: 'Blfrtip',
            responsive: true,
            scrollY: '60vh',           // ✅ Altura del área de scroll
            scrollCollapse: true,      // ✅ Colapsa si hay pocas filas
            scrollX: true,             // Scroll horizontal para muchas columnas
            fixedHeader: true,         // Fija el encabezado al hacer scroll
            buttons: [
                {
                    extend: 'copyHtml5',
                    title: 'Energeo Lista de Usuarios de la Plataforma'
                },
                {
                    extend: 'excelHtml5',
                    title: 'Energeo Lista de Usuarios de la Plataforma'
                },
                {
                    extend: 'csvHtml5',
                    title: 'Energeo Lista de Usuarios de la Plataforma'
                },
                {
                    extend: 'pdfHtml5',
                    title: 'Energeo Lista de Usuarios de la Plataforma',
                    customize: function (doc) {
                        doc.styles.tableHeader.color = '#9fa1a4';
                        doc.defaultStyle.alignment = 'center';
                        doc.styles.tableHeader.fillColor = '#4c1922';
                    }
                }
            ],
        });
    });
</script>


  }