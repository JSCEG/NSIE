@model IEnumerable<UserViewModel>
@inject IHttpContextAccessor HttpContextAccessor
@using NSIE.Models
@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json

@{
    var httpContext = HttpContextAccessor.HttpContext;
    var perfilUsuarioJson = httpContext.Session.GetString("PerfilUsuario");
    var perfilUsuario = JsonConvert.DeserializeObject<PerfilUsuario>(perfilUsuarioJson);
    ViewData["NombreUsuario"] = perfilUsuario.Nombre;
    ViewData["RolUsuario"] = perfilUsuario.Rol;
    ViewData["MercadoUsuario"] = perfilUsuario.Mercado_ID;
    ViewData["IDUsuario"] = perfilUsuario.IdUsuario;
    ViewData["Title"] = "Gestión de Usuarios y Perfiles";
}

@{
    var header = new HeaderViewModel
    {
        Title = "Gestión de Usuarios y Perfiles",
        IconPath = "usuarios_scel.png",
        Description = "Gestiona perfiles, roles y accesos según normativa.",
        Section = "Gobernanza y Seguridad",
        ModuleInfo = JsonConvert.SerializeObject(new
        {
            title = "Gestión de Usuarios y Perfiles",
            description = "Sistema de administración de usuarios y control de accesos del SNIEr.",
            functionality = "Permite gestionar usuarios, asignar roles y mantener la trazabilidad de accesos.",
            stage = "Inicialización",
            roles = new[] {
new { icon = "user-cog", text = "Administrador: Control total de perfiles y accesos" },
new { icon = "user-lock", text = "Supervisor: Revisión y asignación de roles" }
},
            order = new { step = 1, description = "Primera configuración tras el registro del usuario" },
            manualUrl = "/Documentos/ManualUsuarios.pdf"
        })
    };
}

@await Html.PartialAsync("_ViewHeader", header)

@{
    var delayBase = 200;
    var i = 0;
}

<div class="container-fluid px-3 px-md-5">
    <div class="row mb-4" data-aos="fade-right" data-aos-delay="150">
        <div class="col">
            <a asp-controller="Usuarios" asp-action="NuevoUsuario" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> Agregar Nuevo Usuario
            </a>
        </div>
    </div>

    <div class="table-responsive table-scroll-vertical shadow-sm rounded" data-aos="fade-up" data-aos-delay="300">
        <table id="usuariosTabla" class="table table-bordered table-hover align-middle table-striped text-nowrap w-100">
            <thead class="table-dark text-white">
                <tr class="text-center sticky-top z-3">
                    <th scope="col">Acciones</th>
                    <th scope="col">IdUsuario</th>
                    <th scope="col">Nombre</th>
                    <th scope="col">Cargo</th>
                    <th scope="col">Unidad de Adscripción</th>
                    <th scope="col">Sesión Activa</th>
                    <th scope="col">Correo</th>
                    <th scope="col">Clave</th>
                    <th scope="col">Última Actualización</th>
                    <th scope="col">RFC</th>
                    <th scope="col">Vigente</th>
                    <th scope="col">Clave Empleado</th>
                    <th scope="col">Hora Inicio Sesión</th>
                    <th scope="col">Rol</th>
                    <th scope="col">Mercado ID</th>
                    <th scope="col">Rol Usuario Vigente</th>
                    <th scope="col">Rol Usuario Quien Registro</th>
                    <th scope="col">Rol Usuario Fecha Modificación</th>
                    <th scope="col">Rol Usuario Comentarios</th>
                    <th scope="col">Rol Nombre</th>
                    <th scope="col">Rol Vigente</th>
                    <th scope="col">Rol Fecha Modificación</th>
                    <th scope="col">Rol Comentario</th>
                    <th scope="col">Mercado Nombre</th>
                    <th scope="col">Mercado Vigente</th>
                    <th scope="col">Mercado Fecha Modificación</th>
                    <th scope="col">Mercado Comentario</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model)
                {
                    <tr data-aos="fade-up" data-aos-delay="@(delayBase + i * 50)">
                        <td class="text-center">
                            <a class="btn btn-sm btn-primary me-1"
                                href="@Url.Action("Edit", "Usuarios", new { id = user.IdUsuario })">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="@Url.Action("Eliminar", "Usuarios", new { id = user.IdUsuario })"
                                class="btn btn-sm btn-danger delete-link">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </td>
                        <td>@user.IdUsuario</td>
                        <td>@user.Nombre</td>
                        <td>@user.Cargo</td>
                        <td>@user.Unidad_de_Adscripcion</td>
                        <td>@user.SesionActiva</td>
                        <td>@user.Correo</td>
                        <td>@user.Clave</td>
                        <td>@user.UltimaActualizacion</td>
                        <td>@user.RFC</td>
                        <td>@user.Vigente</td>
                        <td>@user.ClaveEmpleado</td>
                        <td>@user.HoraInicioSesion</td>
                        <td>@user.Rol</td>
                        <td>@user.Mercado_ID</td>
                        <td>@user.RolUsuario_Vigente</td>
                        <td>@user.RolUsuario_QuienRegistro</td>
                        <td>@user.RolUsuario_FechaMod</td>
                        <td>@user.RolUsuario_Comentarios</td>
                        <td>@user.Rol_Nombre</td>
                        <td>@user.Rol_Vigente</td>
                        <td>@user.Rol_FechaMod</td>
                        <td>@user.Rol_Comentario</td>
                        <td>@user.Mercado_Nombre</td>
                        <td>@user.Mercado_Vigente</td>
                        <td>@user.Mercado_FechaMod</td>
                        <td>@user.Mercado_Comentario</td>
                    </tr>
                    i++;
                }
            </tbody>
        </table>
    </div>
</div>
