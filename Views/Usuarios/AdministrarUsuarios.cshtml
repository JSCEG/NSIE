@model IEnumerable<UserViewModel>
@inject IHttpContextAccessor HttpContextAccessor
@using NSIE.Models
@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json


@{
    var httpContext = HttpContextAccessor.HttpContext;
    var perfilUsuarioJson = httpContext.Session.GetString("PerfilUsuario");
    var perfilUsuario = JsonConvert.DeserializeObject<PerfilUsuario>(perfilUsuarioJson);

    // Utilizar los datos del usuario para personalizar la vista
    ViewData["NombreUsuario"] = perfilUsuario.Nombre;
    ViewData["RolUsuario"] = perfilUsuario.Rol;
    ViewData["MercadoUsuario"] = perfilUsuario.Mercado_ID;
    ViewData["IDUsuario"] = perfilUsuario.IdUsuario;
    ViewData["Title"] = "Panel de Administración";
}





<div class="text-center">
    <h3 class="cp-section cp-grouping-section"> <img src="~/img/mexicoi.png" alt="Icono personalizado" class="iconomenu">@ViewData["Title"]</h3>
</div>
<!-- Miga de Pan -->
<nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='currentColor'/%3E%3C/svg%3E&#34;);" aria-label="breadcrumb" style="padding-left:15px">
    <ol class="breadcrumb lp-5">
        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home" )">Inicio</a></li>
        <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
    </ol>
</nav>
<br />

<div class="container">
    <h6 class="display-6 fw-bold subtitulo pl-3%">Lista de Usuarios</h6>
    <a asp-controller="Usuarios" asp-action="NuevoUsuario" class="btn btn-primary">Agregar Nuevo Usuario</a>

    <div class="table-responsive">
        <table id="usuariosTabla" class="table table-hover table-responsive table-bordered">
            <thead>
                <tr>
                    <th>Acciones</th>
                    <th>IdUsuario</th>
                    <th>Nombre</th>
                    <th>Cargo</th>
                    <th>Unidad de Adscripción</th>
                    <th>Sesión Activa</th>
                    <th>Correo</th>
                    <th>Clave</th>
                    <th>Última Actualización</th>
                    <th>RFC</th>
                    <th>Vigente</th>
                    <th>Clave Empleado</th>
                    <th>Hora Inicio Sesión</th>
                    <th>Rol</th>
                    <th>Mercado ID</th>
                    <th>Rol Usuario Vigente</th>
                    <th>Rol Usuario Quien Registro</th>
                    <th>Rol Usuario Fecha Modificación</th>
                    <th>Rol Usuario Comentarios</th>
                    <th>Rol Nombre</th>
                    <th>Rol Vigente</th>
                    <th>Rol Fecha Modificación</th>
                    <th>Rol Comentario</th>
                    <th>Mercado Nombre</th>
                    <th>Mercado Vigente</th>
                    <th>Mercado Fecha Modificación</th>
                    <th>Mercado Comentario</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model)
                {
                    <tr>
                        <td>
                            @*Acciones*@
                            <a class="btn btn-primary" href="@Url.Action("Edit", "Usuarios", new { id = user.IdUsuario })">Editar</a>
                            <a href="@Url.Action("Eliminar", "Usuarios", new { id = user.IdUsuario })" class="btn btn-danger delete-link">Eliminar</a>
                        </td>


                        <td>@user.IdUsuario</td>
                        <td>@user.Nombre</td>
                        <td>@user.Cargo</td>
                        <td>@user.Unidad_de_Adscripcion</td>
                        <td>@user.SesionActiva</td>
                        <td>@user.Correo</td>
                        <td>@user.Clave</td>
                        <td>@user.UltimaActualizacion</td>
                        <td>@user.RFC</td>
                        <td>@user.Vigente</td>
                        <td>@user.ClaveEmpleado</td>
                        <td>@user.HoraInicioSesion</td>
                        <td>@user.Rol</td>
                        <td>@user.Mercado_ID</td>
                        <td>@user.RolUsuario_Vigente</td>
                        <td>@user.RolUsuario_QuienRegistro</td>
                        <td>@user.RolUsuario_FechaMod</td>
                        <td>@user.RolUsuario_Comentarios</td>
                        <td>@user.Rol_Nombre</td>
                        <td>@user.Rol_Vigente</td>
                        <td>@user.Rol_FechaMod</td>
                        <td>@user.Rol_Comentario</td>
                        <td>@user.Mercado_Nombre</td>
                        <td>@user.Mercado_Vigente</td>
                        <td>@user.Mercado_FechaMod</td>
                        <td>@user.Mercado_Comentario</td>
                    </tr>
                }
            </tbody>
        </table>

    </div>
    @*Modal para Confirmar la Eliminación*@
    <!-- Modal HTML -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ¿Estás seguro de que deseas eliminar este usuario?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <a href="#" class="btn btn-danger" id="confirmDeleteButton">Eliminar</a>
                </div>
            </div>
        </div>
    </div>


    @{
        var userMessage = TempData["UserMessage"] as string;
        var isSuccess = TempData["IsSuccess"] as bool?;
    }

    @if (!string.IsNullOrEmpty(userMessage))
    {
        <input type="hidden" id="userMessage" value="@userMessage" />
        <input type="hidden" id="isSuccess" value="@isSuccess" />

        <!-- Modal HTML -->
        <div class="modal" tabindex="-1" id="userMessageModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Mensaje</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="modalBody">
                        <!-- El mensaje al usuario se inserta aquí con JavaScript -->
                </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>


    }

</div>

@section scripts{
    @*Modal para confirmar la eliminación*@
<script>
            document.addEventListener("DOMContentLoaded", function () {
        var confirmDeleteButton = document.getElementById("confirmDeleteButton");
        var deleteLinks = document.querySelectorAll(".delete-link");

        deleteLinks.forEach(link => {
            link.addEventListener("click", function (e) {
                e.preventDefault();
                // Configurar el href del botón de confirmación con el href del enlace de eliminación.
                confirmDeleteButton.href = link.href;
                var confirmDeleteModal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));
                confirmDeleteModal.show();
            });
        });
    });

</script>



@*Modal Mensaje de Exito o error al eliminar*@
<!-- Script para mostrar el modal con el mensaje del usuario -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var userMessage = document.getElementById("userMessage").value;
        var isSuccess = document.getElementById("isSuccess").value.toLowerCase() === "true";

        // Puedes personalizar los colores de los mensajes según el éxito o el fracaso
        var messageColor = isSuccess ? "green" : "red";

        document.getElementById("modalBody").innerText = userMessage;
        document.getElementById("modalBody").style.color = messageColor;

        var userMessageModal = new bootstrap.Modal(document.getElementById("userMessageModal"));
        userMessageModal.show();
    });
</script>

<script>
    $(document).ready(function () {

        var table = $('#usuariosTabla').DataTable({
            lengthMenu: [[10, 50, 100, -1], [10, 50, 100, "Todos"]],
            dom: 'Blfrtip',
            buttons: [
                {
                    extend: 'copyHtml5',
                    title: 'Energeo Lista de Usuarios de la Plataforma'
                },
                {
                    extend: 'excelHtml5',
                    title: 'Energeo Lista de Usuarios de la Plataforma'
                },
                {
                    extend: 'csvHtml5',
                    title: 'Energeo Lista de Usuarios de la Plataforma'
                },
                {
                    extend: 'pdfHtml5',
                    title: 'Energeo Lista de Usuarios de la Plataforma',
                    customize: function (doc) {
                        // Cambia el color de la línea de encabezado a rojo
                        doc.styles.tableHeader.color = '#9fa1a4';
                        // Centra la tabla
                        doc.defaultStyle.alignment = 'center';
                        // Cambia el color de fondo del encabezado
                        doc.styles.tableHeader.fillColor = '#4c1922'; // Cambia a tu color preferido
                    }
                }
            ],
        });


    });






</script>

  }