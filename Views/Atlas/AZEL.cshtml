@inject IHttpContextAccessor HttpContextAccessor
@using NSIE.Models
@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json

@{
	var httpContext = HttpContextAccessor.HttpContext;
	var perfilUsuarioJson = httpContext.Session.GetString("PerfilUsuario");
	var perfilUsuario = JsonConvert.DeserializeObject<PerfilUsuario>(perfilUsuarioJson);

	ViewData["Title"] = "AZEL - El inventario y el potencial de los recursos renovables";
	ViewData["NombreUsuario"] = perfilUsuario?.Nombre;
	ViewData["RolUsuario"] = perfilUsuario?.Rol;
	ViewData["IDUsuario"] = perfilUsuario?.IdUsuario;

	var header = new HeaderViewModel
	{
		Title = "AZEL",
		IconPath = "conding.png",
		Description = "El inventario y el potencial de los recursos renovables - Esta secci√≥n del sitio se encuentra actualmente en desarrollo.",
		Section = "üß¨ SNIEr > üå± El inventario y el potencial de los recursos renovables",
		ModuleInfo = JsonConvert.SerializeObject(new
		{
			title = "AZEL",
			description = "El inventario y el potencial de los recursos renovables - La funcionalidad estar√° disponible pr√≥ximamente como parte del desarrollo del SNIEr.",
			functionality = "Esta secci√≥n alojar√° el inventario y potencial de recursos renovables a√∫n no liberado al p√∫blico.",
			stage = "En construcci√≥n",
			roles = new[] {
new { icon = "hammer", text = "Equipo de Desarrollo: M√≥dulo en implementaci√≥n" },
new { icon = "eye", text = "Consulta P√∫blica: Pronto disponible para usuarios" }
},
			order = new { step = 0, description = "Planificado en la fase inicial del sistema" },
			manualUrl = "#"
		})
	};
}

@await Html.PartialAsync("_ViewHeader", header)

<style>
  #map {
    height: 400px;
  }

  /* Estilo para el mapa */


  /* Tarjetas y secciones: bordes redondeados y sombra sutil */
  .card {
    border-radius: 0.5rem;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
  }

  /* Reporte final: contorno profesional */
  #reportContent .card {
    border: 2px solid #0d6efd;
    box-shadow: 0 0 15px rgba(13, 110, 253, 0.2);
  }

  #reportMap img {
    border: 1px solid #ddd;
    padding: 5px;
    background: #fff;
    max-width: 100%;
    border-radius: 0.5rem;
  }

  /* Overlay de carga de p√°gina (inicial) */
  #pageLoadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    z-index: 99999;
    /* M√°s alto que todo */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  /* Overlay de c√°lculo: spinner y barra de progreso */
  #loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    z-index: 9999;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  #progressBar {
    width: 80%;
    margin-top: 1rem;
  }

  /* Ayudas en los inputs */
  .input-help {
    font-size: 0.875rem;
    color: #6c757d;
  }
</style>

<!-- Overlay de carga con spinner y barra de progreso (para el reporte) -->
<!-- Overlay de carga con spinner y barra de progreso (para el reporte) -->
<div id="loadingOverlay">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Calculando...</span>
  </div>
  <div id="progressBar" class="progress mt-3">
    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;"
      id="progressBarFill">0%</div>
  </div>
</div>


<div class="container my-4">
  <h1 class="mb-4 text-center">Evaluaci√≥n de Proyecto Energ√©tico Integral</h1>
  <p class="text-center text-muted">
    Fuente para el Factor de Emisi√≥n (CRE):
    <a href="https://www.gob.mx/cms/uploads/attachment/file/895937/Aviso_FE-SEN23.pdf" target="_blank">
      0.438 kgCO‚ÇÇeq/MWh (2023)
    </a>
  </p>
  <!-- Layout: Mapa y Formulario -->
  <div class="row row-custom">
    <!-- Columna Izquierda: Mapa -->
    <div class="col-md-6 left-col">
      <h5 class="text-center">Mapa del Proyecto</h5>
      <div id="map"></div>
      <p class="mt-2 text-center">Utiliza la herramienta de dibujo para delimitar el √°rea.</p>
    </div>
    <!-- Columna Derecha: Formulario multi-paso -->
    <div class="col-md-6 right-col" id="formSection">
      <form id="multiStepForm">
        <!-- Paso 1 -->
        <div class="step_ mb-3" id="step1">
          <div class="subtitulobus mb-3">
            <div class="card-body">
              <h5 class="card-title">Paso 1: Selecci√≥n de Tecnolog√≠a y Proyecto</h5>
              <div class="row mb-3">
                <div class="col">
                  <label for="techType" class="form-label" data-bs-toggle="tooltip"
                    title="Selecciona si el proyecto es de tecnolog√≠a convencional o limpia.">
                    Tipo de Tecnolog√≠a:
                  </label>
                  <select class="form-select" id="techType" required>
                    <option value="">Seleccione...</option>
                    <option value="Convencional">Convencional</option>
                    <option value="Limpia">Limpia</option>
                  </select>
                  <div class="input-help">Elige el tipo de tecnolog√≠a para filtrar los proyectos
                    disponibles.
                  </div>
                </div>
                <div class="col">
                  <label for="projectType" class="form-label" data-bs-toggle="tooltip"
                    title="Selecciona el tipo de proyecto seg√∫n la tecnolog√≠a.">
                    Tipo de Proyecto:
                  </label>
                  <select class="form-select" id="projectType" disabled required>
                    <option value="">Seleccione...</option>
                  </select>
                  <div class="input-help">Este campo se habilitar√° al elegir el tipo de
                    tecnolog√≠a.
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-primary" id="nextStepButton1" onclick="nextStep(1)"
                disabled>Siguiente</button>
            </div>
          </div>
        </div>
        <!-- Paso 2 -->
        <div class="step_ d-none" id="step2">
          <div class="subtitulobus mb-3">
            <div class="card-body">
              <h5 class="card-title">Paso 2: Capturar el √Årea del Proyecto</h5>
              <p class="mb-2">Dibuja el √°rea en el mapa y luego presiona "Confirmar √Årea".</p>
              <p>√Årea seleccionada (km¬≤): <span id="areaValue">0 km¬≤</span></p>
              <p>Estado detectado: <span id="estadoDetectado">-</span></p>
              <p>Sistema detectado: <span id="sistemaDetectado">-</span></p>
              <p>Marginaci√≥n detectada: <span id="marginacionDetectada">-</span></p>
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" onclick="prevStep(2)">Anterior</button>
                <div>
                  <button type="button" class="btn btn-primary me-2" id="enableDrawing"
                    onclick="activarDibujo()">Activar Dibujo</button>
                  <button type="button" class="btn btn-primary me-2" id="confirmAreaBtn" onclick="confirmAreaFunction()"
                    disabled>Confirmar √Årea</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Paso 3 -->
        <div class="step_ d-none" id="step3">
          <div class=" mb-3">
            <div class="card-body">
              <h5 class="subtitulobus">Paso 3: Datos Econ√≥micos y Extras</h5>
              <div class="row mb-3">
                <div class="col">
                  <label for="capacidadInstalada" class="form-label" data-bs-toggle="tooltip"
                    title="Capacidad total instalada en MW.">
                    Capacidad Instalada (MW):
                  </label>
                  <input type="number" class="form-control" id="capacidadInstalada" placeholder="Ej. 50" step="any"
                    required>
                  <div class="input-help">Ingresa la capacidad total instalada en megavatios.
                  </div>
                </div>
                <div class="col">
                  <label for="eficienciaElectrica" class="form-label" data-bs-toggle="tooltip"
                    title="Eficiencia promedio en %.">
                    Eficiencia El√©ctrica (%) :
                  </label>
                  <input type="number" class="form-control" id="eficienciaElectrica" placeholder="Ej. 18" step="any"
                    required>
                  <div class="input-help">Valor promedio de eficiencia en porcentaje.</div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col">
                  <label for="factorPlanta" class="form-label" data-bs-toggle="tooltip"
                    title="Factor de planta en % (tiempo de operaci√≥n real vs. te√≥rico).">
                    Factor de Planta (%):
                  </label>
                  <input type="number" class="form-control" id="factorPlanta" placeholder="Ej. 30" step="any" required>
                  <div class="input-help">Representa el tiempo de operaci√≥n real comparado con el
                    te√≥rico.</div>
                </div>
                <div class="col">
                  <label for="inversionPlaneada" class="form-label" data-bs-toggle="tooltip"
                    title="Inversi√≥n total planeada en MXN.">
                    Inversi√≥n Planeada (MXN):
                  </label>
                  <input type="number" class="form-control" id="inversionPlaneada" placeholder="Ej. 50000000" step="any"
                    required>
                  <div class="input-help">Monto total que se planea invertir en el proyecto.</div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col">
                  <label for="anioInicio" class="form-label" data-bs-toggle="tooltip"
                    title="A√±o en el que se planea iniciar operaciones.">
                    A√±o de Inicio de Operaciones:
                  </label>
                  <!-- Ajusta el rango a 2010-2030 si quieres que coincida con tu tabla de marginaci√≥n -->
                  <select class="form-select" id="anioInicio" required></select>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col">
                  <label for="costoOM" class="form-label" data-bs-toggle="tooltip"
                    title="Costo anual de operaci√≥n y mantenimiento en MXN.">
                    Costo de O&M (MXN/a√±o):
                  </label>
                  <input type="number" class="form-control" id="costoOM" placeholder="Ej. 2000000" step="any" required>
                  <div class="input-help">Costo anual estimado para operaci√≥n y mantenimiento.
                  </div>
                </div>
                <div class="col">
                  <label for="distanciaRed" class="form-label" data-bs-toggle="tooltip"
                    title="Distancia en km a la red de transmisi√≥n.">
                    Distancia a Red de Transmisi√≥n (km):
                  </label>
                  <input type="number" class="form-control" id="distanciaRed" placeholder="Ej. 10" step="any" required>
                  <div class="input-help">Distancia estimada hasta la red de transmisi√≥n.</div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col">
                  <label for="precioEnergia" class="form-label" data-bs-toggle="tooltip"
                    title="Precio de la energ√≠a en MXN/MWh, asignado autom√°ticamente seg√∫n ubicaci√≥n.">
                    Precio de la Energ√≠a (MXN/MWh) (Auto):
                  </label>
                  <input type="number" class="form-control" id="precioEnergia" step="any" disabled>
                </div>
                <div class="col">
                  <label for="factorEmision" class="form-label" data-bs-toggle="tooltip"
                    title="Factor de emisi√≥n asignado autom√°ticamente (CRE 2023).">
                    Factor de Emisi√≥n (kgCO‚ÇÇeq/MWh) (Auto):
                  </label>
                  <input type="number" class="form-control" id="factorEmision" step="any" disabled>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col">
                  <label for="indiceMarginacion" class="form-label" data-bs-toggle="tooltip"
                    title="√çndice de marginaci√≥n calculado seg√∫n ubicaci√≥n.">
                    √çndice de Marginaci√≥n (Auto):
                  </label>
                  <input type="number" class="form-control" id="indiceMarginacion" step="any" disabled>
                </div>
              </div>
              <p class="text-success">Presiona "Generar Reporte Final" para ver el an√°lisis completo.
              </p>
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" onclick="prevStep(3)">Anterior</button>
                <button type="button" class="btn btn-primary" onclick="if(validateInputs()) generateReport()">Generar
                  Reporte Final</button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
    <!-- Fin de la columna derecha -->
  </div>
  <!-- Fin de la fila principal -->

  <!-- Secci√≥n de Reporte Final (inicialmente oculta) -->
  <div class="my-4 d-none" id="finalReportSection">
    <div class="">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="subtitulobus">Reporte Final</h5>
          <button type="button" class="btn btn-outline-primary" id="btnGuardarPDF">Guardar PDF</button>
        </div>
        <div id="reportContent" class="mb-3"></div>
        <!-- Secci√≥n de Caracter√≠sticas de Zona -->
        <div class="row">
          <div class="col-md-6" id="zoneCharacteristics">
            <h5>Caracter√≠sticas de la Zona</h5>
            <p><strong>Permisos cercanos:</strong> 15</p>
            <p><strong>Estado:</strong> <span id="reporteEstado">-</span></p>
            <p><strong>Municipio:</strong> <span id="reporteMunicipio">-</span></p>
            <div id="zoneDataContent"></div>
          </div>
        </div>
        <!-- Gr√°ficos -->
        <div id="chartContainerReturns" style="height: 400px; margin-top:20px;"></div>
        <div id="chartContainerMargination" style="height: 400px; margin-top:20px;"></div>
        <div id="chartContainerComparison" style="height: 400px; margin-top:20px;"></div>
        <div id="chartContainerEnergyComparison" style="height: 400px; margin-top:20px;"></div>
        <div id="chartContainerRadar" style="height: 400px; margin-top:20px;"></div>
        <!-- NUEVA Gr√°fica de Barras: Entidades Federativas -->
        <div id="chartContainerState" style="height: 400px; margin-top:20px;"></div>
        <div id="formulasCalculo" class="mt-4">
          <h5>F√≥rmulas de C√°lculo:</h5>
          <ul>
            <li><strong>Generaci√≥n Estimada (GWh/a√±o):</strong> (Capacidad Instalada √ó (Factor de
              Planta/100) √ó 8760)/1000</li>
            <li><strong>Ingresos Anuales (MXN):</strong> Generaci√≥n Estimada √ó 1000 √ó Precio de la
              Energ√≠a</li>
            <li><strong>Neto Anual (MXN):</strong> Ingresos Anuales ‚àí Costo de O&M</li>
            <li><strong>VPN (20 a√±os, MXN):</strong> (Neto Anual √ó 20) ‚àí Inversi√≥n Planeada</li>
            <li><strong>TIR (%):</strong> (Neto Anual / Inversi√≥n Planeada) √ó 100</li>
            <li><strong>Emisiones (kgCO‚ÇÇeq/a√±o):</strong> Generaci√≥n Estimada √ó 1000 √ó Factor de Emisi√≥n
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>



@section scripts {

  <script src="@Cdn.Url/Geovisualizador/zonas/RAMSAR_1.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/reasnaturalesprotegidas_2.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/Altaincidenciaciclones_3.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/Volcanesactivos_4.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/Aerodromos_5.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/Rosprincipales_6.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/Vasfrreas_7.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/ZonaslejanasalaRNT_8.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/Localidadesrurales_9.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/Localidadesurbanas_10.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/Zonamonumentosarqueolgicos_11.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/Zonamonumentoshistricos_12.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/PotencialElicoms_13.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/PotencialresiduosForestales_14.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/PotencialresiduosIndustriales_15.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/PotencialresiduosPecuarios_16.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/PotencialresiduosUrbanos_17.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/PotencialGeotrmico_18.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/GeotermiaWmC_19.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/Cuencas_Disponibilidad_2023_20.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/GerenciadeControlRegional_23.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/Municipios_24.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/Estados_25.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/subestaciones_4326_26.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/Lneasdetransmisinelctrica_27.js"></script>
  <script src="@Cdn.Url/Geovisualizador/zonas/Subestacioneselctricas_28.js"></script>
  <script src="@Cdn.Url/Geovisualizador/dist/bundle.js"></script>




  <script>
    /* ========== 1) CONFIGURACI√ìN GLOBAL DE DATOS ========== */
    const conventionalProjects = ["Combusti√≥n Interna", "Termoel√©ctrica Convencional", "Turbog√°s", "Importaci√≥n", "Ciclo Combinado", "Cogeneraci√≥n"];
    const limpiaProjects = ["E√≥lica", "Fotovoltaica", "Geot√©rmica", "Hidroel√©ctrica", "Nucleoel√©ctrica", "Bioenerg√≠a", "Carboel√©ctrica"];
    const preciosSistema = { SIN: 966.1458333, BCA: 1443.89625, BCS: 2720.725 };
    const defaultFactorEmision = 0.438;

    // Ejemplo de √≠ndice de marginaci√≥n por estado y a√±o (2010-2030) [VALORES DEMO]
    // Usa los reales que tengas en tu base de datos o JSON
    const marginacionEstados = {
      "Aguascalientes": {
        2010: 0.35, 2011: 0.37, 2012: 0.38, 2013: 0.40, 2014: 0.41, 2015: 0.42, 2016: 0.43, 2017: 0.44,
        2018: 0.45, 2019: 0.46, 2020: 0.47, 2021: 0.48, 2022: 0.49, 2023: 0.50, 2024: 0.51, 2025: 0.52,
        2026: 0.53, 2027: 0.54, 2028: 0.55, 2029: 0.56, 2030: 0.57
      },
      "Baja California": {
        2010: 0.30, 2011: 0.31, 2012: 0.31, 2013: 0.32, 2014: 0.34, 2015: 0.35, 2016: 0.35, 2017: 0.36,
        2018: 0.38, 2019: 0.40, 2020: 0.41, 2021: 0.42, 2022: 0.44, 2023: 0.45, 2024: 0.46, 2025: 0.47,
        2026: 0.48, 2027: 0.49, 2028: 0.50, 2029: 0.51, 2030: 0.52
      },
      "Baja California Sur": {
        2010: 0.45, 2011: 0.46, 2012: 0.47, 2013: 0.47, 2014: 0.48, 2015: 0.49, 2016: 0.49, 2017: 0.50,
        2018: 0.52, 2019: 0.54, 2020: 0.55, 2021: 0.56, 2022: 0.57, 2023: 0.58, 2024: 0.59, 2025: 0.60,
        2026: 0.61, 2027: 0.62, 2028: 0.63, 2029: 0.64, 2030: 0.65
      },
      "Jalisco": {
        2010: 0.60, 2011: 0.61, 2012: 0.62, 2013: 0.63, 2014: 0.63, 2015: 0.64, 2016: 0.65, 2017: 0.66,
        2018: 0.67, 2019: 0.68, 2020: 0.69, 2021: 0.70, 2022: 0.71, 2023: 0.72, 2024: 0.73, 2025: 0.74,
        2026: 0.75, 2027: 0.76, 2028: 0.77, 2029: 0.78, 2030: 0.79
      },
      "Zacatecas": {
        2010: 0.70, 2011: 0.71, 2012: 0.71, 2013: 0.72, 2014: 0.73, 2015: 0.74, 2016: 0.74, 2017: 0.75,
        2018: 0.76, 2019: 0.77, 2020: 0.78, 2021: 0.79, 2022: 0.80, 2023: 0.81, 2024: 0.82, 2025: 0.83,
        2026: 0.84, 2027: 0.85, 2028: 0.86, 2029: 0.87, 2030: 0.88
      }
      // ... y as√≠ para todos los estados
    };

    // Lista de todos los estados (keys del objeto anterior)
    const listaEstados = Object.keys(marginacionEstados);

    // L√≥gica "mock" para detectar estado por coordenadas. En producci√≥n, haz geocoding real o shapefiles.
    function detectEstadoPorCoordenadas(lat, lng) {
      // Aqu√≠ haz la l√≥gica real. Por demo, si lat < 22 => "Baja California Sur", si lat < 24 => "Baja California", etc.
      // Lo hacemos muy simplificado para ejemplo:
      if (lat > 24) return "Jalisco";
      if (lat > 22) return "Aguascalientes";
      return "Baja California Sur";
    }

    /* ========== 2) FILTRO DE PROYECTOS (Paso 1) ========== */
    const techTypeSelect = document.getElementById("techType");
    const projectTypeSelect = document.getElementById("projectType");
    const nextStepButton1 = document.getElementById("nextStepButton1");

    techTypeSelect.addEventListener("change", function () {
      projectTypeSelect.innerHTML = '<option value="">Seleccione...</option>';
      if (this.value === "Convencional") {
        conventionalProjects.forEach(proj => {
          const option = document.createElement("option");
          option.value = proj;
          option.text = proj;
          projectTypeSelect.appendChild(option);
        });
        projectTypeSelect.disabled = false;
        document.getElementById("factorEmision").value = defaultFactorEmision.toFixed(3);
      } else if (this.value === "Limpia") {
        limpiaProjects.forEach(proj => {
          const option = document.createElement("option");
          option.value = proj;
          option.text = proj;
          projectTypeSelect.appendChild(option);
        });
        projectTypeSelect.disabled = false;
        // Si es Limpia, factor de emisi√≥n ~ 0
        document.getElementById("factorEmision").value = "0.000";
      } else {
        projectTypeSelect.disabled = true;
        document.getElementById("factorEmision").value = "";
      }
      checkStep1();
    });

    projectTypeSelect.addEventListener("change", checkStep1);

    function checkStep1() {
      nextStepButton1.disabled = !(techTypeSelect.value && projectTypeSelect.value);
    }

    /* ========== 3) COMBO DE A√ëOS (2010‚Äì2030) ========== */
    (function fillYears() {
      const anioInicioSelect = document.getElementById("anioInicio");
      for (let y = 2025; y <= 2030; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.text = y;
        anioInicioSelect.appendChild(opt);
      }
    })();

    /* ========== 4) NAVEGACI√ìN MULTI-PASO ========== */
    function nextStep(currentStep) {
      document.getElementById("step" + currentStep).classList.add("d-none");
      const nextStepNum = currentStep + 1;
      document.getElementById("step" + nextStepNum).classList.remove("d-none");
      if (nextStepNum === 2) {
        alert("Captura el √°rea en el mapa usando el bot√≥n 'Activar Dibujo'.");
      }
    }
    function prevStep(currentStep) {
      document.getElementById("step" + currentStep).classList.add("d-none");
      document.getElementById("step" + (currentStep - 1)).classList.remove("d-none");
    }

    /* ========== 5) MAPA Y DIBUJO (Paso 2) ========== */
    const map = L.map('map').setView([19.4326, -99.1332], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: {
        polygon: true,
        marker: false,
        circle: false,
        rectangle: false,
        polyline: false,
        circlemarker: false
      }
    });

    function activarDibujo() {
      map.addControl(drawControl);
      document.getElementById("enableDrawing").disabled = true;
    }

    map.on('draw:created', function (e) {
      if (e.layerType === 'polygon') {
        drawnItems.clearLayers();
        drawnItems.addLayer(e.layer);
        updateAreaAndMargination();
        document.getElementById("confirmAreaBtn").disabled = false;
      }
    });
    map.on('draw:edited', function () {
      updateAreaAndMargination();
    });

    function updateAreaAndMargination() {
      const layers = drawnItems.getLayers();
      if (layers.length > 0) {
        const layer = layers[0];
        const latLngs = layer.getLatLngs()[0];
        // Calcular el √°rea en m¬≤ y convertir a km¬≤
        const area = L.GeometryUtil.geodesicArea(latLngs);
        const areaKm2 = area / 1000000;
        const areaFormatted = areaKm2.toLocaleString("es-MX", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
        document.getElementById("areaValue").innerText = areaFormatted + " km¬≤";
        layer.bindTooltip("√Årea: " + areaFormatted + " km¬≤", {
          permanent: true,
          direction: "center"
        }).openTooltip();

        // Centroid
        const centroid = getPolygonCentroid(latLngs);
        // Detectar estado (mock)
        const estadoDetectado = detectEstadoPorCoordenadas(centroid.lat, centroid.lng);
        document.getElementById("estadoDetectado").innerText = estadoDetectado;
        // Guardamos global por si lo usamos luego
        window.estadoSeleccionado = estadoDetectado;

        // Detectar sistema (mock)
        const sistema = detectSistema(centroid);
        document.getElementById("sistemaDetectado").innerText = sistema;
        document.getElementById("precioEnergia").value = preciosSistema[sistema].toFixed(6);

        // Detectar marginaci√≥n (ejemplo muy simplificado)
        let marginacionStr = "media";
        const val = (marginacionEstados[estadoDetectado] && marginacionEstados[estadoDetectado][2023]) || 0.5;
        if (val >= 0.7) marginacionStr = "muy_alta";
        else if (val >= 0.5) marginacionStr = "alta";
        document.getElementById("marginacionDetectada").innerText = marginacionStr;

        // √çndice de marginaci√≥n (por defecto, a√±o=2023)
        document.getElementById("indiceMarginacion").value = (val * 100).toFixed(1);
      }
    }

    function getPolygonCentroid(latLngs) {
      let latSum = 0, lngSum = 0;
      latLngs.forEach(ll => { latSum += ll.lat; lngSum += ll.lng; });
      return { lat: latSum / latLngs.length, lng: lngSum / latLngs.length };
    }

    function detectSistema({ lat, lng }) {
      // Ejemplo muy simplificado
      if (lat >= 27 && lat <= 32.72 && lng >= -117.5 && lng <= -114) return "BCA";
      if (lat >= 22.7 && lat <= 27 && lng >= -115 && lng <= -108) return "BCS";
      return "SIN";
    }

    function confirmAreaFunction() {
      map.removeControl(drawControl);
      document.getElementById("confirmAreaBtn").disabled = true;
      map.dragging.disable();
      map.doubleClickZoom.disable();
      map.scrollWheelZoom.disable();
      map.touchZoom.disable();
      document.getElementById("step2").classList.add("d-none");
      document.getElementById("step3").classList.remove("d-none");
    }

    /* ========== 6) VALIDACI√ìN DE INPUTS (Paso 3) ========== */
    function validateInputs() {
      let valid = true;
      const validations = [
        { id: "capacidadInstalada", min: 0.0001 },
        { id: "eficienciaElectrica", min: 0.0001, max: 100 },
        { id: "factorPlanta", min: 0.0001, max: 100 },
        { id: "inversionPlaneada", min: 0.0001 },
        { id: "precioEnergia", min: 0.0001 },
        { id: "costoOM", min: 0.0001 },
        { id: "distanciaRed", min: 0 }
      ];
      validations.forEach(item => {
        const input = document.getElementById(item.id);
        const value = parseFloat(input.value);
        if (isNaN(value) || value < item.min || (item.max !== undefined && value > item.max)) {
          valid = false;
          input.classList.add("is-invalid");
          if (!input.nextElementSibling || !input.nextElementSibling.classList.contains("invalid-feedback")) {
            const feedback = document.createElement("div");
            feedback.className = "invalid-feedback";
            feedback.innerText = "Ingrese un valor num√©rico v√°lido" +
              (item.max !== undefined ? " (entre " + item.min + " y " + item.max + ")." : " mayor que 0.");
            input.parentNode.insertBefore(feedback, input.nextSibling);
          }
        } else {
          input.classList.remove("is-invalid");
          if (input.nextElementSibling && input.nextElementSibling.classList.contains("invalid-feedback")) {
            input.nextElementSibling.remove();
          }
        }
      });
      return valid;
    }

    /* ========== 7) GENERACI√ìN DEL REPORTE FINAL ========== */
    function generateReport() {
      if (!validateInputs()) {
        alert("Por favor, revise y corrija los campos num√©ricos.");
        return;
      }
      const loadingOverlay = document.getElementById("loadingOverlay");
      const progressBarFill = document.getElementById("progressBarFill");
      loadingOverlay.style.display = "flex";
      progressBarFill.style.width = "10%";
      progressBarFill.innerText = "10%";

      // Recoger datos
      const techType = document.getElementById("techType").value;
      const projectType = document.getElementById("projectType").value;
      const areaText = document.getElementById("areaValue").innerText;
      const area = parseFloat(areaText.replace(" km¬≤", "")) || 0;
      const capacidadInstalada = parseFloat(document.getElementById("capacidadInstalada").value) || 0;
      const eficienciaElectrica = parseFloat(document.getElementById("eficienciaElectrica").value) || 0;
      const factorPlanta = parseFloat(document.getElementById("factorPlanta").value) || 0;
      const inversionPlaneada = parseFloat(document.getElementById("inversionPlaneada").value) || 0;
      const anioInicio = parseInt(document.getElementById("anioInicio").value) || 2023;
      const precioEnergia = parseFloat(document.getElementById("precioEnergia").value) || 0;
      const indiceMarginacion = parseFloat(document.getElementById("indiceMarginacion").value) || 0;
      const costoOM = parseFloat(document.getElementById("costoOM").value) || 0;
      const distanciaRed = parseFloat(document.getElementById("distanciaRed").value) || 0;
      let factorEmision = (techType === "Convencional") ? defaultFactorEmision : 0;
      document.getElementById("factorEmision").value = factorEmision.toFixed(3);

      // Estado detectado (mock)
      const estadoDetectado = window.estadoSeleccionado || "Jalisco";
      document.getElementById("reporteEstado").innerText = estadoDetectado;
      // Municipio "mock"
      document.getElementById("reporteMunicipio").innerText = "Municipio X";

      progressBarFill.style.width = "20%";
      progressBarFill.innerText = "20%";

      // C√°lculos
      const generacionEstimada = (capacidadInstalada * (factorPlanta / 100) * 8760) / 1000; // GWh/a√±o
      const ingresosAnuales = generacionEstimada * 1000 * precioEnergia;
      const netoAnual = ingresosAnuales - costoOM;
      const anosAnalisis = 20;
      const vpn = (netoAnual * anosAnalisis) - inversionPlaneada;
      const tir = (netoAnual / inversionPlaneada) * 100;
      let emisionesProyecto = 0;
      if (techType === "Convencional") {
        emisionesProyecto = generacionEstimada * 1000 * factorEmision;
      }

      progressBarFill.style.width = "30%";
      progressBarFill.innerText = "30%";

      // Decisi√≥n / razones
      let razones = [];
      if (distanciaRed > 50) {
        razones.push("La red de transmisi√≥n est√° muy lejos, lo que implica altos costos de interconexi√≥n.");
      }
      if (indiceMarginacion > 80) {
        razones.push("El √°rea tiene un alto √≠ndice de marginaci√≥n, aunque implica retos regulatorios.");
      }
      if (vpn <= 0 || tir <= 15 || generacionEstimada < 50) {
        razones.push("La rentabilidad (VPN, TIR o generaci√≥n) no es suficientemente alta.");
      }
      if (techType === "Convencional" && emisionesProyecto > 1e7) {
        razones.push("Las emisiones son muy elevadas, lo que podr√≠a dificultar la aprobaci√≥n.");
      }
      let decision = "";
      if (razones.length === 0) {
        decision = "El proyecto presenta indicadores positivos. Se recomienda avanzar con el proyecto.";
      } else {
        decision = "El proyecto tiene potencial, pero sugerimos revisar los siguientes aspectos:<ul>" +
          razones.map(r => `<li>${r}</li>`).join("") +
          "</ul>Considera estas sugerencias para optimizar el proyecto.";
      }

      progressBarFill.style.width = "40%";
      progressBarFill.innerText = "40%";

      document.getElementById("finalReportSection").classList.remove("d-none");

      // Simulamos fetch de datos hist√≥ricos
      // Reemplaza con tu fetch real, p. ej: fetch("datos.json")...
      setTimeout(() => {
        // Aqu√≠ dataHist vendr√≠a de tu JSON real
        const dataHist = []; // DEMO: sin datos
        progressBarFill.style.width = "60%";
        progressBarFill.innerText = "60%";

        // An√°lisis hist√≥rico DEMO
        let analisisHistorico = "<p>No se encontraron datos hist√≥ricos para la tecnolog√≠a seleccionada.</p>";
        let chart4DataPromedio = [0, 0, 0];

        progressBarFill.style.width = "70%";
        progressBarFill.innerText = "70%";

        // Llenar reporte
        const reportHTML = `
                                                                        <div >
                                                                          <div class="card-header text-center">
                                                                              <h4 class="bustitulobus">Reporte Integral del Proyecto</h4>
                                                                          </div>
                                                                          <div class="card-body">
                                                                            <h5 class="card-title">Resumen del Proyecto</h5>
                                                                            <p><strong>Tipo de Tecnolog√≠a:</strong> ${techType}</p>
                                                                            <p><strong>Tipo de Proyecto:</strong> ${projectType}</p>
                                                                            <p><strong>√Årea Seleccionada:</strong> ${area.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} km¬≤</p>
                                                                            <p><strong>Capacidad Instalada:</strong> ${capacidadInstalada.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MW</p>
                                                                            <p><strong>Generaci√≥n Estimada:</strong> ${generacionEstimada.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} GWh/a√±o</p>
                                                                            <p><strong>Ingresos Anuales (antes de O&M):</strong> $${ingresosAnuales.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MXN</p>
                                                                            <p><strong>Costo de O&M:</strong> $${costoOM.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MXN/a√±o</p>
                                                                            <p><strong>VPN (20 a√±os):</strong> $${vpn.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MXN</p>
                                                                            <p><strong>TIR:</strong> ${tir.toFixed(2)}%</p>
                                                                            ${techType === "Convencional"
            ? `<p><strong>Emisiones Estimadas:</strong> ${emisionesProyecto.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kgCO‚ÇÇeq/a√±o</p>`
            : `<p><strong>Beneficio Ambiental:</strong> Emisiones casi nulas.</p>`
          }
                                                                            <p><strong>√çndice de Marginaci√≥n:</strong> ${indiceMarginacion.toFixed(1)}</p>
                                                                            <p><strong>Distancia a Red de Transmisi√≥n:</strong> ${distanciaRed.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} km</p>
                                                                            <p><strong>Factor de Emisi√≥n (CRE 2023):</strong> ${factorEmision.toFixed(3)} kgCO‚ÇÇeq/MWh</p>
                                                                            <hr>
                                                                            ${analisisHistorico}
                                                                            <hr>
                                                                            <h5>Decisi√≥n de Inversi√≥n:</h5>
                                                                            <p>${decision}</p>
                                                                          </div>
                                                                        </div>
                                                                      `;
        document.getElementById("reportContent").innerHTML = reportHTML;

        // Graficamos
        progressBarFill.style.width = "80%";
        progressBarFill.innerText = "80%";

        // Ejemplos de series
        const nYears = 8;
        const returnsSIN = computeReturnsOverYears(generacionEstimada, preciosSistema.SIN, inversionPlaneada, nYears, costoOM);
        const returnsBCA = computeReturnsOverYears(generacionEstimada, preciosSistema.BCA, inversionPlaneada, nYears, costoOM);
        const returnsBCS = computeReturnsOverYears(generacionEstimada, preciosSistema.BCS, inversionPlaneada, nYears, costoOM);

        // 1) Retornos
        Highcharts.chart('chartContainerReturns', {
          chart: { type: 'line' },
          title: { text: 'Retornos Futuros Acumulados e Inversi√≥n' },
          xAxis: {
            categories: Array.from({ length: nYears + 1 }, (_, i) => i.toString()),
            title: { text: 'A√±os' }
          },
          yAxis: { title: { text: 'Retorno Acumulado (MXN)' } },
          series: [
            { name: 'Retorno SIN', data: returnsSIN },
            { name: 'Retorno BCA', data: returnsBCA },
            { name: 'Retorno BCS', data: returnsBCS }
          ]
        });

        // 2) Evoluci√≥n marginaci√≥n (mock)
        Highcharts.chart('chartContainerMargination', {
          chart: { type: 'line' },
          title: { text: `Evoluci√≥n de la Marginaci√≥n (demo)` },
          xAxis: { categories: [2010, 2015, 2020, 2025, 2030], title: { text: 'A√±o' } },
          yAxis: { title: { text: '√çndice de Marginaci√≥n' } },
          series: [{
            name: 'Marginaci√≥n - mock',
            data: [0.4, 0.45, 0.5, 0.55, 0.6] // Ejemplo
          }]
        });

        // 3) Comparaci√≥n radial (demo)
        let relArea = chart4DataPromedio[0] ? (area / chart4DataPromedio[0]) * 100 : 0;
        let relCap = chart4DataPromedio[1] ? (capacidadInstalada / chart4DataPromedio[1]) * 100 : 0;
        let relInv = chart4DataPromedio[2] ? (inversionPlaneada / chart4DataPromedio[2]) * 100 : 0;
        Highcharts.chart('chartContainerComparison', {
          chart: { polar: true, type: 'line' },
          title: { text: 'Comparaci√≥n Relativa (Propuesto vs. Promedio Hist√≥rico)' },
          pane: { size: '80%' },
          xAxis: {
            categories: ['√Årea (km¬≤)', 'Capacidad (MW)', 'Inversi√≥n (MXN)'],
            tickmarkPlacement: 'on',
            lineWidth: 0
          },
          yAxis: {
            gridLineInterpolation: 'polygon',
            lineWidth: 0,
            min: 0
          },
          series: [
            { name: 'Propuesto', data: [relArea, relCap, relInv], pointPlacement: 'on' },
            { name: 'Promedio Hist.', data: [100, 100, 100], pointPlacement: 'on' }
          ]
        });

        // 4) Comparaci√≥n Energ√©tica (demo)
        Highcharts.chart('chartContainerEnergyComparison', {
          chart: { type: 'column' },
          title: { text: 'Comparaci√≥n Energ√©tica: Convencional vs. Limpia (demo)' },
          xAxis: { categories: ['Convencional', 'Limpia'] },
          yAxis: { min: 0, title: { text: 'Generaci√≥n Bruta Total (GWh/a√±o)' } },
          series: [{
            name: 'Generaci√≥n Hist√≥rica',
            data: [50000, 30000] // Ejemplo
          }]
        });

        // 5) Radar Eficiencia/FP/TIR (demo)
        const promedioEficiencia = 20, promedioFactorPlanta = 30, promedioTIR = 18;
        Highcharts.chart('chartContainerRadar', {
          chart: { polar: true, type: 'line' },
          title: { text: 'Comparaci√≥n de Coeficientes de Desempe√±o' },
          pane: { size: '80%' },
          xAxis: {
            categories: ['Eficiencia El√©ctrica (%)', 'Factor de Planta (%)', 'TIR (%)'],
            tickmarkPlacement: 'on',
            lineWidth: 0
          },
          yAxis: {
            gridLineInterpolation: 'polygon',
            lineWidth: 0,
            min: 0
          },
          tooltip: {
            shared: true,
            pointFormatter: function () {
              return Highcharts.numberFormat(this.y, 1, ",", ".") + " %";
            }
          },
          series: [
            { name: 'Propuesta', data: [eficienciaElectrica, factorPlanta, tir], pointPlacement: 'on' },
            { name: 'Promedio Hist√≥rico', data: [promedioEficiencia, promedioFactorPlanta, promedioTIR], pointPlacement: 'on' }
          ]
        });

        // 6) Gr√°fica de Barras por Estado (usando el a√±o seleccionado del combo)
        updateChartContainerState(anioInicio, estadoDetectado);

        progressBarFill.style.width = "100%";
        progressBarFill.innerText = "100%";
        setTimeout(() => {
          loadingOverlay.style.display = "none";
          document.getElementById("finalReportSection").scrollIntoView({ behavior: "smooth" });
        }, 500);
      }, 1000);
    }

    // Funci√≥n para la gr√°fica de barras por estado y a√±o
    function updateChartContainerState(selectedYear, selectedState) {
      // Construimos las categor√≠as y datos
      const categoriesEstados = [];
      const dataEstados = [];

      listaEstados.forEach(estado => {
        categoriesEstados.push(estado);
        const val = marginacionEstados[estado][selectedYear] || 0; // si no hay valor, 0
        // Color seg√∫n umbrales
        let fillColor = val < 0.4 ? "#28a745" : (val < 0.7 ? "#ffc107" : "#dc3545");
        // Resaltar el estado seleccionado
        let borderColor = (estado === selectedState) ? "#FFD700" : "#6c757d";
        let borderWidth = (estado === selectedState) ? 3 : 1;
        dataEstados.push({
          y: val * 100,  // Lo graficamos en %
          color: fillColor,
          borderColor: borderColor,
          borderWidth: borderWidth,
          dataLabels: {
            enabled: true,
            format: '{y:.1f}%'
          }
        });
      });

      Highcharts.chart('chartContainerState', {
        chart: { type: 'column' },
        title: { text: `√çndice de Marginaci√≥n por Entidad (${selectedYear})` },
        xAxis: {
          categories: categoriesEstados,
          title: { text: 'Entidad Federativa' }
        },
        yAxis: {
          min: 0,
          max: 100,
          title: { text: '√çndice (%)' }
        },
        plotOptions: {
          column: {
            borderWidth: 2,
            dataLabels: { enabled: true, format: '{point.y:.1f}%' }
          }
        },
        series: [{
          name: '√çndice',
          data: dataEstados
        }]
      });
    }

    // Retornos a lo largo de N a√±os (para la gr√°fica de l√≠nea)
    function computeReturnsOverYears(gwhBase, price, inversion, nYears, costoOM) {
      const ingresosAnuales = gwhBase * 1000 * price;
      let data = [];
      for (let i = 0; i <= nYears; i++) {
        data.push(((ingresosAnuales - costoOM) * i) - inversion);
      }
      return data;
    }

    // Bot√≥n para guardar PDF
    document.getElementById("btnGuardarPDF").addEventListener("click", function () {
      setTimeout(() => {
        html2canvas(document.querySelector(".container")).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'mm', 'a4');
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
          pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
          pdf.save('reporte_proyecto.pdf');
        });
      }, 500);
    });
  </script>
  <script src="~/js/header_e.js"></script>
  <script src="~/js/carga_centrales_e.js"></script>
  <script src="~/js/mapayzonas.js"></script>
}
