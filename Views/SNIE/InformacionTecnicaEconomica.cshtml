@model dynamic
@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Información técnica y económica de proyectos en desarrollo y concluidos";
    var httpContext = HttpContextAccessor.HttpContext;
    var perfilUsuarioJson = httpContext.Session.GetString("PerfilUsuario");
    var perfilUsuario = JsonConvert.DeserializeObject<PerfilUsuario>(perfilUsuarioJson);
}

<div class="text-center mb-4">
    <h3 class="cp-section cp-grouping-section">
        <img src="~/img/iconos/mapa.png" alt="Mapa de Proyectos" class="iconomenu">
        @ViewData["Title"]
        <button class="btn btn-link text-info" onclick="mostrarAyudaModulo()" data-bs-toggle="tooltip"
            title="¿Qué es este módulo?">
            <i class="fas fa-question-circle fa-lg"></i>
        </button>
    </h3>
    <div class="text-muted mt-2 text-justify px-5">
        <i class="fas fa-info-circle text-primary"></i>
        <em>Visualiza y consulta la ubicación geográfica de proyectos energéticos, así como su información técnica y
            económica.</em>
    </div>
</div>

<div class="alert alert-light mb-4" role="alert">
    <nav aria-label="breadcrumb" style="padding-left:15px">
        <ol class="breadcrumb lp-5">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Inicio</a></li>
            <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
        </ol>
    </nav>
</div>

<div class="container-fluid ps-5 pe-5 mb-3">
    <div class="alert alert-info">
        <div class="row align-items-center">
            <div class="col-md-2 text-center">
                <img src="~/img/iconos/tecnica_economica.png" alt="Fundamento Legal" class="img-fluid">
            </div>
            <div class="col-md-10">
                <h5 class="alert-heading mb-2"><i class="fas fa-book-open"></i> Fundamento técnico</h5>
                <p class="mb-1 text-justify">
                    <span class="badge bg-primary">Artículo 23</span>
                    <span class="badge bg-success ms-2">Lineamientos SNIEr</span>
                </p>
                <hr>
                <p class="small text-justify">
                    El módulo permite mapear proyectos en desarrollo y concluidos, con información clave de inversión,
                    capacidad instalada, tecnología utilizada y ubicación georreferenciada.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Mapa Leaflet -->
<div class="container-fluid ps-5 pe-5">
    <div id="mapaProyectos" style="height: 600px; border: 2px solid var(--snier-primary); border-radius: 10px;"></div>
</div>

<!-- Modal Detalle -->
<div class="modal fade" id="modalDetalleProyecto" tabindex="-1" aria-labelledby="modalDetalleLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalDetalleLabel"><i class="fas fa-industry"></i> Detalles del Proyecto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Nombre:</strong> <span id="detalle-nombre"></span></p>
                <p><strong>Ubicación:</strong> <span id="detalle-ubicacion"></span></p>
                <p><strong>Tipo de Energía:</strong> <span id="detalle-energia"></span></p>
                <p><strong>Capacidad Instalada:</strong> <span id="detalle-capacidad"></span></p>
                <p><strong>Monto de Inversión:</strong> <span id="detalle-inversion"></span></p>
                <p><strong>Estado:</strong> <span id="detalle-estado"></span></p>
                <hr />
                <button class="btn btn-outline-success"><i class="fas fa-download"></i> Descargar ficha técnica</button>
            </div>
        </div>
    </div>
</div>

<!-- Gráfico resumen -->
<div class="container-fluid ps-5 pe-5 mt-5 mb-5">
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title"><i class="fas fa-chart-bar text-primary"></i> Resumen técnico-económico</h5>
            <div id="graficoProyectos" style="height: 400px;"></div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>

    <script>
        const proyectos = [
            {
                nombre: "Parque Solar Xochimilco",
                ubicacion: "CDMX",
                energia: "Fotovoltaica",
                capacidad: "100 MW",
                inversion: "$150M USD",
                estado: "En desarrollo",
                lat: 19.287, lon: -99.102
            },
            {
                nombre: "Central Eólica Oaxaca III",
                ubicacion: "Oaxaca",
                energia: "Eólica",
                capacidad: "150 MW",
                inversion: "$230M USD",
                estado: "Concluido",
                lat: 17.065, lon: -96.721
            }
        ];

        const mapa = L.map('mapaProyectos').setView([23.6345, -102.5528], 5);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(mapa);

        proyectos.forEach(p => {
            const marker = L.marker([p.lat, p.lon]).addTo(mapa);
            marker.bindPopup(`<strong>${p.nombre}</strong><br>${p.ubicacion}<br><button class='btn btn-sm btn-outline-primary mt-1' onclick='verDetalle(${JSON.stringify(p)})'>Ver más</button>`);
        });

        function verDetalle(data) {
            document.getElementById('detalle-nombre').innerText = data.nombre;
            document.getElementById('detalle-ubicacion').innerText = data.ubicacion;
            document.getElementById('detalle-energia').innerText = data.energia;
            document.getElementById('detalle-capacidad').innerText = data.capacidad;
            document.getElementById('detalle-inversion').innerText = data.inversion;
            document.getElementById('detalle-estado').innerText = data.estado;
            new bootstrap.Modal(document.getElementById('modalDetalleProyecto')).show();
        }

        Highcharts.chart('graficoProyectos', {
            chart: { type: 'column' },
            title: { text: 'Comparativo de Proyectos' },
            xAxis: {
                categories: ['Xochimilco Solar', 'Oaxaca Eólica']
            },
            yAxis: {
                min: 0,
                title: { text: 'Valores estimados' }
            },
            tooltip: {
                shared: true,
                valueSuffix: ' MW / M USD'
            },
            plotOptions: {
                column: {
                    grouping: true,
                    shadow: false,
                    borderWidth: 0
                }
            },
            series: [
                {
                    name: 'Capacidad Instalada (MW)',
                    data: [100, 150],
                    color: '#1e7e8c'
                },
                {
                    name: 'Inversión (M USD)',
                    data: [150, 230],
                    color: '#16a34a'
                }
            ]
        });

        function mostrarAyudaModulo() {
            Swal.fire({
                title: 'Información técnica y económica',
                html: `<div class='text-start'>
                            <p>Visualiza proyectos energéticos en un mapa interactivo. Haz clic en los marcadores para conocer más.</p>
                            <ul>
                                <li><i class="fas fa-map-marker-alt text-danger"></i> Marcadores por tipo de energía</li>
                                <li><i class="fas fa-file-alt text-info"></i> Fichas técnicas descargables</li>
                                <li><i class="fas fa-filter text-success"></i> Filtros por estado del proyecto (en futuras versiones)</li>
                            </ul>
                        </div>`,
                confirmButtonText: 'Cerrar',
                width: 400
            });
        }
    </script>
}
