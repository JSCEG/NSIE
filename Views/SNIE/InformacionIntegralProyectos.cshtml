@model dynamic
@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Información técnica, económica y social de proyectos en desarrollo y concluidos";
    var httpContext = HttpContextAccessor.HttpContext;
    var perfilUsuarioJson = httpContext.Session.GetString("PerfilUsuario");
    var perfilUsuario = JsonConvert.DeserializeObject<PerfilUsuario>(perfilUsuarioJson);
}

<div class="text-center mb-4">
    <h3 class="cp-section cp-grouping-section">
        <img src="~/img/iconos/mapa.png" alt="Mapa de Proyectos" class="iconomenu">
        @ViewData["Title"]
        <button class="btn btn-link text-info" onclick="mostrarAyudaModulo()" data-bs-toggle="tooltip"
            title="¿Qué es este módulo?">
            <i class="fas fa-question-circle fa-lg"></i>
        </button>
    </h3>
    <div class="text-muted mt-2 text-justify px-5">
        <i class="fas fa-info-circle text-primary"></i>
        <em>Consulta la información integral de proyectos energéticos, incluyendo indicadores sociales relevantes.</em>
    </div>
</div>

<div class="alert alert-light mb-4" role="alert">
    <nav aria-label="breadcrumb" style="padding-left:15px">
        <ol class="breadcrumb lp-5">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Inicio</a></li>
            <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
        </ol>
    </nav>
</div>

<div class="container-fluid ps-5 pe-5 mb-3">
    <div class="alert alert-info">
        <div class="row align-items-center">
            <div class="col-md-2 text-center">
                <img src="~/img/iconos/social_info.png" alt="Fundamento Social" class="img-fluid">
            </div>
            <div class="col-md-10">
                <h5 class="alert-heading mb-2"><i class="fas fa-users"></i> Fundamento integral</h5>
                <p class="mb-1 text-justify">
                    <span class="badge bg-primary">Art. 25 SNIEr</span>
                    <span class="badge bg-success ms-2">Cap. VI Reglamento de Impacto Social</span>
                </p>
                <hr>
                <p class="small text-justify">
                    Esta vista complementa la información técnica y económica con datos sociales como aceptación
                    comunitaria, beneficios directos y medidas de mitigación social.</p>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid ps-5 pe-5">
    <div id="mapaProyectos" style="height: 600px; border: 2px solid var(--snier-primary); border-radius: 10px;"></div>
</div>

<div class="modal fade" id="modalDetalleIntegral" tabindex="-1" aria-labelledby="modalDetalleLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalDetalleLabel"><i class="fas fa-info-circle"></i> Detalle integral del
                    proyecto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="tabDetalle" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-tecnico" data-bs-toggle="tab" data-bs-target="#tecnico"
                            type="button" role="tab">Técnico / Económico</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-social" data-bs-toggle="tab" data-bs-target="#social"
                            type="button" role="tab">Social</button>
                    </li>
                </ul>
                <div class="tab-content mt-3">
                    <div class="tab-pane fade show active" id="tecnico" role="tabpanel">
                        <p><strong>Nombre:</strong> <span id="detalle-nombre"></span></p>
                        <p><strong>Ubicación:</strong> <span id="detalle-ubicacion"></span></p>
                        <p><strong>Tipo de Energía:</strong> <span id="detalle-energia"></span></p>
                        <p><strong>Capacidad:</strong> <span id="detalle-capacidad"></span></p>
                        <p><strong>Inversión:</strong> <span id="detalle-inversion"></span></p>
                    </div>
                    <div class="tab-pane fade" id="social" role="tabpanel">
                        <p><strong>Aceptación comunitaria:</strong> <span id="detalle-aceptacion"></span></p>
                        <p><strong>Beneficios directos:</strong> <span id="detalle-beneficios"></span></p>
                        <p><strong>Medidas de mitigación:</strong> <span id="detalle-mitigacion"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <script>
        const proyectos = [
            {
                nombre: "Parque Solar Xochimilco",
                ubicacion: "CDMX",
                energia: "Fotovoltaica",
                capacidad: "100 MW",
                inversion: "$150M USD",
                aceptacion: "Alta",
                beneficios: "Electricidad subsidiada y empleo local",
                mitigacion: "Reforestación y capacitación comunitaria",
                lat: 19.287, lon: -99.102
            },
            {
                nombre: "Central Eólica Oaxaca III",
                ubicacion: "Oaxaca",
                energia: "Eólica",
                capacidad: "150 MW",
                inversion: "$230M USD",
                aceptacion: "Moderada",
                beneficios: "Infraestructura vial y educativa",
                mitigacion: "Consultas indígenas y fondos sociales",
                lat: 17.065, lon: -96.721
            }
        ];

        const mapa = L.map('mapaProyectos').setView([23.6345, -102.5528], 5);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(mapa);

        proyectos.forEach(p => {
            const marker = L.marker([p.lat, p.lon]).addTo(mapa);
            marker.bindPopup(`<strong>${p.nombre}</strong><br>${p.ubicacion}<br><button class='btn btn-sm btn-outline-success mt-1' onclick='verDetalle(${JSON.stringify(p)})'>Ver detalle</button>`);
        });

        function verDetalle(data) {
            document.getElementById('detalle-nombre').innerText = data.nombre;
            document.getElementById('detalle-ubicacion').innerText = data.ubicacion;
            document.getElementById('detalle-energia').innerText = data.energia;
            document.getElementById('detalle-capacidad').innerText = data.capacidad;
            document.getElementById('detalle-inversion').innerText = data.inversion;
            document.getElementById('detalle-aceptacion').innerText = data.aceptacion;
            document.getElementById('detalle-beneficios').innerText = data.beneficios;
            document.getElementById('detalle-mitigacion').innerText = data.mitigacion;
            new bootstrap.Modal(document.getElementById('modalDetalleIntegral')).show();
        }

        function mostrarAyudaModulo() {
            Swal.fire({
                title: 'Información Integral del Proyecto',
                html: `<div class='text-start'>
                            <p>Consulta datos completos del proyecto, incluyendo su impacto social.</p>
                            <ul>
                                <li><i class='fas fa-industry'></i> Información técnica y económica</li>
                                <li><i class='fas fa-users'></i> Detalles sociales y comunitarios</li>
                            </ul>
                        </div>`,
                confirmButtonText: 'Cerrar',
                width: 400
            });
        }
    </script>
}
