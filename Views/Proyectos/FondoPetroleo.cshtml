<!-- CargaInformacion.cshtml - Vista unificada estilo SIE con carga y visualizaci√≥n de series -->
@model NSIE.Models.DashboardViewModel
@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json
@using NSIE.Models
@using System.IO
@using Microsoft.AspNetCore.Hosting

@inject IHttpContextAccessor HttpContextAccessor

@{
    var httpContext = HttpContextAccessor.HttpContext;
    var perfilUsuarioJson = httpContext.Session.GetString("PerfilUsuario");
    var perfilUsuario = JsonConvert.DeserializeObject<PerfilUsuario>(perfilUsuarioJson);
    ViewData["NombreUsuario"] = perfilUsuario.Nombre;
    ViewData["RolUsuario"] = perfilUsuario.Rol;
    ViewData["IDUsuario"] = perfilUsuario.IdUsuario;
    ViewData["Title"] = "Recursos del Fondo Mexicano del Petr√≥leo";
}

<style>
    #previewContent { overflow-x: auto; }
    #previewContent canvas { max-width: 100% !important; height: auto !important; display: block; margin: auto; }
    .modal-body { overflow-x: auto; }
       /* Elegant Card Styles */
    .stat-card {
        transition: all 0.3s ease;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    .card-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .card-icon i {
        font-size: 1.5rem;
    }

    /* Elegant Gradients */
    .bg-gradient-primary {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
    }

    .bg-gradient-success {
        background: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
    }

    .bg-gradient-warning {
        background: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);
    }

    .bg-gradient-info {
        background: linear-gradient(135deg, #36b9cc 0%, #258391 100%);
    }

    /* Card Content */
    .stat-card .card-body {
        padding: 1.5rem;
    }

    .stat-card h2 {
        font-size: 2rem;
        font-weight: 600;
    }

    .stat-card .badge {
        font-size: 0.75rem;
        padding: 0.5em 0.75em;
    }

    .stat-card small {
        font-size: 0.875rem;
    }
</style>

<div class="text-center">
    <h3 class="cp-section cp-grouping-section">
        <img src="~/img/mexicoi.png" alt="Icono personalizado" class="iconomenu">@ViewData["Title"]
    </h3>
</div>

<!-- Miga de Pan -->
<nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='currentColor'/%3E%3C/svg%3E&#34;);" aria-label="breadcrumb" style="padding-left:15px">
    <ol class="breadcrumb lp-5">
        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Inicio</a></li>
        <li class="breadcrumb-item">Proyectos Estrat√©gicos</li>
        <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
    </ol>
</nav>
<br />

<div class="container">

    @{
        // Cambia el rol para simular la vista deseada
        string rolUsuario = "Comite"; // o "Sujeto"

        bool listadoPublicado = ViewData["ListadoPublicado"] != null && (bool)ViewData["ListadoPublicado"];
        string urlListadoPublicado = ViewData["UrlListado"]?.ToString() ?? "#";

        var propuestaEnviada = Context.Session.GetString("PropuestaEnviada") == "true";
        var propuestasComite = ViewData["PropuestasComite"] as IEnumerable<dynamic>;
    }


    <h2 class="fw-bold subtitulo">Propuestas para asignaci√≥n de fondos del Instituto Mexicano del Petr√≥leo</h2>
    <br>

    @if (rolUsuario == "Comite")
    {
        <div class="alert alert-primary">
            Vista del Comit√© de Decisi√≥n
        </div>

        @if (!listadoPublicado && (propuestasComite == null || !propuestasComite.Any()))
        {
            <form method="post" enctype="multipart/form-data" asp-controller="Proyectos" asp-action="SubirListado">
                <div class="mb-3">
                    <label for="archivoListado" class="form-label">Subir Listado de Necesidades</label>
                    <input type="file" name="ArchivoListado" id="archivoListado" class="form-control" accept=".pdf,.docx" />
                </div>
                <button type="submit" class="btn btn-primary">Subir</button>
            </form>
            <div class="alert alert-warning mt-3">
                ‚ö†Ô∏è A√∫n no se ha publicado un listado.
            </div>
        }
        else
        {
            <div class="alert alert-success mt-3">
            ‚úÖ El listado ha sido publicado. Los sujetos de apoyo ya pueden registrar propuestas. <br />
            <a href="@urlListadoPublicado" target="_blank" class="fw-bold text-decoration-underline">Ver documento publicado</a>

            <form method="post" asp-controller="Proyectos" asp-action="EliminarListado" class="d-inline ms-3">
                <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('¬øEst√°s seguro de que deseas eliminar el documento?')">
                    <i class="bi bi-trash3"></i> Eliminar documento
                </button>
            </form>
        </div>
        }

        @if (propuestasComite != null && propuestasComite.Any())
        {
            <hr />
            <h5 class="mt-4">üì• Propuestas enviadas por el Secretario Administrativo</h5>

            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Demanda/Propuesta</th>
                        <th>Tipo</th>
                        <th>Documentos</th>
                        <th>Acciones</th>
                        <th>Decisi√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in propuestasComite)
                    {
                        var baseUrl = Url.Content($"~/documentos/revision_secretario/{p.Carpeta}");
                        <tr>
                            <td>@p.Nombre</td>
                            <td>
                                @if (p.Tipo == "integrada")
                                {
                                    <span class="badge bg-success">Integrada</span>
                                }
                                else
                                {
                                    <span class="badge bg-info text-dark">Abierta</span>
                                }
                            </td>
                            <td>
                                <a href="@($"{baseUrl}/Demanda_Especifica.pdf")" target="_blank">Demanda</a> |
                                <a href="@($"{baseUrl}/Cuestionario.pdf")" target="_blank">Cuestionario</a> |
                                @if (p.Tipo == "integrada")
                                {
                                   <a href="@($"{baseUrl}/Propuesta_Tecnica.pdf")" target="_blank">Propuesta T√©cnica</a>
                                }
                            </td>
                            <td>
                                @if (p.Tipo == "integrada")
                                {
                                    if (p.Evaluado)
                                    {
                                        <span class="badge bg-secondary">
                                            ‚úÖ Cuestionario registrado
                                        </span>
                                    }
                                    else
                                    {
                                        <button class="btn btn-outline-primary btn-sm"
                                                data-bs-toggle="modal"
                                                data-bs-target="#modalEvaluacion"
                                                data-proyecto="@p.Nombre"
                                                data-carpeta="@p.Carpeta">
                                            Enviar Evaluaci√≥n
                                        </button>
                                    }
                                }
                                else
                                {
                                    @if (!p.ConvocatoriaAutorizada)
                                    {
                                        <form method="post" asp-controller="Proyectos" asp-action="AutorizarConvocatoria" class="d-inline">
                                            <input type="hidden" name="carpeta" value="@p.Carpeta" />
                                            <button type="submit" class="btn btn-outline-success btn-sm">
                                                <i class="bi bi-check2-circle"></i> Autorizar Convocatoria
                                            </button>
                                        </form>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">‚úÖ Convocatoria Autorizada</span>
                                    }
                                }
                            </td>
                            <td>
                                @if (p.Tipo == "integrada" && p.EsViable)
                                {
                                    @if (p.Aprobado)
                                    {
                                        <span class="badge bg-success">‚úîÔ∏è Aprobado</span>
                                        <a href="@($"{baseUrl}/Oficio_Aprobacion.pdf")" class="btn btn-outline-secondary btn-sm ms-2" target="_blank">
                                            <i class="bi bi-eye"></i> Ver Oficio
                                        </a>
                                    }
                                    else if (!string.IsNullOrEmpty(p.Observaciones))
                                    {
                                        if (!p.TieneCorreccion && !p.CorreccionEnviada && !p.Aprobado)
                                        {
                                            <span class="badge bg-danger">üìù Observaciones enviadas</span>
                                            <p class="mt-1 small">@p.Observaciones</p>
                                        }
                                        else if (p.TieneCorreccion && p.CorreccionEnviada && !p.Aprobado)
                                        {
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-success"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#modalAprobar"
                                                        data-proyecto="@p.Nombre"
                                                        data-carpeta="@p.Carpeta">
                                                    Aceptar y Subir Oficio
                                                </button>

                                                <button class="btn btn-sm btn-outline-danger"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#modalObservacion"
                                                        data-proyecto="@p.Nombre"
                                                        data-carpeta="@p.Carpeta">
                                                    Enviar Nueva Observaci√≥n
                                                </button>
                                            </div>
                                            <div class="mt-1 small text-muted">‚ö†Ô∏è Se est√° revisando la correcci√≥n enviada.</div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-success"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#modalAprobar"
                                                    data-proyecto="@p.Nombre"
                                                    data-carpeta="@p.Carpeta">
                                                Aceptar y Subir Oficio
                                            </button>

                                            <button class="btn btn-sm btn-outline-danger"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#modalObservacion"
                                                    data-proyecto="@p.Nombre"
                                                    data-carpeta="@p.Carpeta">
                                                Enviar Observaci√≥n
                                            </button>
                                        </div>
                                    }
                                }
                                else if(p.Tipo == "abierta" && p.EsViable && p.SusceptiblePresupuesto)
                                {
                                    @if (p.Aprobado)
                                    {
                                        <span class="badge bg-success">‚úîÔ∏è Aprobado</span>
                                        <a href="@($"{baseUrl}/Oficio_Aprobacion.pdf")" class="btn btn-outline-secondary btn-sm ms-2" target="_blank">
                                            <i class="bi bi-eye"></i> Ver Oficio
                                        </a>
                                    }
                                    else if (!string.IsNullOrEmpty(p.Observaciones))
                                    {
                                        if (!p.TieneCorreccion && !p.CorreccionEnviada && !p.Aprobado)
                                        {
                                            <span class="badge bg-danger">üìù Observaciones enviadas</span>
                                            <p class="mt-1 small">@p.Observaciones</p>
                                        }
                                        else if (p.TieneCorreccion && p.CorreccionEnviada && !p.Aprobado)
                                        {
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-success"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#modalAprobar"
                                                        data-proyecto="@p.Nombre"
                                                        data-carpeta="@p.Carpeta">
                                                    Aceptar y Subir Oficio
                                                </button>

                                                <button class="btn btn-sm btn-outline-danger"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#modalObservacion"
                                                        data-proyecto="@p.Nombre"
                                                        data-carpeta="@p.Carpeta">
                                                    Enviar Nueva Observaci√≥n
                                                </button>
                                            </div>
                                            <div class="mt-1 small text-muted">‚ö†Ô∏è Se est√° revisando la correcci√≥n enviada.</div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-success"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#modalAprobar"
                                                    data-proyecto="@p.Nombre"
                                                    data-carpeta="@p.Carpeta">
                                                Aceptar y Subir Oficio
                                            </button>

                                            <button class="btn btn-sm btn-outline-danger"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#modalObservacion"
                                                    data-proyecto="@p.Nombre"
                                                    data-carpeta="@p.Carpeta">
                                                Enviar Observaci√≥n
                                            </button>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <span class="badge bg-danger">A√∫n no se ha aprobado el presupuesto de la propuesta</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="alert alert-info mt-4">
                No hay propuestas del Secretario Administrativo disponibles por el momento.
            </div>
        }
    }
    else if (rolUsuario == "Sujeto")
    {
        <div class="alert alert-secondary d-flex align-items-center" role="alert">
            <i class="bi bi-person-fill me-2"></i>
            Vista del Sujeto de Apoyo
        </div>

        @if (!listadoPublicado)
        {
            <div class="alert alert-warning d-flex align-items-center" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                A√∫n no hay un listado de necesidades prioritarias publicado. Por favor, vuelve m√°s tarde.
            </div>
        }
        else if (propuestaEnviada)
        {
            <div class="alert alert-success d-flex align-items-center" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i>
                Tu propuesta fue enviada correctamente. Espera validaci√≥n por parte del Secretario Administrativo.
            </div>
        }
        else
        {
            <div class="alert alert-info" role="alert">
                <div class="d-flex">
                    <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                    <div>
                        <p class="mb-1">
                            Ya se encuentra disponible el listado de necesidades prioritarias.
                        </p>
                        <p class="mb-1">
                            Puedes consultarlo en la p√°gina oficial de la SENER: <br />
                            <a href="https://www.gob.mx/sener/es/articulos/recursos-para-desarrollo-tecnologico-e-innovacion" target="_blank" class="fw-bold text-decoration-underline">
                                www.gob.mx/sener/es/articulos/recursos-para-desarrollo-tecnologico-e-innovacion
                            </a>
                        </p>
                        <p class="mb-0">
                            O bien, puedes verlo directamente desde el sistema: <br />
                            <a href="@urlListadoPublicado" target="_blank" class="fw-bold text-decoration-underline">
                                Ver listado publicado
                            </a>
                        </p>
                    </div>
                </div>
            </div>

            <div class="mb-4 d-flex gap-3">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalLlenarFormulario">
                    <i class="bi bi-pencil-square"></i> Nueva propuesta
                </button>
                <p class="mb-1">
                    *Recuerda env√≠ar tu propuesta por correo electr√≥nico a sustentabilidad.fmp@energia.gob.mx
                </p>
            </div>
        }
        @if (propuestasComite != null && propuestasComite.Any(p => p.FueNotificadoSujeto))
        {
            <hr />
            <h5 class="mt-4">üõ† Propuestas con observaciones</h5>

            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Proyecto</th>
                        <th>Observaciones</th>
                        <th>Adjunto (si aplica)</th>
                        <th>Respuesta</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in propuestasComite.Where(p => p.FueNotificadoSujeto))
                    {
                        var baseUrl = Url.Content($"~/documentos/revision_secretario/{p.Carpeta}");
                        <tr>
                            <td>@p.Nombre</td>
                            <td class="text-wrap" style="max-width: 400px;">
                                @p.Observaciones
                            </td>
                            <td>
                                @if (p.ObservacionesArchivo)
                                {
                                    <a href="@($"{baseUrl}/Observaciones_Adjunto.pdf")" target="_blank" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-file-earmark-pdf"></i> Ver adjunto
                                    </a>
                                }
                                else
                                {
                                    <span class="text-muted">Sin archivo</span>
                                }
                            </td>
                            <td>
                                @if (p.TieneCorreccion)
                                {
                                    <span class="badge bg-success">‚úÖ Corregido</span>
                                    <a href="@($"{baseUrl}/Correccion_Propuesta.pdf")" target="_blank" class="btn btn-sm btn-outline-info ms-2">
                                        <i class="bi bi-eye"></i> Ver env√≠o
                                    </a>
                                }
                                else
                                {
                                    <form method="post" asp-controller="Proyectos" asp-action="SubirCorreccion" enctype="multipart/form-data" class="d-flex gap-2">
                                        <input type="hidden" name="carpeta" value="@p.Carpeta" />
                                        <input type="file" name="archivoCorreccion" accept=".pdf,.docx" class="form-control form-control-sm" required />
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            <i class="bi bi-upload"></i> Enviar
                                        </button>
                                    </form>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        @if (propuestasComite != null && propuestasComite.Any(p => p.ConvocatoriaNotificada))
        {
            <hr />
            <h5 class="mt-4">üìë Enviar propuesta y oficio</h5>

            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Proyecto</th>
                        <th>Estado</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in propuestasComite.Where(p => p.ConvocatoriaNotificada))
                    {
                        <tr>
                            <td>@p.Nombre</td>
                            <td>
                                @if (p.PropuestaOficioEnviada)
                                {
                                    <span class="badge bg-success">üì§ Enviado</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark">Pendiente</span>
                                }
                            </td>
                            <td>
                                @if (!p.PropuestaOficioEnviada)
                                {
                                    <form method="post" enctype="multipart/form-data" asp-controller="Proyectos" asp-action="SubirPropuestaOficio" class="d-flex flex-column gap-2">
                                        <input type="hidden" name="carpeta" value="@p.Carpeta" />
                                        
                                        <div>
                                            <label class="form-label">Oficio (PDF):</label>
                                            <input type="file" name="archivoOficio" accept=".pdf" class="form-control form-control-sm" required />
                                        </div>
                                        <div>
                                            <label class="form-label">Propuesta detallada (DOCX):</label>
                                            <input type="file" name="archivoPropuesta" accept=".docx" class="form-control form-control-sm" required />
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-sm mt-2">
                                            <i class="bi bi-upload"></i> Enviar
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <a href="~/documentos/revision_secretario/@p.Carpeta/Propuesta_Oficio.pdf" target="_blank" class="btn btn-outline-secondary btn-sm me-1">
                                        Ver oficio
                                    </a>
                                    <a href="~/documentos/revision_secretario/@p.Carpeta/Propuesta_Detalles.docx" target="_blank" class="btn btn-outline-primary btn-sm">
                                        Ver propuesta
                                    </a>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    }
    else if (rolUsuario == "Secretario")
    {
        <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="bi bi-person-badge-fill me-2"></i>
            Vista del Secretario Administrativo
        </div>

        @if (TempData["MensajeExito"] != null)
        {
            <div class="alert alert-success d-flex align-items-center mt-3">
                <i class="bi bi-check-circle-fill me-2"></i>
                @TempData["MensajeExito"]
            </div>
        }

        <form method="post" enctype="multipart/form-data" asp-controller="Proyectos" asp-action="EnviarSecretario">
            <div class="mb-3">
                <label class="form-label">Nombre del Demanda/Propuesta:</label>
                <input type="text" name="nombreProyecto" class="form-control" required />
            </div>

            <div class="mb-3">
                <label class="form-label">Demandas Espec√≠ficas (PDF):</label>
                <input type="file" name="archivoDemanda" class="form-control" accept=".pdf" required />
            </div>

            <div class="mb-3">
                <label class="form-label">Cuestionario (PDF):</label>
                <input type="file" name="archivoCuestionario" class="form-control" accept=".pdf" required />
            </div>

            <div class="mb-3">
                <label class="form-label">Tipo de Demanda:</label>
                <select class="form-select" name="tipoDemanda" id="tipoDemanda" required onchange="mostrarPropuesta(this.value)">
                    <option value="" disabled selected>Seleccione una opci√≥n</option>
                    <option value="integrada">Espec√≠fica Integrada</option>
                    <option value="abierta">Espec√≠fica Abierta</option>
                </select>
            </div>

            <div id="bloquePropuesta" style="display: none;">
                <div class="mb-3">
                    <label class="form-label">Propuesta T√©cnica (PDF):</label>
                    <input type="file" name="archivoPropuesta" class="form-control" accept=".pdf" />
                </div>
            </div>

            <button type="submit" class="btn btn-success mt-3">
                <i class="bi bi-send-check"></i> Enviar al Comit√©
            </button>
        </form>

        @if (propuestasComite != null && propuestasComite.Any(p => p.Evaluado))
        {
            <hr />
            <h5 class="mt-4">üì§ Cuestionarios Evaluados disponibles</h5>

            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Proyecto</th>
                        <th>Descargar Evaluaci√≥n</th>
                        <th>Subir Formato de Evaluaci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in propuestasComite.Where(p => p.Evaluado))
                    {
                        var baseUrl = Url.Content($"~/documentos/revision_secretario/{p.Carpeta}");
                        <tr>
                            <td>@p.Nombre</td>
                            <td>
                                <a href="@($"{baseUrl}/Cuestionario_Evaluado.pdf")" target="_blank" class="btn btn-outline-info btn-sm">
                                    <i class="bi bi-download"></i> Descargar
                                </a>
                            </td>
                            <td>
                                @if (p.FormatoListo)
                                {
                                    <span class="badge bg-success">
                                        ‚úÖ Formato enviado
                                    </span>
                                    <a href="@($"{baseUrl}/Formato_Evaluacion.pdf")" target="_blank" class="btn btn-outline-secondary btn-sm ms-2">
                                        <i class="bi bi-eye"></i> Ver
                                    </a>
                                }
                                else
                                {
                                    <form method="post" enctype="multipart/form-data" asp-controller="Proyectos" asp-action="SubirFormatoEvaluacion" class="d-flex gap-2">
                                        <input type="hidden" name="carpetaProyecto" value="@p.Carpeta" />
                                        <input type="file" name="formatoEvaluacion" accept=".pdf" class="form-control form-control-sm" required />
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="bi bi-upload"></i> Subir
                                        </button>
                                    </form>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            @if (propuestasComite != null && propuestasComite.Any(p => p.EsViable) && propuestasComite.Any(p => p.TienePropuesta))
            {
                <hr />
                <h5 class="mt-4">üì® Propuestas aprobadas para presupuesto para el env√≠o al Comit√© de Decisi√≥n</h5>

                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Proyecto</th>
                            <th>Documentos</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in propuestasComite.Where(p => p.EsViable && p.Tipo == "integrada"))
                        {
                            var baseUrl = Url.Content($"~/documentos/revision_secretario/{p.Carpeta}");
                            <tr>
                                <td>@p.Nombre</td>
                                <td>
                                    <a href="@($"{baseUrl}/Demanda_Especifica.pdf")" target="_blank" class="btn btn-sm btn-outline-primary me-1">Demanda</a>
                                    @if (p.Tipo == "integrada")
                                    {
                                        <a href="@($"{baseUrl}/Propuesta_Tecnica.pdf")" target="_blank" class="btn btn-sm btn-outline-secondary me-1">Propuesta</a>
                                    }
                                    <a href="@($"{baseUrl}/Formato_Evaluacion.pdf")" target="_blank" class="btn btn-sm btn-outline-success">Formato Evaluaci√≥n</a>
                                </td>
                                <td>
                                    @if (p.FueEnviado)
                                    {
                                        <span class="badge bg-info">üì§ Enviado</span>
                                    }
                                    else
                                    {
                                        <form method="post" asp-controller="Proyectos" asp-action="EnviarAFinanciamiento" class="d-inline">
                                            <input type="hidden" name="carpeta" value="@p.Carpeta" />
                                            <button type="submit" class="btn btn-success btn-sm">
                                                <i class="bi bi-send"></i> Enviar a Comit√©
                                            </button>
                                        </form>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            @* Propuestas abiertas *@
            @if (propuestasComite != null && propuestasComite.Any(p => p.ConvocatoriaAutorizada))
            {
                <hr />
                <h5 class="mt-4">üì¢ Convocatorias autorizadas por el Comit√©</h5>

                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Proyecto</th>
                            <th>Estado</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in propuestasComite.Where(p => p.ConvocatoriaAutorizada))
                        {
                            <tr>
                                <td>@p.Nombre</td>
                                <td>
                                    @if (p.ConvocatoriaNotificada)
                                    {
                                        <span class="badge bg-success">üì§ Notificado</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark">Pendiente de notificar</span>
                                    }
                                </td>
                                <td>
                                    @if (!p.ConvocatoriaNotificada)
                                    {
                                        <form method="post" asp-controller="Proyectos" asp-action="NotificarSujetoConvocatoria" class="d-inline">
                                            <input type="hidden" name="carpeta" value="@p.Carpeta" />
                                            <button type="submit" class="btn btn-warning btn-sm">
                                                <i class="bi bi-envelope-exclamation"></i> Notificar Sujeto
                                            </button>
                                        </form>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Ya notificado</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            @if (propuestasComite != null && propuestasComite.Any(p =>
                p.ConvocatoriaNotificada &&
                p.PropuestaOficioEnviada))
            {
                <hr />
                <h5 class="mt-4">üìÇ Propuestas y oficios recibidos de los Sujetos</h5>

                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Proyecto</th>
                            <th>Documentos recibidos</th>
                            <th>Formato de Evaluaci√≥n</th>
                            <th>Enviar al Comit√© de Decisi√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in propuestasComite.Where(p =>
                            p.ConvocatoriaNotificada &&
                            p.PropuestaOficioEnviada))
                        {
                            var baseUrl = Url.Content($"~/documentos/revision_secretario/{p.Carpeta}");
                            <tr>
                                <td>@p.Nombre</td>
                                <td>
                                    <a href="@($"{baseUrl}/Propuesta_Oficio.pdf")" target="_blank" class="btn btn-outline-primary btn-sm">Oficio (PDF)</a>
                                    <a href="@($"{baseUrl}/Propuesta_Detalles.docx")" target="_blank" class="btn btn-outline-secondary btn-sm ms-1">Propuesta (DOCX)</a>
                                </td>
                                <td>
                                    @if (p.FormatoEvaluacionSubido)
                                    {
                                        <span class="badge bg-success">‚úÖ Subido</span>
                                        <a href="@($"{baseUrl}/Formato_Evaluacion.pdf")" target="_blank" class="btn btn-outline-info btn-sm ms-1">Ver</a>
                                    }
                                    else
                                    {
                                        <form method="post" enctype="multipart/form-data" asp-controller="Proyectos" asp-action="SubirFormatoEvaluacionSujeto" class="d-flex gap-2">
                                            <input type="hidden" name="carpetaProyecto" value="@p.Carpeta" />
                                            <input type="file" name="formatoEvaluacion" accept=".pdf" class="form-control form-control-sm" required />
                                            <button type="submit" class="btn btn-success btn-sm">
                                                <i class="bi bi-upload"></i> Subir
                                            </button>
                                        </form>
                                    }
                                </td>
                                <td>
                                    @if (p.EnviadoComite)
                                    {
                                        <span class="badge bg-primary">üì§ Enviado</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Suba primero el formato</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            @if (propuestasComite != null && propuestasComite.Any(p => p.EsViable))
            {
                <hr />
                <h5 class="mt-4">üí∞ Proyectos viables para marcar como susceptibles a presupuesto</h5>

                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Proyecto</th>
                            <th>Estado</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in propuestasComite.Where(p => p.EsViable && p.Tipo == "abierta"))
                        {
                            <tr>
                                <td>@p.Nombre</td>
                                <td>
                                    @if (p.SusceptiblePresupuesto)
                                    {
                                        <span class="badge bg-success">‚úÖ Susceptible</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark">Pendiente</span>
                                    }
                                </td>
                                <td>
                                    @if (!p.SusceptiblePresupuesto)
                                    {
                                        <form method="post" asp-controller="Proyectos" asp-action="MarcarSusceptiblePresupuesto">
                                            <input type="hidden" name="carpeta" value="@p.Carpeta" />
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                <i class="bi bi-cash-stack"></i> Marcar como Susceptible
                                            </button>
                                        </form>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Ya marcado</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            @* Propuestas con observaciones *@

            @if (propuestasComite != null && propuestasComite.Any(p => !string.IsNullOrEmpty(p.Observaciones)))
            {
                <hr />
                <h5 class="mt-4">üìù Propuestas con observaciones del Comit√©</h5>

                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Proyecto</th>
                            <th>Observaciones</th>
                            <th>Documentos</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in propuestasComite.Where(p => !string.IsNullOrEmpty(p.Observaciones)))
                        {
                            var baseUrl = Url.Content($"~/documentos/revision_secretario/{p.Carpeta}");
                            <tr>
                                <td>@p.Nombre</td>
                                <td class="text-wrap" style="max-width: 400px;">
                                    @p.Observaciones
                                </td>
                                <td>
                                    <a href="@($"{baseUrl}/Demanda_Especifica.pdf")" target="_blank" class="btn btn-sm btn-outline-primary me-1">Demanda</a>
                                    @if (p.Tipo == "integrada")
                                    {
                                        <a href="@($"{baseUrl}/Propuesta_Tecnica.pdf")" target="_blank" class="btn btn-sm btn-outline-secondary me-1">Propuesta</a>
                                    }
                                </td>
                                <td>
                                    @if (p.FueNotificadoSujeto)
                                    {
                                        <span class="badge bg-info">üì§ Notificado</span>
                                        @if (p.ObservacionesArchivo)
                                        {
                                            <div class="mt-2">
                                                <a href="~/documentos/revision_secretario/@p.Carpeta/Observaciones_Adjunto.pdf"
                                                target="_blank"
                                                class="btn btn-sm btn-outline-secondary">
                                                    <i class="bi bi-file-earmark-pdf"></i> Ver archivo adjunto
                                                </a>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <form method="post" asp-controller="Proyectos" asp-action="NotificarSujetoObservaciones">
                                            <input type="hidden" name="carpeta" value="@p.Carpeta" />
                                            <button type="submit" class="btn btn-warning btn-sm">
                                                <i class="bi bi-envelope-exclamation"></i> Notificar Sujeto
                                            </button>
                                        </form>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            @if (propuestasComite != null && propuestasComite.Any(p => p.TieneCorreccion && !p.CorreccionEnviada))
            {
                <hr />
                <h5 class="mt-4">‚ôªÔ∏è Correcciones de propuestas por reenviar al Comit√©</h5>

                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Proyecto</th>
                            <th>Correcci√≥n enviada por el Sujeto</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in propuestasComite.Where(p => p.TieneCorreccion && !p.CorreccionEnviada))
                        {
                            var baseUrl = Url.Content($"~/documentos/revision_secretario/{p.Carpeta}");
                            <tr>
                                <td>@p.Nombre</td>
                                <td>
                                    <a href="@($"{baseUrl}/Correccion_Propuesta.pdf")" target="_blank" class="btn btn-outline-info btn-sm">
                                        <i class="bi bi-download"></i> Ver correcci√≥n
                                    </a>
                                </td>
                                <td>
                                    <form method="post" asp-controller="Proyectos" asp-action="ReenviarCorreccionComite">
                                        <input type="hidden" name="carpeta" value="@p.Carpeta" />
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="bi bi-send-check"></i> Enviar al Comit√©
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        }

        <script>
            function mostrarPropuesta(tipo) {
                const bloque = document.getElementById('bloquePropuesta');
                bloque.style.display = tipo === "integrada" ? "block" : "none";
            }
        </script>
    }
    else if (rolUsuario == "Evaluacion")
    {
        <div class="alert alert-info d-flex align-items-center">
            <i class="bi bi-people-fill me-2"></i>
            Vista del Comit√© de Evaluaci√≥n
        </div>

        var propuestasEval = ViewData["PropuestasEvaluacion"] as List<dynamic>;

        @if (propuestasEval != null && propuestasEval.Any())
        {
            <h5 class="mt-4">üìã Proyectos para evaluaci√≥n de presupuesto</h5>

            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Proyecto</th>
                        <th>Documentos</th>
                        <th>Evaluaci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in propuestasEval)
                    {
                        var urlBase = Url.Content($"~/documentos/revision_secretario/{p.Carpeta}");
                        <tr>
                            <td>@p.Nombre</td>
                            <td>
                                <a href="@($"{urlBase}/Demanda_Especifica.pdf")" target="_blank" class="btn btn-outline-primary btn-sm">
                                    Demanda
                                </a>
                                @if (p.TienePropuesta)
                                {
                                    <a href="@($"{urlBase}/Propuesta_Tecnica.pdf")" target="_blank" class="btn btn-outline-secondary btn-sm ms-1">
                                        Propuesta
                                    </a>
                                }
                                <a href="@($"{urlBase}/Formato_Evaluacion.pdf")" target="_blank" class="btn btn-outline-success btn-sm ms-1">
                                    Formato Evaluaci√≥n
                                </a>
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(p.EstadoEvaluacion))
                                {
                                    <div class="alert alert-@(p.EstadoEvaluacion.Contains("VIABLE") ? "success" : "danger") p-2 mb-2">
                                        <i class="bi bi-check2-circle me-1"></i> @p.EstadoEvaluacion
                                    </div>
                                }
                                else if (!string.IsNullOrEmpty(p.EstadoEvaluacionAbierta))
                                {
                                    <div class="alert alert-@(p.EstadoEvaluacionAbierta.Contains("VIABLE") ? "success" : "danger") p-2 mb-2">
                                        <i class="bi bi-check2-circle me-1"></i> @p.EstadoEvaluacionAbierta
                                    </div>
                                }
                                else
                                {
                                    <form method="post" asp-controller="Proyectos" asp-action="EvaluarViabilidad" class="d-flex gap-2">
                                        <input type="hidden" name="carpeta" value="@p.Carpeta" />
                                        <button name="decision" value="viable" class="btn btn-success btn-sm">
                                            ‚úÖ Viable
                                        </button>
                                        <button name="decision" value="no_viable" class="btn btn-danger btn-sm">
                                            ‚ùå No viable
                                        </button>
                                    </form>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="alert alert-warning mt-4">
                No hay proyectos listos para evaluaci√≥n de presupuesto.
            </div>
        }
    }
    <br>
    <h2 class="fw-bold subtitulo">Proyectos aprobados para asignaci√≥n de fondos del Instituto Mexicano del Petr√≥leo</h2>
    <div class="table-responsive mt-4">
        <table id="tablaProyectos" class="table table-striped table-hover" style="width:100%">
            <thead class="table-dark">
                <tr>
                    <th>Nombre del Proyecto</th>
                    <th>Inicio</th>
                    <th>Fin</th>
                    <th>Progreso</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="cuerpoTablaProyectos">
                <!-- Se llenar√° din√°micamente -->
            </tbody>
        </table>
    </div>

    <br><br>
    <h2 class="fw-bold   subtitulo ">Infraestructura del Fondo Mexicano del Petr√≥leo</h2>

    @* SECCI√ìN DE MAPA *@

    <section class="py-5 bg-white">
        <div class="container" data-aos="fade-up">
            <h2 class="fw-bold text-center mb-4">Trazabilidad Geoespacial</h2>
            <div id="map" class="rounded shadow-sm" style="height: 500px;"></div>
        </div>
    </section>

    <h2 class="fw-bold   subtitulo ">Cronograma de Recursos del Fondo Mexicano del Petr√≥leo</h2>
    <br>

    @* SECCI√ìN DE SEMAFORO Y GANTT *@
    <section id="semaforo_proyectos" class="container mb-4">
        <div class="row">
            <!-- Sem√°foro -->
            <div class="col-md-3 d-flex flex-column justify-content-between" style="min-height: 100%;">
                <!-- Tarjeta 1 -->
                    <!-- Prototipo con datos simulados -->
                    <div class="card stat-card bg-gradient-success border-0 mb-1">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="badge rounded-pill bg-white bg-opacity-25" id="porcentaje-terminados">0%</span>
                                <div class="card-icon bg-white bg-opacity-25">
                                    <i class="bi bi-check-circle-fill fs-4 text-white"></i>
                                </div>
                            </div>
                            <h2 class="mb-0 text-white" id="proyectos-terminados">0</h2>
                            <p class="card-title h6 text-white-50">Proyectos Terminados</p>
                        </div>
                    </div>

                    <div class="card stat-card bg-gradient-warning border-0 mb-1">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="badge rounded-pill bg-white bg-opacity-25" id="porcentaje-en-curso">0%</span>
                                <div class="card-icon bg-white bg-opacity-25">
                                    <i class="bi bi-clock-fill fs-4 text-dark"></i>
                                </div>
                            </div>
                            <h2 class="mb-0 text-dark" id="proyectos-en-curso">0</h2>
                            <p class="card-title h6 text-dark">Proyectos en Curso</p>
                        </div>
                    </div>

                    <div class="card stat-card bg-danger border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="badge rounded-pill bg-white bg-opacity-25" id="porcentaje-cancelados">0%</span>
                                <div class="card-icon bg-white bg-opacity-25">
                                    <i class="bi bi-x-circle-fill fs-4 text-white"></i>
                                </div>
                            </div>
                            <h2 class="mb-0 text-white" id="proyectos-cancelados">0</h2>
                            <p class="card-title h6 text-white-50">Proyectos Cancelados</p>
                        </div>
                    </div>
            </div>

            <!-- Gr√°fica Gantt con Highcharts -->
            <div class="col-md-9">
                <div class="app-card app-card-chart shadow-sm" style="min-height: 100%;">
                    <div class="app-card-header p-3 border-0">
                        <h4 class="app-card-title">Cronograma de Proyectos (Gantt)</h4>
                    </div>
                    <div class="app-card-body p-4">
                        <div id="gantt-chart" style="height: 500px; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal -->
    <div class="modal fade" id="modalProyecto" tabindex="-1" aria-labelledby="modalProyectoLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-xl-custom">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalProyectoLabel">Detalle del Proyecto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Nombre:</strong> <span id="modalNombre"></span></p>
                    <p><strong>Solicitante:</strong> <span id="modalSolicitante"></span></p>
                    <p><strong>Instituci√≥n:</strong> <span id="modalInstitucion"></span></p>
                    <p><strong>Responsable:</strong> <span id="modalResponsable"></span></p>
                    <p><strong>Tipo de Demanda:</strong> <span id="modalTipoDemanda"></span></p>
                    <p><strong>Descripci√≥n:</strong> <span id="modalDescripcion"></span></p>
                    <p><strong>Fecha de Inicio:</strong> <span id="modalInicio"></span></p>
                    <p><strong>Fecha Final:</strong> <span id="modalFin"></span></p>
                    <p><strong>Progreso:</strong> <span id="modalProgreso"></span>%</p>

                    <hr>
                    <h6>L√≠nea del tiempo del proyecto</h6>
                    <div class="pb-3">
                        <button id="zoomIn" class="btn btn-primary btn-sm">Zoom In</button>
                        <button id="zoomOut" class="btn btn-primary btn-sm">Zoom Out</button>
                    </div>
                    <div id="timeline" style="border: 1px solid #ddd;"></div>
                </div>
            </div>
        </div>
    </div>
    <style>
        .modal-xl-custom {
            max-width: 95%;
        }
        .modal-body {
            max-height: 200vh;
            overflow-y: auto;
        }
    </style>

    <!-- Modal para enviar evaluaci√≥n -->
    <div class="modal fade" id="modalEvaluacion" tabindex="-1" aria-labelledby="modalEvaluacionLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" enctype="multipart/form-data" asp-controller="Proyectos" asp-action="EnviarEvaluacion">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEvaluacionLabel">Enviar Cuestionario Evaluado</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="carpetaProyecto" id="carpetaProyecto" />
                        <div class="mb-3">
                            <label for="cuestionarioEvaluado" class="form-label">Subir Cuestionario Evaluado (PDF):</label>
                            <input type="file" class="form-control" name="cuestionarioEvaluado" accept=".pdf" required />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Enviar al Comit√©</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Llenar Formulario -->
    <div class="modal fade" id="modalLlenarFormulario" tabindex="-1" aria-labelledby="modalLlenarFormularioLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registro de Demanda Espec√≠fica</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="formNuevoProyecto" method="post" enctype="multipart/form-data" asp-controller="Proyectos" asp-action="EnviarPropuesta">
                        <!-- üßë Datos del Solicitante -->
                        <h5 class="mt-3">Datos del Solicitante</h5>

                        <div class="mb-3">
                            <label for="nombreSolicitante" class="form-label">Nombre del Solicitante:</label>
                            <input type="text" class="form-control" id="nombreSolicitante" name="nombreSolicitante" required>
                        </div>

                        <div class="mb-3">
                            <label for="institucion" class="form-label">Instituci√≥n:</label>
                            <input type="text" class="form-control" id="institucion" name="institucion" required>
                        </div>

                        <div class="mb-3">
                            <label for="responsable" class="form-label">Responsable T√©cnico del Proyecto:</label>
                            <input type="text" class="form-control" id="responsable" name="responsable" required>
                        </div>

                        <div class="mb-3">
                            <label for="correo" class="form-label">Correo de contacto:</label>
                            <input type="email" class="form-control" id="correo" name="correo" required>
                        </div>

                        <!-- üìÑ Datos del Proyecto -->
                        <h5 class="mt-4">Datos del Proyecto</h5>

                        <div class="mb-3">
                            <label for="nombreProyecto" class="form-label">Nombre del Proyecto:</label>
                            <input type="text" class="form-control" id="nombreProyecto" name="nombreProyecto" required>
                        </div>

                        <div class="mb-3">
                            <label for="tipoDemanda" class="form-label">Tipo de Demanda:</label>
                            <select class="form-select" id="tipoDemanda" name="tipoDemanda" required>
                                <option value="" disabled selected>Seleccione una opci√≥n</option>
                                <option value="integrada">Integrada</option>
                                <option value="abierta">Abierta</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Descripci√≥n general del Proyecto:</label>
                            <textarea class="form-control" id="descripcion" name="descripcion" rows="3" required></textarea>
                        </div>

                        <!-- üìé Archivos Requeridos -->
                        <h5 class="mt-4">Carga de Anexos Obligatorios</h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Anexo 1 - Demanda Espec√≠fica (PDF firmado)</label>
                                <input type="file" class="form-control" name="anexo1_pdf" accept=".pdf" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Anexo 1 - Demanda Espec√≠fica (Editable .doc/.docx)</label>
                                <input type="file" class="form-control" name="anexo1_editable" accept=".doc,.docx" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Anexo 2 - Propuesta T√©cnica (PDF firmado)</label>
                                <input type="file" class="form-control" name="anexo2_pdf" accept=".pdf" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Anexo 2 - Propuesta T√©cnica (Editable .doc/.docx)</label>
                                <input type="file" class="form-control" name="anexo2_editable" accept=".doc,.docx" required>
                            </div>
                        </div>

                        <!-- ‚úÖ Bot√≥n Final -->
                        <div class="text-end mt-4">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-send"></i> Enviar Propuesta
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Aprobar una propuesta -->
    <div class="modal fade" id="modalAprobar" tabindex="-1" aria-labelledby="modalAprobarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            <form method="post" enctype="multipart/form-data" asp-controller="Proyectos" asp-action="AprobarProyecto">
                <div class="modal-header">
                <h5 class="modal-title">Subir Oficio de Aprobaci√≥n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                <input type="hidden" name="carpeta" id="aprobacionCarpeta" />
                <div class="mb-3">
                    <label class="form-label">Selecciona el oficio en PDF:</label>
                    <input type="file" name="oficio" class="form-control" accept=".pdf" required />
                </div>
                </div>
                <div class="modal-footer">
                <button type="submit" class="btn btn-success">Subir Oficio</button>
                </div>
            </form>
            </div>
        </div>
    </div>

    <!-- Modal: Rechazar propuesta (con observaciones) -->
    <div class="modal fade" id="modalObservacion" tabindex="-1" aria-labelledby="modalObservacionLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" enctype="multipart/form-data" asp-controller="Proyectos" asp-action="EnviarObservacion">
                    <div class="modal-header">
                        <h5 class="modal-title">Enviar Observaciones</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="carpeta" id="obsCarpeta" />

                        <div class="mb-3">
                            <label class="form-label">Observaciones escritas:</label>
                            <textarea name="observaciones" class="form-control" rows="4" placeholder="Escribe aqu√≠ las observaciones si lo deseas..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Adjuntar documento (opcional):</label>
                            <input type="file" name="oficio" class="form-control" accept=".pdf" />
                        </div>

                        <div class="alert alert-secondary small">
                            Puedes llenar solo el campo de observaciones o solo adjuntar el documento, o ambos. Al menos uno es requerido.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-danger">Enviar Observaci√≥n</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        #fullscreen-search-container {
            background-color: white;
        }

        #fullscreen-elements {
            display: flex;
            flex-direction: column;
            height: auto; /* Valor inicial para cuando no est√© en pantalla completa */
        }

        #fullscreen-last-update,
        #fullscreen-select,
        #fullscreen-search-container {
            flex-shrink: 0;
        }

        #map {
            flex-grow: 1;
        }

        #main-container.fullscreen-active #fullscreen-elements {
            height: 100vh;
        }

        #main-container.fullscreen-active #map {
            height: calc(100vh - 60px);
        }

        #main-container:not(.fullscreen-active) #map {
            height: 500px;
        }
    </style>

</div>

@section Scripts {

    <!-- Bootstrap JS + Popper.js desde CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    @* BOTONES FORMULARIO *@
    <!-- MODAL -->
    <script>
        var modalEvaluacion = document.getElementById('modalEvaluacion');
        modalEvaluacion.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var carpeta = button.getAttribute('data-carpeta');
            document.getElementById('carpetaProyecto').value = carpeta;
        });
    </script>

    <script>
        var modalAprobar = document.getElementById('modalAprobar');
        modalAprobar.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var carpeta = button.getAttribute('data-carpeta');
            document.getElementById('aprobacionCarpeta').value = carpeta;
        });

        var modalObs = document.getElementById('modalObservacion');
        modalObs.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var carpeta = button.getAttribute('data-carpeta');
            document.getElementById('obsCarpeta').value = carpeta;
        });
    </script>

    <!-- PROYECTOS -->
    <script>
        const proyectos = []; 
        
        function agregarProyecto() {
            const nombre = document.getElementById("nombreProyecto").value;
            const inicio = document.getElementById("fechaInicio").value;
            const fin = document.getElementById("fechaFinal").value;
            const progreso = 0;
            const dependencias = document.getElementById("responsable").value || null;

            const nuevoProyecto = {
                id: (proyectos.length + 1).toString(), // Generar ID √∫nica b√°sica
                name: nombre,
                inicio: inicio,
                fin: fin,
                progreso: progreso,
                dependencias: dependencias
            };

            proyectos.push(nuevoProyecto);
            console.log("Proyecto actualizado: ", proyectos);
            actualizarGantt(); // Llama a la funci√≥n para refrescar el gr√°fico
            actualizarSemaforo(proyectos);
            renderizarTablaProyectos(proyectos);
        }

        function actualizarGantt() {
            Highcharts.ganttChart('gantt-chart', {
                title: { text: '' },
                tooltip: {
                    pointFormat: '<b>{point.name}</b><br>Inicio: {point.start:%e de %B}<br>Fin: {point.end:%e de %B}'
                },
                xAxis: {
                    currentDateIndicator: true,
                    min: Date.UTC(2025, 4, 1),
                    max: Date.UTC(2025, 5, 30),
                    tickInterval: 7 * 24 * 3600 * 1000,
                    labels: {
                        formatter: function () {
                            const weekNumber = Highcharts.dateFormat('%W', this.value);
                            return 'Semana ' + weekNumber;
                        }
                    }
                },
                plotOptions: {
                    series: {
                        point: {
                            events: {
                                click: function () {
                                    console.log("Detalle en click: ", this);
                                    document.getElementById("modalNombre").textContent = this.name;
                                    document.getElementById("modalInicio").textContent = Highcharts.dateFormat('%e %B %Y', this.start);
                                    document.getElementById("modalFin").textContent = Highcharts.dateFormat('%e %B %Y', this.end);
                                    document.getElementById("modalProgreso").textContent = Math.round(this.completed.amount * 100);

                                    // Esperamos al modal para luego inicializar la l√≠nea del tiempo
                                    setTimeout(() => {
                                        const container = document.getElementById('timeline');
                                        container.innerHTML = ''; // limpiar por si ya se abri√≥ antes

                                        // Simular datos
                                        const items = new vis.DataSet([
                                            {
                                                id: 1,
                                                content: '<div style="width: 150px;">Propuestas de Necesidades<br>#1234<br><small>01/05/2025</small><br><a class="btn btn-primary btn-sm" onclick="event.stopPropagation(); window.open(\'https://ejemplo.com/1\', \'_blank\'); return false;">Ver detalle</a></div>',
                                                start: '2025-04-01',
                                            },
                                            {
                                                id: 2,
                                                content: '<div style="width: 150px;">Demandas Espec√≠ficas<br>#5678<br><small>10/05/2025</small><br><a class="btn btn-primary btn-sm" onclick="event.stopPropagation(); window.open(\'https://ejemplo.com/2\', \'_blank\'); return false;">Ver detalle</a></div>',
                                                start: '2025-05-10',
                                            },
                                            {
                                                id: 3,
                                                content: '<div style="width: 150px;">Finiquito<br>#9101<br><small>20/06/2025</small><br><a class="btn btn-primary btn-sm" onclick="event.stopPropagation(); window.open(\'https://ejemplo.com/3\', \'_blank\'); return false;">Ver detalle</a></div>',
                                                start: '2025-06-20',
                                            }
                                        ]);

                                        const today = new Date();
                                        const options = {
                                            editable: false,
                                            height: '300px',
                                            maxHeight: '300px',
                                            stack: true,
                                            margin: { item: 20 },
                                            horizontalScroll: true,
                                            start: '2024-01-01',
                                            end: today,
                                            zoomMin: 100000000,
                                            zoomMax: 100000000000,
                                            zoomKey: 'ctrlKey',
                                        };

                                        const timeline = new vis.Timeline(container, items, options);

                                        document.getElementById('zoomIn').onclick = function () {
                                            const range = timeline.getWindow();
                                            const interval = range.end - range.start;
                                            timeline.setWindow({
                                                start: range.start.valueOf(),
                                                end: range.start.valueOf() + interval * 0.8,
                                            });
                                        };

                                        document.getElementById('zoomOut').onclick = function () {
                                            const range = timeline.getWindow();
                                            const interval = range.end - range.start;
                                            timeline.setWindow({
                                                start: range.start.valueOf(),
                                                end: range.start.valueOf() + interval * 1.25,
                                            });
                                        };
                                    }, 100); // Peque√±a espera para asegurar que el modal est√° en DOM

                                    // Mostrar modal
                                    const modal = new bootstrap.Modal(document.getElementById('modalProyecto'));
                                    modal.show();
                                }
                            }
                        }
                    }
                },
                series: [{
                    name: 'Proyecto',
                    data: proyectos.map(p => ({
                        id: p.id,
                        name: p.name,
                        start: Date.UTC(
                            new Date(p.inicio).getFullYear(),
                            new Date(p.inicio).getMonth(),
                            new Date(p.inicio).getDate() + 2
                        ),
                        end: Date.UTC(
                            new Date(p.fin).getFullYear(),
                            new Date(p.fin).getMonth(),
                            new Date(p.fin).getDate() + 2
                        ),
                        completed: { amount: p.progreso },
                        dependency: p.dependencias
                    }))
                }]
            });
        }
    </script>

    <script>
        document.getElementById('formSubirFormulario').addEventListener('submit', function (e) {
            e.preventDefault();
            alert('Archivo subido (simulado).');
            var modal = bootstrap.Modal.getInstance(document.getElementById('modalSubirFormulario'));
            modal.hide();
        });

        function renderizarTablaProyectos(proyectos) {
            const cuerpo = document.getElementById('cuerpoTablaProyectos');
            cuerpo.innerHTML = '';

            proyectos.forEach(proyecto => {
                const estado = proyecto.progreso === 1
                    ? `<span class="badge bg-success">Terminado</span>`
                    : `<span class="badge bg-warning text-dark">En Curso</span>`;

                const progreso = `${Math.round(proyecto.progreso * 100)}%`;

                const fila = `
                    <tr>
                        <td>${proyecto.name}</td>
                        <td>${proyecto.inicio}</td>
                        <td>${proyecto.fin}</td>
                        <td>${progreso}</td>
                        <td>${estado}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-info" onclick="verDetalle('${proyecto.id}')" title="Ver Detalle">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="cancelarProyecto('${proyecto.id}')" title="Cancelar">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                cuerpo.insertAdjacentHTML('beforeend', fila);
            });
        }

        function verDetalle(id) {
            const proyecto = proyectos.find(p => p.id === id);
            if (!proyecto) return;

            // Establecer datos b√°sicos en el modal
            document.getElementById("modalNombre").textContent = proyecto.name;
            document.getElementById("modalInicio").textContent = Highcharts.dateFormat('%e %B %Y', parseFechaISO(proyecto.inicio));
            document.getElementById("modalFin").textContent = Highcharts.dateFormat('%e %B %Y', parseFechaISO(proyecto.fin));
            document.getElementById("modalProgreso").textContent = Math.round(proyecto.progreso * 100);

            // Nuevos datos importantes
            document.getElementById("modalSolicitante").textContent = proyecto.nombreSolicitante || 'N/A';
            document.getElementById("modalInstitucion").textContent = proyecto.institucion || 'N/A';
            document.getElementById("modalResponsable").textContent = proyecto.responsable || 'N/A';
            document.getElementById("modalTipoDemanda").textContent = proyecto.tipoDemanda === 'especifica' ? 'Demanda Espec√≠fica' : 'Demanda Abierta';
            document.getElementById("modalDescripcion").textContent = proyecto.descripcion || 'Sin descripci√≥n';

            // Timeline personalizado (puedes mantenerlo o cambiarlo si lo vinculas a las fechas reales del proyecto)
            setTimeout(() => {
                const container = document.getElementById('timeline');
                container.innerHTML = '';

                const items = new vis.DataSet([
                    {
                        id: 1,
                        content: '<div style="width: 150px;">Propuestas de Necesidades<br>#1234<br><small>01/05/2025</small><br><a class="btn btn-primary btn-sm" onclick="event.stopPropagation(); window.open(\'https://ejemplo.com/1\', \'_blank\'); return false;">Ver detalle</a></div>',
                        start: '2025-04-01',
                    },
                    {
                        id: 2,
                        content: '<div style="width: 150px;">Demandas Espec√≠ficas<br>#5678<br><small>10/05/2025</small><br><a class="btn btn-primary btn-sm" onclick="event.stopPropagation(); window.open(\'https://ejemplo.com/2\', \'_blank\'); return false;">Ver detalle</a></div>',
                        start: '2025-05-10',
                    },
                    {
                        id: 3,
                        content: '<div style="width: 150px;">Finiquito<br>#9101<br><small>20/06/2025</small><br><a class="btn btn-primary btn-sm" onclick="event.stopPropagation(); window.open(\'https://ejemplo.com/3\', \'_blank\'); return false;">Ver detalle</a></div>',
                        start: '2025-06-20',
                    }
                ]);

                const timeline = new vis.Timeline(container, items, {
                    editable: false,
                    height: '300px',
                    maxHeight: '300px',
                    margin: { item: 20 },
                    horizontalScroll: true,
                    stack: true,
                    zoomMin: 10000000,
                    zoomMax: 100000000000,
                    zoomKey: 'ctrlKey',
                });

                document.getElementById('zoomIn').onclick = () => {
                    const range = timeline.getWindow();
                    const interval = range.end - range.start;
                    timeline.setWindow({
                        start: range.start.valueOf(),
                        end: range.start.valueOf() + interval * 0.8,
                    });
                };

                document.getElementById('zoomOut').onclick = () => {
                    const range = timeline.getWindow();
                    const interval = range.end - range.start;
                    timeline.setWindow({
                        start: range.start.valueOf(),
                        end: range.start.valueOf() + interval * 1.25,
                    });
                };
            }, 100);

            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('modalProyecto'));
            modal.show();
        }

        function parseFechaISO(fechaStr) {
            const [anio, mes, dia] = fechaStr.split('-');
            return new Date(parseInt(anio), parseInt(mes) - 1, parseInt(dia));
        }

        function cancelarProyecto(id) {
            const index = proyectos.findIndex(p => p.id === id);
            if (index !== -1) {
                if (confirm(`¬øEst√°s seguro de cancelar el proyecto "${proyectos[index].name}"?`)) {
                    proyectos.splice(index, 1);
                    actualizarGantt();
                    actualizarSemaforo(proyectos); // actualizamos el sem√°foro
                    renderizarTablaProyectos(proyectos); // actualizamos la tabla
                }
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("formSubirListado");
            const bloqueSubida = document.getElementById("bloqueSubida");
            const bloquePublicado = document.getElementById("bloquePublicado");

            // Verifica en localStorage si ya se ha subido el listado
            const listadoPublicado = localStorage.getItem("listadoPublicado") === "true";

            if (listadoPublicado) {
                bloqueSubida.style.display = "none";
                bloquePublicado.style.display = "block";
            } else {
                bloqueSubida.style.display = "block";
                bloquePublicado.style.display = "none";
            }

            // Simula carga de archivo
            form?.addEventListener("submit", function (e) {
                e.preventDefault();
                const archivo = document.getElementById("archivoListado").files[0];

                if (!archivo) {
                    alert("Por favor selecciona un archivo.");
                    return;
                }

                // Simulaci√≥n de guardado y persistencia
                localStorage.setItem("listadoPublicado", "true");

                bloqueSubida.style.display = "none";
                bloquePublicado.style.display = "block";

                console.log("Archivo cargado (simulado):", archivo.name);

                setTimeout(() => {
                    location.reload(); // forzar recarga con estado actualizado
                }, 500);
            });
        });
    </script>


    @* MAPA*@

    @*Script de Pantalla Completa*@
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const mapElement = document.getElementById('map');
            const fullscreenButton = document.getElementById('fullscreen-btn');
            const searchContainer = document.getElementById('search-container');
            const mainContainer = document.getElementById('main-container');
            const fullscreenElements = document.createElement('div');
            fullscreenElements.id = 'fullscreen-elements';

            const originalMapParent = mapElement.parentNode;
            const originalSearchParent = searchContainer.parentNode;
            const originalMapNextSibling = mapElement.nextSibling;
            const originalSearchNextSibling = searchContainer.nextSibling;

            fullscreenButton.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    mainContainer.appendChild(fullscreenElements); // Asegurarnos de que fullscreenElements est√© en el DOM
                    fullscreenElements.appendChild(searchContainer);
                    fullscreenElements.appendChild(mapElement);
                    fullscreenElements.requestFullscreen().catch(err => {
                        alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                    });
                } else {
                    document.exitFullscreen();
                }
            });

            document.addEventListener('fullscreenchange', (event) => {
                if (document.fullscreenElement) {
                    fullscreenButton.textContent = "Salir de Pantalla Completa";
                    mainContainer.classList.add('fullscreen-active');
                    mapElement.style.height = "calc(100vh - 60px)";
                    searchContainer.style.backgroundColor = "white";
                } else {
                    fullscreenButton.textContent = "Pantalla Completa";
                    if (originalSearchNextSibling) {
                        originalSearchParent.insertBefore(searchContainer, originalSearchNextSibling);
                    } else {
                        originalSearchParent.appendChild(searchContainer);
                    }
                    if (originalMapNextSibling) {
                        originalMapParent.insertBefore(mapElement, originalMapNextSibling);
                    } else {
                        originalMapParent.appendChild(mapElement);
                    }
                    mainContainer.classList.remove('fullscreen-active');
                    mapElement.style.height = "500px";

                    // Asegurarse de que los estilos se restablezcan
                    fullscreenElements.style.height = 'auto'; // Restablecer altura a su valor inicial
                }
            });
        });
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var map = L.map('map').setView([23.6345, -102.5528], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            L.marker([19.4326, -99.1332]).addTo(map).bindPopup("CDMX - Proyecto Energ√©tico").openPopup();
        });
    </script>

    @* SEM√ÅFORO *@
    <script>
        function actualizarSemaforo(proyectos) {
            const total = proyectos.length;
            const terminados = proyectos.filter(p => p.progreso === 1).length;
            const enCurso = total - terminados;

            const porcentaje = (cantidad) => total === 0 ? 0 : Math.round((cantidad / total) * 100);

            // Actualiza en el DOM
            document.getElementById('proyectos-terminados').textContent = terminados;
            document.getElementById('porcentaje-terminados').textContent = `${porcentaje(terminados)}%`;

            document.getElementById('proyectos-en-curso').textContent = enCurso;
            document.getElementById('porcentaje-en-curso').textContent = `${porcentaje(enCurso)}%`;

            // Por ahora, 0 cancelados
            document.getElementById('proyectos-cancelados').textContent = 0;
            document.getElementById('porcentaje-cancelados').textContent = `0%`;
        }
    </script>
    

    @* GR√ÅFICA DE GANTT *@
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <script>

        document.addEventListener('DOMContentLoaded', function () {
            Highcharts.setOptions({
                time: {
                    useUTC: false // <- Mostrar todo en hora local del navegador
                },
                lang: {
                    week: 'Semana',
                    months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                    weekdays: ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'],
                    shortMonths: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                                'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                    downloadPNG: "Descargar PNG",
                    downloadJPEG: "Descargar JPEG",
                    downloadPDF: "Descargar PDF",
                    downloadSVG: "Descargar SVG",
                    printChart: "Imprimir gr√°fico",
                    viewFullscreen: "Ver en pantalla completa",
                    exitFullscreen: "Salir de pantalla completa",
                    downloadCSV: "Descargar CSV",
                    downloadXLS: "Descargar Excel",
                    viewData: "Ver tabla de datos",
                    hideData: "Ocultar tabla de datos",
                    contextButtonTitle: "Opciones del gr√°fico"
                },
                // Este bloque cambia el formato del texto que aparece para las semanas
                dateTimeLabelFormats: {
                    week: "'Semana' W"
                },
            }); 
            
            // Proyectos iniciales para prototipo
            proyectos.push(
                {
                    id: '1',
                    name: 'Campo Jaf de almacenamiento estrat√©gico',
                    inicio: '2025-05-06',
                    fin: '2025-05-13',
                    progreso: 1,
                    dependencias: null
                },
                {
                    id: '2',
                    name: 'Contrato de Servicios Integrales de Exploraci√≥n y Extracci√≥n Lakach',
                    inicio: '2025-05-14',
                    fin: '2025-05-20',
                    progreso: 0.5,
                    dependencias: '1'
                },
                {
                    id: '3',
                    name: 'CFE: Gasoducto Tula ‚Äì Villa de Reyes',
                    inicio: '2025-05-21',
                    fin: '2025-05-28',
                    progreso: 0.2,
                    dependencias: '2'
                },
                {
                    id: '4',
                    name: 'CFE: Gasoducto Tuxpan ‚Äì Tula',
                    inicio: '2025-05-29',
                    fin: '2025-06-04',
                    progreso: 0.0,
                    dependencias: '3'
                }
            );

            actualizarGantt(); // Muestra el gr√°fico con datos iniciales
            actualizarSemaforo(proyectos);
            renderizarTablaProyectos(proyectos);
        });
    </script>
}