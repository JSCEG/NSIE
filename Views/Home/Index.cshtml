@model HomeIndex
@using NSIE.Models
@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Sistema Nacional de Información Energética (SNIEr)";
    var perfilJson = HttpContextAccessor.HttpContext.Session.GetString("PerfilUsuario");
    var perfilUsuario = JsonConvert.DeserializeObject<PerfilUsuario>(perfilJson);
    ViewData["NombreUsuario"] = perfilUsuario.Nombre;
    ViewData["RolUsuario"] = perfilUsuario.Rol;
    ViewData["IDUsuario"] = perfilUsuario.IdUsuario;



    var secciones = new[] {
        new { Titulo = "🔐 Gobernanza y Seguridad", Articulos = "Art. 70, 71, 76", Descripcion = "Control de usuarios, roles, trazabilidad, firma digital y clasificación de datos." },
        new { Titulo = "🧾 Carga, Validación y CRM", Articulos = "Art. 70, 71, 73, 76", Descripcion = "Carga masiva, validación, notificaciones, oficios institucionales y firma digital." },
        new { Titulo = "📊 Datos Públicos", Articulos = "Art. 70, 76, 77, 111", Descripcion = "Consulta de información pública, boletines, precios, CELs y balance energético." },
        new { Titulo = "📈 Indicadores", Articulos = "Art. 70, 76", Descripcion = "Consulta de indicadores estratégicos y de eficiencia institucional." },
        new { Titulo = "⚖️ Obligaciones y Cumplimiento", Articulos = "Art. 70, 76", Descripcion = "Semáforos de cumplimiento, obligaciones normativas y sanciones." },
        new { Titulo = "🚧 Proyectos Estratégicos y Analítica", Articulos = "Art. 70, 76", Descripcion = "Seguimiento de proyectos, modelos predictivos, metas energéticas y evaluación de proyectos." },
        new { Titulo = "🌍 Análisis Geoespacial", Articulos = "Art. 66-70, 75", Descripcion = "Mapas energéticos, infraestructura, riesgos y potencial renovable." },
        new { Titulo = "🔧 Interoperabilidad y Configuración", Articulos = "Art. 70, 72, Transitorio Segundo", Descripcion = "APIs, conectores, reglas de operación y evolución modular del sistema." },
        new { Titulo = "📚 Normatividad y Disposiciones", Articulos = "Art. 71-72", Descripcion = "Gestión de reglas, formatos, lineamientos, instructivos y políticas técnicas." },
        new { Titulo = "📁 Planeación Vinculante", Articulos = "Art. 66, 67, 111", Descripcion = "Repositorio oficial de documentos estratégicos del SNIEr." },
        new { Titulo = "📆 Programa del Consejo", Articulos = "Art. 76", Descripcion = "Objetivos, metas, recursos, asesorías técnicas y mesa de ayuda anual del SNIEr." },
        new { Titulo = "📢 Difusión y Fuente Oficial", Articulos = "Art. 77", Descripcion = "Mecanismo de difusión oficial y citación obligatoria del SNIEr como fuente de información." }
    };

    var modulosSnie = new List<ModuloSNIER>
    {
    // Nuevos módulos derivados del Reglamento
   new ModuloSNIER { Seccion = secciones[0].Titulo, Controller = "Usuarios", Action = "AdministrarUsuarios", Title = "Gestión de Usuarios y Perfiles", Desc = "Administra perfiles, roles y accesos.", Img = "usuarios_scel.png", Btn = "Administrar", Roles = "1" },
        new ModuloSNIER { Seccion = secciones[0].Titulo, Controller = "Bitacora", Action = "Dashboard", Title = "Seguridad y Auditoría", Desc = "Supervisa acciones del sistema y alertas.", Img = "seguridad_alertas_scel.png", Btn = "Ver Acciones", Roles = "1,7" },
        new ModuloSNIER { Seccion = secciones[0].Titulo, Controller = "SNIE", Action = "SubsistemasExternos", Title = "Subsistemas Externos Integrados", Desc = "Consulta la integración de entidades federativas, municipios y privados (Art. 69).", Img = "subsistemas.png", Btn = "Consultar", Roles = "1,7,8" },
        
    
    // 1.-Carga, Validación y CRM
    new ModuloSNIER { Seccion = secciones[1].Titulo, Controller = "SNIE", Action = "CargaInformacion", Title = "Carga de Información", Desc = "Colaboradores registran datos clave.", Img = "carga_info.png", Btn = "Subir Archivos", Roles = "1,8" },
    new ModuloSNIER { Seccion = secciones[1].Titulo, Controller = "SNIE", Action = "ValidacionFirma", Title = "Validación y Firma", Desc = "Valida registros y genera acuse con e.firma.", Img = "firma.png", Btn = "Firmar", Roles = "1,8" },
    new ModuloSNIER { Seccion = secciones[1].Titulo, Controller = "SNIE", Action = "BuzonNotificaciones", Title = "Notificaciones y Oficios", Desc = "Consulta notificaciones internas y acuses.", Img = "notificaciones.png", Btn = "Consultar", Roles = "1,7,8" },

    // 2.-Datos Públicos
    new ModuloSNIER { Seccion = secciones[2].Titulo, Controller = "EnergiasLimpias", Action = "Certificados", Title = "Boletín de CELs", Desc = "Consulta los reportes sobre certificados de energías limpias.", Img = "cel.png", Btn = "Ver CELs", Roles = "0,1,7,8" },
    new ModuloSNIER { Seccion = secciones[2].Titulo, Controller = "EnergiasLimpias", Action = "FactorEmision", Title = "Factor de Emisión", Desc = "Consulta indicadores de emisión del SEN.", Img = "emision.png", Btn = "Consultar", Roles = "0,1,7,8" },
    new ModuloSNIER { Seccion = secciones[2].Titulo, Controller = "Sankey", Action = "Sankey", Title = "Balance Nacional de Energía", Desc = "Visualiza el flujo energético nacional.", Img = "sankey.png", Btn = "Explorar", Roles = "0,1,7,8" },
    new ModuloSNIER { Seccion = secciones[2].Titulo, Controller = "Map", Action = "I_Petroliferos", Title = "Precios de Estaciones", Desc = "Consulta precios actualizados por zona.", Img = "gasolinera.png", Btn = "Ver Precios", Roles = "0,1,7,8" },
    new ModuloSNIER { Seccion = secciones[2].Titulo, Controller = "Indicadores", Action = "Precio_Gas_LP", Title = "Precios de Gas L.P.", Desc = "Consulta precios históricos de Gas L.P.", Img = "precio.png", Btn = "Ver Históricos", Roles = "0,1,7,8" },
    new ModuloSNIER { Seccion = secciones[2].Titulo, Controller = "Tarifas", Action = "TarifasMI", Title = "Tarifas Eléctricas", Desc = "Consulta tarifas de electricidad a nivel nacional.", Img = "precio.png", Btn = "Consultar Tarifas", Roles = "0,1,7,8" },
// 3.-Indicadores
new ModuloSNIER { Seccion = secciones[3].Titulo, Controller = "Indicadores", Action = "IndicadoresInstitucionales", Title = "Indicadores de Eficiencia por Área", Desc = "Monitorea el desempeño estratégico, operativo y de gestión institucional.", Img = "indicadores.png", Btn = "Ver Indicadores", Roles = "1,7,8" },

// 4.-Obligaciones y Cumplimiento
new ModuloSNIER { Seccion = secciones[4].Titulo, Controller = "SNIE", Action = "VerificadorDatos", Title = "Verificador de Datos", Desc = "Valida incongruencias en la información registrada por los subsistemas (Art. 112).", Img = "verificador.png", Btn = "Verificar", Roles = "1,7,8" },
new ModuloSNIER { Seccion = secciones[4].Titulo, Controller = "SNIE", Action = "Semaforo", Title = "Semáforo de Carga", Desc = "Visualiza el estado por dependencia (Verde, Amarillo, Rojo).", Img = "semaforo.png", Btn = "Ver Semáforo", Roles = "1,7,8" },
new ModuloSNIER { Seccion = secciones[4].Titulo, Controller = "SNIE", Action = "ObligacionesEntrega", Title = "Control de Entregas SNIEr", Desc = "Consulta el cumplimiento de entrega de información por subsistema (Art. 74).", Img = "entregas.png", Btn = "Revisar", Roles = "1,7,8" },

// 5.-Proyectos Estratégicos y Analítica
new ModuloSNIER { Seccion = secciones[5].Titulo, Controller = "Proyectos", Action = "FOTEASE", Title = "FOTEASE", Desc = "Fondo para Transición Energética y el Aprovechamiento Sustentable de la Energía.", Img = "fotease.png", Btn = "Consultar", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[5].Titulo, Controller = "Proyectos", Action = "FSUE", Title = "FSUE (tentativo)", Desc = "Fondo del Servicio Universal Eléctrico (nombre por confirmar).", Img = "fsue.png", Btn = "Consultar", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[5].Titulo, Controller = "Proyectos", Action = "FondoPetroleo", Title = "Fondo Mexicano del Petróleo (tentativo)", Desc = "Instrumento financiero relacionado con los ingresos derivados del petróleo.", Img = "fondopetroleo.png", Btn = "Consultar", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[5].Titulo, Controller = "Home", Action = "EnConstruccion", Title = "Seguimiento de Proyectos", Desc = "Monitorea el avance de proyectos estratégicos del sector.", Img = "seguimiento_proyectos.png", Btn = "Ver Proyectos", Roles = "1,7,8" },

// 6.-Análisis Geoespacial
new ModuloSNIER { Seccion = secciones[6].Titulo, Controller = "Indicadores", Action = "Menu_Mecanismo", Title = "Analítica y Transición Energética", Desc = "Consulta modelos predictivos, metas y escenarios.", Img = "analitica.png", Btn = "Ver Analítica", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[6].Titulo, Controller = "Map", Action = "Infraestructura_SEM", Title = "Análisis Geoespacial", Desc = "Consulta mapas, capas estratégicas y riesgos.", Img = "geo.png", Btn = "Explorar Mapa", Roles = "0,1,7,8" },

// 7.-Interoperabilidad y Configuración
new ModuloSNIER { Seccion = secciones[7].Titulo, Controller = "Home", Action = "EnConstruccion", Title = "Interoperabilidad y Conectividad", Desc = "Consulta las integraciones con otros sistemas.", Img = "interoperabilidad.png", Btn = "Ver Conexiones", Roles = "1" },

new ModuloSNIER { Seccion = secciones[7].Titulo, Controller = "Home", Action = "EnConstruccion", Title = "Modificación de Variables Operativas", Desc = "Administra las variables operativas del sistema.", Img = "modificacion_variables_scel.png", Btn = "Modificar Variables", Roles = "1" },

// 8.-Normatividad y Disposiciones
new ModuloSNIER { Seccion = secciones[8].Titulo, Controller = "Normatividad", Action = "Formatos", Title = "Gestión de Reglas y Formatos", Desc = "Visualiza políticas, normas técnicas, lineamientos e instructivos oficiales.", Img = "normas.png", Btn = "Consultar", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[8].Titulo, Controller = "Normatividad", Action = "RepositorioFormularios", Title = "Repositorio de Formularios del Sector Energético", Desc = "Consulta formatos estandarizados relacionados con trámites energéticos (Art. 73).", Img = "formularios.png", Btn = "Consultar", Roles = "1,7" },

// 9.-Planeación Vinculante
new ModuloSNIER { Seccion = secciones[9].Titulo, Controller = "Repositorio", Action = "Documentos", Title = "Repositorio Estratégico", Desc = "Consulta documentos vinculantes y estrategias energéticas.", Img = "repositorio.png", Btn = "Acceder", Roles = "1,7" },

// 10.-Programa del Consejo - Reorganizado según el orden definido
new ModuloSNIER { Seccion = secciones[10].Titulo, Controller = "Consejo", Action = "ProgramaAnual", Title = "Programa de Trabajo del Consejo", Desc = "Consulta los objetivos, metas, recursos y actividades anuales del Consejo.", Img = "modulos/programa_anual.png", Btn = "Consultar", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[10].Titulo, Controller = "Consejo", Action = "AvanceMetas", Title = "Avance de Metas y Líneas de Acción", Desc = "Monitorea el cumplimiento del Programa Anual con base en metas trazadas.", Img = "modulos/metas_consejo.png", Btn = "Ver Avance", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[10].Titulo, Controller = "Consejo", Action = "OrdenDelDia", Title = "Orden del Día y Convocatorias", Desc = "Consulta las convocatorias, orden del día y documentos de sesiones.", Img = "modulos/convocatorias.png", Btn = "Consultar", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[10].Titulo, Controller = "Consejo", Action = "Votaciones", Title = "Votaciones Colegiadas", Desc = "Permite al Consejo emitir votos sobre asuntos en agenda colegiada.", Img = "modulos/votaciones_consejo.png", Btn = "Votar", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[10].Titulo, Controller = "Consejo", Action = "FirmaActas", Title = "Firma de Actas del Consejo", Desc = "Visualiza y firma electrónicamente las actas de sesiones y acuerdos.", Img = "modulos/firma_actas.png", Btn = "Firmar Acta", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[10].Titulo, Controller = "Consejo", Action = "AcuerdosCoordinacion", Title = "Acuerdos de Coordinación", Desc = "Consulta los acuerdos formales del Consejo y su estatus de cumplimiento.", Img = "modulos/acuerdos_coordinacion.png", Btn = "Ver Acuerdos", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[10].Titulo, Controller = "Consejo", Action = "BuzonAsuntos", Title = "Buzón de Asuntos del Consejo", Desc = "Permite a las unidades y miembros registrar propuestas formales de asuntos a tratar en sesión.", Img = "modulos/buzon_consejo.png", Btn = "Registrar Asunto", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[10].Titulo, Controller = "Consejo", Action = "IndicadoresConsejo", Title = "Indicadores del Consejo", Desc = "Visualiza métricas sobre sesiones, acuerdos, participación y cumplimiento.", Img = "modulos/indicadoresconsejo.png", Btn = "Ver Indicadores", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[10].Titulo, Controller = "Consejo", Action = "TrazabilidadAcuerdos", Title = "Trazabilidad de Acuerdos", Desc = "Consulta la línea del tiempo normativa y operativa de cada asunto deliberado.", Img = "modulos/trazabilidad.png", Btn = "Ver Trazabilidad", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[10].Titulo, Controller = "Consejo", Action = "RepositorioSesiones", Title = "Repositorio de Sesiones", Desc = "Consulta actas, acuerdos y documentación histórica de sesiones previas.", Img = "modulos/repositorio_sesiones.png", Btn = "Ver Repositorio", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[10].Titulo, Controller = "Consejo", Action = "ConsultasPublicas", Title = "Consultas Públicas", Desc = "Visualiza los acuerdos y votaciones que son públicos.", Img = "modulos/consultas_publicas.png", Btn = "Ver Público", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[10].Titulo, Controller = "Consejo", Action = "IntegrantesRoles", Title = "Integrantes y Roles", Desc = "Consulta a los integrantes del Consejo y su participación.", Img = "modulos/integrantes_roles.png", Btn = "Ver Integrantes", Roles = "1,7" },

new ModuloSNIER { Seccion = secciones[10].Titulo, Controller = "Consejo", Action = "AsesoriaTecnica", Title = "Asesoría Técnica y Documentación", Desc = "Accede a documentos de apoyo y análisis técnico que respaldan decisiones.", Img = "modulos/asesoria.png", Btn = "Ver Documentos", Roles = "1,7" }
};
}


<div class="text-center">
    <h3 class="cp-section cp-grouping-section">
        <img src="~/img/iconos/sistema.png" alt="Icono personalizado" class="iconomenu">
        @ViewData["Title"]
    </h3>
</div>

<!-- Contenido por secciones -->
<div class="container pe-5 ps-5">
@foreach (var seccion in secciones)
{
    var modulos = modulosSnie.Where(m => m.Seccion == seccion.Titulo).ToList();
    var modulosVisibles = modulos.Where(m => string.IsNullOrEmpty(m.Roles) || m.Roles.Split(',').Contains(perfilUsuario.Rol)).ToList();

    if (modulosVisibles.Any())
    {
        <div class="row g-4 mt-4">
            <div class="col-12">
                <h4 class="subtitulobus mb-3">@seccion.Titulo</h4>
                <div class="alert alert-success mt-2" role="alert">
                    <strong>¿Qué hace?</strong> @seccion.Descripcion <br />
                    <strong>Fundamento legal:</strong> @seccion.Articulos
                </div>
            </div>
            @foreach (var mod in modulosVisibles)
            {
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <img src="~/img/@mod.Img" alt="@mod.Title" class="iconomenu mb-3" />
                            <h5>@mod.Title</h5>
                            <p>@mod.Desc</p>
                            <a asp-controller="@mod.Controller" asp-action="@mod.Action" class="btn btn-snie">@mod.Btn</a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
}

</div>

<!-- Diagrama adicional -->
<div id="miDiv" class="">
    <h3 class="subtitulo mb-3 pt-5">Recursos e Infraestructura</h3>
</div>
<center>
    <partial name="_DiagramaSEM_N" />
    @* <partial name="_DiagramaSEM"/> *@
</center>