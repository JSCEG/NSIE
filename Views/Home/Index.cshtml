@model HomeIndex
@using NSIE.Models
@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "SNIE - Bienvenidos";
    var perfilJson = HttpContextAccessor.HttpContext.Session.GetString("PerfilUsuario");
    var perfilUsuario = JsonConvert.DeserializeObject<PerfilUsuario>(perfilJson);
    ViewData["NombreUsuario"] = perfilUsuario.Nombre;
    ViewData["RolUsuario"] = perfilUsuario.Rol;
    ViewData["MercadoUsuario"] = perfilUsuario.Mercado_ID;
    ViewData["IDUsuario"] = perfilUsuario.IdUsuario;
    bool isAdmin = perfilUsuario.Rol == "1";

    var secciones = new[] {
        " SECCIN 1: Gobernanza y Seguridad",
        "Ь SECCIN 2: Carga, Validaci贸n y CRM",
        " SECCIN 3: Indicadores y Datos P煤blicos",
        "锔 SECCIN 4: Obligaciones y Cumplimiento",
        " SECCIN 5: Proyectos Estrat茅gicos y Anal铆tica",
        " SECCIN 6: An谩lisis Geoespacial",
        " SECCIN 7: Interoperabilidad y Configuraci贸n"
    };

    var modulosSnie = new[] {
        new { Seccion=secciones[0], Controller="Usuarios", Action="AdministrarUsuarios", Title="Gesti贸n de Perfiles y Usuarios", Desc="Administra los perfiles y usuarios del sistema.", Img="usuarios_scel.png", Btn="Administrar" },
        new { Seccion=secciones[0], Controller="Bitacora", Action="Dashboard", Title="Seguridad y Alertas", Desc="Revisa las alertas de seguridad del sistema.", Img="seguridad_alertas_scel.png", Btn="Ver Acciones" },

        new { Seccion=secciones[1], Controller="SNIE", Action="CargaInformacion", Title="Carga de Informaci贸n", Desc="Los colaboradores registran datos clave para el Balance Nacional.", Img="carga_info.png", Btn="Subir Archivos" },
        new { Seccion=secciones[1], Controller="SNIE", Action="ValidacionFirma", Title="Validaci贸n y Firma", Desc="Valida lo enviado y simula el timbrado con e.firma generando un acuse.", Img="firma.png", Btn="Firmar Informaci贸n" },
        new { Seccion=secciones[1], Controller="SNIE", Action="BuzonNotificaciones", Title="Buz贸n de Notificaciones", Desc="Revisa las notificaciones del SNIE", Img="notificaciones.png", Btn="Ver Notificaciones" },

        new { Seccion=secciones[2], Controller="EnergiasLimpias", Action="Certificados", Title="Reportes y Bolet铆n CELs", Desc="Consulta los reportes y boletines sobre los CEL.", Img="reportes_scel.png", Btn="Consultar" },
        new { Seccion=secciones[2], Controller="SNIE", Action="BalanceNacional", Title="Balance Nacional de Energ铆a", Desc="Consulta el Tablero del Balance Nacional de Energ铆a", Img="sankey.png", Btn="Ver Balance Nacional de Energ铆a" },

        new { Seccion=secciones[3], Controller="SNIE", Action="Semaforo", Title="Sem谩foro de Carga", Desc="Visualiza el estado por dependencia (Verde, Amarillo, Rojo).", Img="semaforo.png", Btn="Ver Sem谩foro" },

        new { Seccion=secciones[4], Controller="Home", Action="EnConstruccion", Title="Seguimiento de Proyectos", Desc="Monitorea el avance de proyectos estrat茅gicos del sector.", Img="seguimiento_proyectos.png", Btn="Ver Proyectos" },
        new { Seccion=secciones[4], Controller="Home", Action="EnConstruccion", Title="Anal铆tica y Transici贸n Energ茅tica", Desc="Consulta modelos predictivos, metas y escenarios.", Img="analitica.png", Btn="Ver Anal铆tica" },

        new { Seccion=secciones[5], Controller="Map", Action="Infraestructura_SEM", Title="An谩lisis Geoespacial", Desc="Consulta mapas, capas estrat茅gicas y riesgos.", Img="geo.png", Btn="Explorar Mapa" },

        new { Seccion=secciones[6], Controller="Home", Action="EnConstruccion", Title="Interoperabilidad y Conectividad", Desc="Consulta las integraciones con otros sistemas.", Img="interoperabilidad.png", Btn="Ver Conexiones" },
        new { Seccion=secciones[6], Controller="Home", Action="EnConstruccion", Title="Modificaci贸n de Variables Operativas", Desc="Administra las variables operativas del sistema.", Img="modificacion_variables_scel.png", Btn="Modificar Variables" }
    };
}

<div class="text-center">
    <h3 class="cp-section cp-grouping-section">
        <img src="~/img/iconos/sistema.png" alt="Icono personalizado" class="iconomenu">
        @ViewData["Title"]
    </h3>
</div>

<div class="container pe- ps-5">
    <div class="owl-carousel owl-theme mb-5">
        @foreach (var banner in new[] {
            new { Controller="EnergiasLimpias", Action="Certificados", Img="12.png", Alt="Certificados de Energ铆as Limpias" },
            new { Controller="Map", Action="Infraestructura_SEM", Img="5.png", Alt="Sistema Energ茅tico Mexicano" },
            new { Controller="Sankey", Action="Sankey", Img="7.png", Alt="Flujo F铆sico de la Energ铆a" }
        })
        {
            <div class="item">
                <a asp-controller="@banner.Controller" asp-action="@banner.Action">
                    <img src="~/img/banner/@banner.Img" alt="@banner.Alt" class="img-fluid" />
                </a>
            </div>
        }
    </div>

    <h3 class="text-center subtitulobus mt-5 mb-4">M贸dulos Funcionales del SNIEr</h3>

    @foreach (var seccion in secciones)
    {
        var numeroModulo = secciones.ToList().IndexOf(seccion) + 1;
        var modulosVisibles = modulosSnie.Where(m =>
            m.Seccion == seccion &&
            (
                ViewData["IDUsuario"].ToString() == "1" ||
                (ViewData["IDUsuario"].ToString() == "10" &&
                    (m.Title.Contains("Reportes y Bolet铆n") || m.Title.Contains("Balance Nacional"))) ||
                (ViewData["IDUsuario"].ToString() == "46" && !m.Title.Contains("Carga de Informaci贸n")) ||
                (ViewData["IDUsuario"].ToString() == "58" &&
                    (m.Title.Contains("Carga") || m.Title.Contains("Validaci贸n") || m.Title.Contains("Balance") ||
                     m.Title.Contains("Sem谩foro") || m.Title.Contains("Buz贸n") || m.Title.Contains("Proyectos") ||
                     m.Title.Contains("Anal铆tica") || m.Title.Contains("Geoespacial")))
            )
        ).ToList();

        if (modulosVisibles.Any())
        {
            <div class="row g-4 mt-4">
                <div class="col-12">
                    <h4 class="subtitulobus">@($"M贸dulo {numeroModulo}: {seccion.Substring(seccion.IndexOf(':') + 1).Trim()}")</h4>
                    <div class="alert alert-info small">
                        @{
                            string descripcion = numeroModulo switch
                            {
                                1 => "Roles, perfiles, clasificaci贸n de datos, firma digital, biometr铆a y auditor铆a.",
                                2 => "Carga masiva, validaci贸n autom谩tica, control de versiones y asignaci贸n por perfil.",
                                3 => "Validaci贸n de datos, errores, advertencias, soporte t茅cnico y reglas.",
                                4 => "Acceso p煤blico a tableros, datasets y visualizaciones energ茅ticas.",
                                5 => "Balance energ茅tico, CELs, precios, tarifas y matriz energ茅tica.",
                                6 => "Alertas, obligaciones, sanciones y sem谩foros de cumplimiento regulatorio.",
                                7 => "Oficios internos, acuses, workflow, trazabilidad y notificaciones.",
                                8 => "Proyectos, seguimiento por etapas, riesgos y evidencias.",
                                9 => "Modelos predictivos, IA, metas energ茅ticas y escenarios.",
                                10 => "Infraestructura, capas estrat茅gicas, riesgo y an谩lisis geoespacial.",
                                11 => "Integraci贸n v铆a API, conectores, ETLs y sincronizaci贸n externa.",
                                12 => "Configuraci贸n de reglas, evoluci贸n de m贸dulos y adaptabilidad normativa.",
                                _ => ""
                            };
                            @descripcion
                        }
                    </div>
                </div>
                @foreach (var mod in modulosVisibles)
                {
                    <div class="col-md-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body text-center">
                                <img src="~/img/@mod.Img" alt="@mod.Title" class="iconomenu mb-3" />
                                <h5>@mod.Title</h5>
                                <p>@mod.Desc</p>
                                <a asp-controller="@mod.Controller" asp-action="@mod.Action" class="btn btn-snie">@mod.Btn</a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <script>
        $(document).ready(function () {
            $('.owl-carousel').owlCarousel({
                loop: true,
                margin: 10,
                nav: true,
                items: 1,
                autoplay: true,
                autoplayTimeout: 3000,
                autoplayHoverPause: true
            });
        });
    </script>
}