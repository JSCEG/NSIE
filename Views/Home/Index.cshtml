@model NSIE.Models.HomeViewModel
@using NSIE.Models
@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Sistema Nacional de Información Energética (SNIEr)";

    var perfilJson = HttpContextAccessor.HttpContext.Session.GetString("PerfilUsuario");
    var perfilUsuario = JsonConvert.DeserializeObject<PerfilUsuario>(perfilJson);
    // Utilizar los datos del usuario para personalizar la vista
    ViewData["NombreUsuario"] = perfilUsuario.Nombre;
    ViewData["RolUsuario"] = perfilUsuario.Rol;
    ViewData["MercadoUsuario"] = perfilUsuario.Mercado_ID;

    var header = new HeaderViewModel
    {
        Title = ViewData["Title"].ToString(),
        IconPath = "sistema.png",
        Description = "Plataforma de integración, consulta, trazabilidad y análisis de información energética nacional.",
        Section = "Inicio",
        ModuleInfo = JsonConvert.SerializeObject(new
        {
            title = "SNIEr",
            description = "Portal principal del Sistema Nacional de Información Energética.",
            functionality = "Consulta módulos, indicadores, reportes, trazabilidad y estados del sistema.",
            stage = "Operación",
            roles = new[] {
new { icon = "globe", text = "Usuarios Públicos: Consulta general de datos" },
new { icon = "user-shield", text = "Funcionarios CRE/SENER: Gestión e integración de información" }
},
            order = new { step = 0, description = "Punto de acceso inicial al ecosistema energético" },
            manualUrl = "/Documentos/ManualSNIEr.pdf"
        })
    };
}

@await Html.PartialAsync("_ViewHeader", header)
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function mostrarAyudaModulo(infoJson) {
            try {
                const info = typeof infoJson === 'string' ? JSON.parse(infoJson) : infoJson;
                const html = `
                                    <div class="text-start">
                                        ${info.description ? `<p><strong>${info.description}</strong></p>` : ''}
                                        ${info.functionality ? `<p><i class='fas fa-cogs'></i> ${info.functionality}</p>` : ''}
                                        ${info.stage ? `<p><i class='fas fa-layer-group'></i> Etapa: ${info.stage}</p>` : ''}
                                        ${info.roles?.length ? `
                                            <ul>
                                                ${info.roles.map(r => `<li><i class="fas fa-${r.icon} me-2 text-primary"></i> ${r.text}</li>`).join('')}
                                            </ul>` : ''}
                                        ${info.order ? `<p><i class='fas fa-sort-amount-up'></i> Paso ${info.order.step}: ${info.order.description}</p>` : ''}
                                    </div>`;

                Swal.fire({
                    title: info.title || 'Ayuda del módulo',
                    html: html,
                    confirmButtonText: 'Cerrar',
                    confirmButtonColor: '#6c757d',
                    backdrop: true
                });
            } catch (e) {
                console.error("Error al mostrar ayuda del módulo:", e);
                Swal.fire('Error', 'No se pudo cargar la información del módulo', 'error');
            }
        }
    </script>
}

@{
    ViewData["Title"] = "Inicio";
    var idUsuario = Convert.ToInt32(ViewData["IDUsuario"]);
    var rolUsuario = perfilUsuario?.Rol;
    var nombreUsuario = perfilUsuario?.Nombre?.ToLower();
    var esConsultaPublica = (rolUsuario == "10" || nombreUsuario.Contains("consult"));
}


<!-- HERO PRINCIPAL -->
<section id="hero" class="py-5 bg-light text-center text-lg-start position-relative overflow-hidden">
    <div class="container d-flex flex-column align-items-center justify-content-center text-center" data-aos="zoom-in">
        <img src="@Cdn.Url/img_snier/login/logo_snier.png" class="img-fluid mb-4" alt="Sistema Energético Mexicano">
        <h1 class="display-5 fw-bold">
            @if (esConsultaPublica)
            {
                <text>Bienvenido a la Consulta Pública</text>
            }
            else if (idUsuario == 46)
            {
                <text>Bienvenido, Usuario del Consejo</text>
            }
            else if (idUsuario == 58)
            {
                <text>Bienvenido, Usuario del Sector</text>
            }
            else
            {
                <text>Bienvenido, @nombreUsuario</text>
            }
        </h1>
        <p class="lead mt-3 mb-4">El SNIEr es la fuente oficial de información del sector energético en México.</p>
    </div>
</section>

<!-- QUE ES EL SNIER -->
<section class="py-5 bg-white">
    <div class="container" data-aos="fade-up">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h2 class="fw-bold">¿Qué es el SNIEr?</h2>
                <p class="text-muted">El Sistema Nacional de Información Energética (SNIEr) integra, organiza y difunde
                    datos técnicos, económicos, sociales y geoespaciales sobre el sector energético nacional. Es
                    coordinado por el Consejo y administrado por la CNE.</p>
                <ul class="list-unstyled mt-3">
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Planeación Vinculante</li>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Subsistemas interinstitucionales</li>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Información técnica y geoespacial</li>
                </ul>
            </div>
            <div class="col-md-6 text-center">
                <img src="@Cdn.Url/img_snier/vistas/pregunta.png" class="img-fluid" alt="Explicación SNIEr">
            </div>
        </div>
    </div>
</section>

<!-- MODULOS DESTACADOS -->
<section id="modulos" class="py-5 bg-light">
    <div class="container">
        <h2 class="fw-bold text-center mb-4" data-aos="fade-up">Contenido del SNIEr</h2>
        <div class="row g-4" data-aos="fade-up">
            <div class="col-md-4">
                <div class="card h-100 text-center border-0 shadow-sm">
                    <div class="card-body">
                        <i class="bi bi-database fs-1 text-primary"></i>
                        <h5 class="mt-3">Información Energética</h5>
                        <p class="text-muted">Origen, destino y consumo final de la energía.</p>
                        <a href="@Url.Action("Energia", "SNIE")" class="btn btn-sm btn-outline-primary mt-2">Ver más</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 text-center border-0 shadow-sm">
                    <div class="card-body">
                        <i class="bi bi-map fs-1 text-success"></i>
                        <h5 class="mt-3">Georreferenciación</h5>
                        <p class="text-muted">Mapa de permisos y proyectos energéticos.</p>
                        <a href="@Url.Action("Mapa", "SNIE")" class="btn btn-sm btn-outline-success mt-2">Explorar</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 text-center border-0 shadow-sm">
                    <div class="card-body">
                        <i class="bi bi-gear-wide fs-1 text-warning"></i>
                        <h5 class="mt-3">Catálogos y Tecnologías</h5>
                        <p class="text-muted">Tecnologías para generación y uso final de energía.</p>
                        <a href="@Url.Action("Catalogos", "SNIE")"
                            class="btn btn-sm btn-outline-warning mt-2">Consultar</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- GRÁFICO DE INDICADORES -->
<section id="indicadores" class="py-5 bg-white">
    <div class="container" data-aos="fade-up">
        <h2 class="fw-bold text-center mb-4">Indicadores Energéticos</h2>
        <div id="chartContainer" style="height: 400px;"></div>
    </div>
</section>

@* <script src="https://code.highcharts.com/highcharts.js"></script> *@
<script>
    document.addEventListener("DOMContentLoaded", function () {
        Highcharts.chart('chartContainer', {
            chart: { type: 'line' },
            title: { text: 'Producción Energética Anual (GWh)' },
            xAxis: { categories: ['2018', '2019', '2020', '2021', '2022'] },
            yAxis: { title: { text: 'GWh' } },
            series: [{
                name: 'Energía Eléctrica',
                data: [32000, 34000, 31000, 36000, 39000]
            }, {
                name: 'Hidrocarburos',
                data: [28000, 29000, 27500, 30000, 31000]
            }]
        });
    });
</script>

<!-- CARRUSEL DE VISUALIZACIONES (con imágenes en línea) -->
<section class="py-5 bg-light">
    <div class="container" data-aos="fade-up">
        <h2 class="fw-bold text-center mb-4">Visualizaciones Destacadas</h2>
        <div id="carouselVisual" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-indicators">
                <button type="button" data-bs-target="#carouselVisual" data-bs-slide-to="0" class="active"
                    aria-current="true" aria-label="Visual 1"></button>
                <button type="button" data-bs-target="#carouselVisual" data-bs-slide-to="1"
                    aria-label="Visual 2"></button>
                <button type="button" data-bs-target="#carouselVisual" data-bs-slide-to="2"
                    aria-label="Visual 3"></button>
            </div>
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <img src="https://images.pexels.com/photos/414837/pexels-photo-414837.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2"
                        class="d-block w-100" alt="Visual 1">
                </div>
                <div class="carousel-item">
                    <img src="https://images.pexels.com/photos/32399131/pexels-photo-32399131/free-photo-of-complejo-industrial-en-botlek-rotterdam.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2"
                        class="d-block w-100" alt="Visual 2">
                </div>
                <div class="carousel-item">
                    <img src="https://images.pexels.com/photos/9703551/pexels-photo-9703551.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2"
                        class="d-block w-100" alt="Visual 3">
                </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselVisual" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Anterior</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselVisual" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Siguiente</span>
            </button>
        </div>
    </div>
</section>


<!-- MAPA DE TRAZABILIDAD CON LEAFLET -->
<section class="py-5 bg-white">
    <div class="container" data-aos="fade-up">
        <h2 class="fw-bold text-center mb-4">Trazabilidad Geoespacial</h2>
        <div id="map" class="rounded shadow-sm" style="height: 500px;"></div>
    </div>
</section>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var map = L.map('map').setView([23.6345, -102.5528], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        L.marker([19.4326, -99.1332]).addTo(map).bindPopup("CDMX - Proyecto Energético").openPopup();
    });
</script>
<!-- BLOQUE DE AYUDA -->
<section id="ayuda" class="py-5 bg-light">
    <div class="container" data-aos="fade-up">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h3 class="fw-bold">¿Necesitas apoyo para usar la plataforma?</h3>
                <p class="text-muted">Consulta nuestras guías de uso o contáctanos para obtener asistencia técnica del
                    SNIEr.</p>
                <a href="#" class="btn btn-outline-primary rounded-pill mt-3">Ir al Centro de Ayuda</a>
            </div>
            <div class="col-lg-6 text-center">
                <img src="@Cdn.Url/img_snier/vistas/ayuda.png" alt="Ayuda" class="img-fluid">
            </div>
        </div>
    </div>
</section>
