<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Evaluación de Proyecto Energético Integral</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <!-- Leaflet.draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap">
    <style>
        /* Fuente global y fondo suave */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }

        /* Estilo para el mapa */
        #map {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
        }

        /* Layout: Mapa a la izquierda, formulario a la derecha */
        @media (min-width: 768px) {
            .row-custom {
                display: flex;
                gap: 1rem;
            }

            .left-col,
            .right-col {
                flex: 1;
            }
        }

        /* Tarjetas y secciones: bordes redondeados y sombra sutil */
        .card {
            border-radius: 0.5rem;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        }

        /* Reporte final: contorno profesional */
        #reportContent .card {
            border: 2px solid #0d6efd;
            box-shadow: 0 0 15px rgba(13, 110, 253, 0.2);
        }

        #reportMap img {
            border: 1px solid #ddd;
            padding: 5px;
            background: #fff;
            max-width: 100%;
            border-radius: 0.5rem;
        }

        /* Overlay de carga: spinner y barra de progreso */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #progressBar {
            width: 80%;
            margin-top: 1rem;
        }

        /* Ayudas en los inputs */
        .input-help {
            font-size: 0.875rem;
            color: #6c757d;
        }
    </style>
    <!-- Se omite leaflet-image ya que el mapa permanece visible -->
</head>

<body>
    <!-- Overlay de carga con spinner y barra de progreso -->
    <div id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Calculando...</span>
        </div>
        <div id="progressBar" class="progress mt-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;"
                id="progressBarFill">
                0%
            </div>
        </div>
    </div>

    <div class="container my-4">
        <h1 class="mb-4 text-center">Evaluación de Proyecto Energético Integral</h1>
        <p class="text-center text-muted">
            Fuente para el Factor de Emisión (CRE):
            <a href="https://www.gob.mx/cms/uploads/attachment/file/895937/Aviso_FE-SEN23.pdf" target="_blank">
                0.438 kgCO₂eq/MWh (2023)
            </a>
        </p>
        <!-- Layout: Mapa siempre visible y Formulario -->
        <div class="row row-custom">
            <!-- Columna Izquierda: Mapa -->
            <div class="col-md-6 left-col">
                <h5 class="text-center">Mapa del Proyecto</h5>
                <div id="map"></div>
                <p class="mt-2 text-center">Utiliza la herramienta de dibujo para delimitar el área.</p>
            </div>
            <!-- Columna Derecha: Formulario multi‑paso -->
            <div class="col-md-6 right-col" id="formSection">
                <form id="multiStepForm">
                    <!-- Paso 1: Selección de Tecnología y Proyecto -->
                    <div class="step" id="step1">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Paso 1: Selección de Tecnología y Proyecto</h5>
                                <div class="row mb-3">
                                    <div class="col">
                                        <label for="techType" class="form-label" data-bs-toggle="tooltip"
                                            title="Selecciona si el proyecto es de tecnología convencional o limpia.">Tipo
                                            de Tecnología:</label>
                                        <select class="form-select" id="techType" required>
                                            <option value="">Seleccione...</option>
                                            <option value="Convencional">Convencional</option>
                                            <option value="Limpia">Limpia</option>
                                        </select>
                                        <div class="input-help">Elige el tipo de tecnología para filtrar los proyectos
                                            disponibles.</div>
                                    </div>
                                    <div class="col">
                                        <label for="projectType" class="form-label" data-bs-toggle="tooltip"
                                            title="Selecciona el tipo de proyecto según la tecnología.">Tipo de
                                            Proyecto:</label>
                                        <select class="form-select" id="projectType" disabled required>
                                            <option value="">Seleccione...</option>
                                        </select>
                                        <div class="input-help">Este campo se habilitará al elegir el tipo de
                                            tecnología.</div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-primary" id="nextStepButton1" onclick="nextStep(1)"
                                    disabled>Siguiente</button>
                            </div>
                        </div>
                    </div>
                    <!-- Paso 2: Captura del Área -->
                    <div class="step d-none" id="step2">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Paso 2: Capturar el Área del Proyecto</h5>
                                <p class="mb-2">Dibuja el área en el mapa y luego presiona "Confirmar Área".</p>
                                <p>Área seleccionada (km²): <span id="areaValue">0 km²</span></p>
                                <p>Sistema detectado: <span id="sistemaDetectado">-</span></p>
                                <p>Marginación detectada: <span id="marginacionDetectada">-</span></p>
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-secondary"
                                        onclick="prevStep(2)">Anterior</button>
                                    <div>
                                        <button type="button" class="btn btn-primary me-2" id="enableDrawing"
                                            onclick="activarDibujo()">Activar Dibujo</button>
                                        <button type="button" class="btn btn-primary me-2" id="confirmAreaBtn"
                                            onclick="confirmAreaFunction()" disabled>Confirmar Área</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Paso 3: Datos Económicos y Extras -->
                    <div class="step d-none" id="step3">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Paso 3: Datos Económicos y Extras</h5>
                                <div class="row mb-3">
                                    <div class="col">
                                        <label for="capacidadInstalada" class="form-label" data-bs-toggle="tooltip"
                                            title="Capacidad total instalada en MW.">Capacidad Instalada (MW):</label>
                                        <input type="number" class="form-control" id="capacidadInstalada"
                                            placeholder="Ej. 50" step="any" required>
                                        <div class="input-help">Ingresa la capacidad total instalada en megavatios.
                                        </div>
                                    </div>
                                    <div class="col">
                                        <label for="eficienciaElectrica" class="form-label" data-bs-toggle="tooltip"
                                            title="Eficiencia promedio en %.">Eficiencia Eléctrica (%) :</label>
                                        <input type="number" class="form-control" id="eficienciaElectrica"
                                            placeholder="Ej. 18" step="any" required>
                                        <div class="input-help">Valor promedio de eficiencia en porcentaje.</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col">
                                        <label for="factorPlanta" class="form-label" data-bs-toggle="tooltip"
                                            title="Factor de planta en % (tiempo de operación real vs. teórico).">Factor
                                            de Planta (%):</label>
                                        <input type="number" class="form-control" id="factorPlanta" placeholder="Ej. 30"
                                            step="any" required>
                                        <div class="input-help">Representa el tiempo de operación real comparado con el
                                            teórico.</div>
                                    </div>
                                    <div class="col">
                                        <label for="inversionPlaneada" class="form-label" data-bs-toggle="tooltip"
                                            title="Inversión total planeada en MXN.">Inversión Planeada (MXN):</label>
                                        <input type="number" class="form-control" id="inversionPlaneada"
                                            placeholder="Ej. 50000000" step="any" required>
                                        <div class="input-help">Monto total que se planea invertir en el proyecto.</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col">
                                        <label for="anioInicio" class="form-label" data-bs-toggle="tooltip"
                                            title="Año en el que se planea iniciar operaciones.">Año de Inicio de
                                            Operaciones:</label>
                                        <select class="form-select" id="anioInicio" required></select>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col">
                                        <label for="costoOM" class="form-label" data-bs-toggle="tooltip"
                                            title="Costo anual de operación y mantenimiento en MXN.">Costo de O&M
                                            (MXN/año):</label>
                                        <input type="number" class="form-control" id="costoOM" placeholder="Ej. 2000000"
                                            step="any" required>
                                        <div class="input-help">Costo anual estimado para operación y mantenimiento.
                                        </div>
                                    </div>
                                    <div class="col">
                                        <label for="distanciaRed" class="form-label" data-bs-toggle="tooltip"
                                            title="Distancia en km a la red de transmisión.">Distancia a Red de
                                            Transmisión (km):</label>
                                        <input type="number" class="form-control" id="distanciaRed" placeholder="Ej. 10"
                                            step="any" required>
                                        <div class="input-help">Distancia estimada hasta la red de transmisión.</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col">
                                        <label for="precioEnergia" class="form-label" data-bs-toggle="tooltip"
                                            title="Precio de la energía en MXN/MWh, asignado automáticamente según ubicación.">Precio
                                            de la Energía (MXN/MWh) (Auto):</label>
                                        <input type="number" class="form-control" id="precioEnergia" step="any"
                                            disabled>
                                    </div>
                                    <div class="col">
                                        <label for="factorEmision" class="form-label" data-bs-toggle="tooltip"
                                            title="Factor de emisión asignado automáticamente (CRE 2023).">Factor de
                                            Emisión (kgCO₂eq/MWh) (Auto):</label>
                                        <input type="number" class="form-control" id="factorEmision" step="any"
                                            disabled>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col">
                                        <label for="indiceMarginacion" class="form-label" data-bs-toggle="tooltip"
                                            title="Índice de marginación calculado según ubicación.">Índice de
                                            Marginación (Auto):</label>
                                        <input type="number" class="form-control" id="indiceMarginacion" step="any"
                                            disabled>
                                    </div>
                                </div>
                                <p class="text-success">Presiona "Generar Reporte Final" para ver el análisis completo.
                                </p>
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-secondary"
                                        onclick="prevStep(3)">Anterior</button>
                                    <button type="button" class="btn btn-primary"
                                        onclick="if(validateInputs()) generateReport()">Generar Reporte Final</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <!-- Fin de la columna derecha -->
        </div>
        <!-- Fin de la fila principal -->

        <!-- Sección de Reporte Final (inicialmente oculta) -->
        <div class="my-4 d-none" id="finalReportSection">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">Reporte Final</h5>
                        <button type="button" class="btn btn-outline-primary" id="btnGuardarPDF">Guardar PDF</button>
                    </div>
                    <div id="reportContent" class="mb-3"></div>
                    <!-- Sección de Características de Zona -->
                    <div class="row">
                        <div class="col-md-6" id="zoneCharacteristics">
                            <h5>Características de la Zona</h5>
                            <p><strong>Permisos cercanos:</strong> 15</p>
                            <p><strong>Estado:</strong> Jalisco</p>
                            <p><strong>Municipio:</strong> Guadalajara</p>
                            <div id="zoneDataContent"></div>
                        </div>
                    </div>
                    <!-- Gráficos existentes -->
                    <div id="chartContainerReturns" style="height: 400px; margin-top:20px;"></div>
                    <div id="chartContainerMargination" style="height: 400px; margin-top:20px;"></div>
                    <div id="chartContainerComparison" style="height: 400px; margin-top:20px;"></div>
                    <div id="chartContainerEnergyComparison" style="height: 400px; margin-top:20px;"></div>
                    <div id="chartContainerRadar" style="height: 400px; margin-top:20px;"></div>
                    <!-- NUEVA Gráfica de Barras: Entidades Federativas -->
                    <div id="chartContainerState" style="height: 400px; margin-top:20px;"></div>
                    <div id="formulasCalculo" class="mt-4">
                        <h5>Fórmulas de Cálculo:</h5>
                        <ul>
                            <li><strong>Generación Estimada (GWh/año):</strong> (Capacidad Instalada × (Factor de
                                Planta/100) × 8760)/1000</li>
                            <li><strong>Ingresos Anuales (MXN):</strong> Generación Estimada × 1000 × Precio de la
                                Energía</li>
                            <li><strong>Neto Anual (MXN):</strong> Ingresos Anuales − Costo de O&M</li>
                            <li><strong>VPN (20 años, MXN):</strong> (Neto Anual × 20) − Inversión Planeada</li>
                            <li><strong>TIR (%):</strong> (Neto Anual / Inversión Planeada) × 100</li>
                            <li><strong>Emisiones (kgCO₂eq/año):</strong> Generación Estimada × 1000 × Factor de Emisión
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts: Bootstrap, Leaflet, Leaflet.draw, Highcharts, html2canvas, jsPDF -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.geometryutil/0.9.3/leaflet.geometryutil.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <!-- Librerías para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Inicializar tooltips
        document.addEventListener('DOMContentLoaded', function () {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
        });

        /* =================== CONFIGURACIÓN GLOBAL =================== */
        const conventionalProjects = ["Combustión Interna", "Termoeléctrica Convencional", "Turbogás", "Importación", "Ciclo Combinado", "Cogeneración"];
        const limpiaProjects = ["Eólica", "Fotovoltaica", "Geotérmica", "Hidroeléctrica", "Nucleoeléctrica", "Bioenergía", "Carboeléctrica"];
        const preciosSistema = { SIN: 966.1458333, BCA: 1443.89625, BCS: 2720.725 };
        const defaultFactorEmision = 0.438;
        const marginationYears = [2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024, 2025, 2026, 2027, 2028, 2029, 2030];
        const marginationData = {
            media: [0.73, 0.74, 0.75, 0.76, 0.77, 0.78, 0.79, 0.80, 0.81, 0.82, 0.83, 0.84, 0.85, 0.86, 0.87, 0.88, 0.89, 0.90, 0.91, 0.92, 0.93],
            alta: [0.68, 0.69, 0.70, 0.71, 0.72, 0.73, 0.74, 0.75, 0.76, 0.77, 0.78, 0.79, 0.80, 0.81, 0.82, 0.83, 0.84, 0.85, 0.86, 0.87, 0.88],
            muy_alta: [0.45, 0.46, 0.47, 0.48, 0.49, 0.50, 0.51, 0.52, 0.53, 0.54, 0.55, 0.56, 0.57, 0.58, 0.59, 0.60, 0.61, 0.62, 0.63, 0.64, 0.65]
        };

        /* =================== FILTRO DE PROYECTOS =================== */
        const techTypeSelect = document.getElementById("techType");
        const projectTypeSelect = document.getElementById("projectType");
        const nextStepButton1 = document.getElementById("nextStepButton1");
        techTypeSelect.addEventListener("change", function () {
            projectTypeSelect.innerHTML = '<option value="">Seleccione...</option>';
            if (this.value === "Convencional") {
                conventionalProjects.forEach(proj => {
                    const option = document.createElement("option");
                    option.value = proj;
                    option.text = proj;
                    projectTypeSelect.appendChild(option);
                });
                projectTypeSelect.disabled = false;
                document.getElementById("factorEmision").value = defaultFactorEmision.toFixed(3);
            } else if (this.value === "Limpia") {
                limpiaProjects.forEach(proj => {
                    const option = document.createElement("option");
                    option.value = proj;
                    option.text = proj;
                    projectTypeSelect.appendChild(option);
                });
                projectTypeSelect.disabled = false;
                document.getElementById("factorEmision").value = "0.000";
            } else {
                projectTypeSelect.disabled = true;
                document.getElementById("factorEmision").value = "";
            }
            checkStep1();
        });
        projectTypeSelect.addEventListener("change", checkStep1);
        function checkStep1() {
            nextStepButton1.disabled = !(techTypeSelect.value && projectTypeSelect.value);
        }

        /* =================== COMBO DE AÑOS (2017–2030) =================== */
        (function fillYears() {
            const anioInicioSelect = document.getElementById("anioInicio");
            for (let y = 2017; y <= 2030; y++) {
                const opt = document.createElement("option");
                opt.value = y;
                opt.text = y;
                anioInicioSelect.appendChild(opt);
            }
        })();

        /* =================== NAVEGACIÓN MULTI-PASO =================== */
        function nextStep(currentStep) {
            document.getElementById("step" + currentStep).classList.add("d-none");
            const nextStepNum = currentStep + 1;
            document.getElementById("step" + nextStepNum).classList.remove("d-none");
            if (nextStepNum === 2) {
                alert("Captura el área en el mapa usando el botón 'Activar Dibujo'.");
            }
        }
        function prevStep(currentStep) {
            document.getElementById("step" + currentStep).classList.add("d-none");
            document.getElementById("step" + (currentStep - 1)).classList.remove("d-none");
        }

        /* =================== MAPA Y DIBUJO =================== */
        const map = L.map('map').setView([19.4326, -99.1332], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        const drawControl = new L.Control.Draw({
            edit: { featureGroup: drawnItems },
            draw: { polygon: true, marker: false, circle: false, rectangle: false, polyline: false, circlemarker: false }
        });
        function activarDibujo() {
            map.addControl(drawControl);
            document.getElementById("enableDrawing").disabled = true;
        }
        map.on('draw:created', function (e) {
            if (e.layerType === 'polygon') {
                drawnItems.clearLayers();
                drawnItems.addLayer(e.layer);
                updateAreaAndMargination();
                document.getElementById("confirmAreaBtn").disabled = false;
            }
        });
        map.on('draw:edited', function () {
            updateAreaAndMargination();
        });
        function updateAreaAndMargination() {
            const layers = drawnItems.getLayers();
            if (layers.length > 0) {
                const layer = layers[0];
                const latLngs = layer.getLatLngs()[0];
                // Calcular el área en m² y convertir a km²
                const area = L.GeometryUtil.geodesicArea(latLngs);
                const areaKm2 = area / 1000000;
                const areaFormatted = areaKm2.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById("areaValue").innerText = areaFormatted + " km²";
                window.calculatedAreaKm2 = areaKm2;
                layer.bindTooltip("Área: " + areaFormatted + " km²", { permanent: true, direction: "center" }).openTooltip();
                layer.bindPopup("Área: " + areaFormatted + " km²").openPopup();
                const centroid = getPolygonCentroid(latLngs);
                const sistema = detectSistema(centroid);
                document.getElementById("sistemaDetectado").innerText = sistema;
                document.getElementById("precioEnergia").value = preciosSistema[sistema].toFixed(6);
                const marginacion = detectMargination(centroid);
                document.getElementById("marginacionDetectada").innerText = marginacion;
                marginationTypeDetected = marginacion;
                let indice = 50;
                if (marginacion === "alta") indice = 75;
                if (marginacion === "muy_alta") indice = 90;
                document.getElementById("indiceMarginacion").value = indice;
            }
        }
        function getPolygonCentroid(latLngs) {
            let latSum = 0, lngSum = 0;
            latLngs.forEach(ll => { latSum += ll.lat; lngSum += ll.lng; });
            return { lat: latSum / latLngs.length, lng: lngSum / latLngs.length };
        }
        function detectSistema({ lat, lng }) {
            if (lat >= 27 && lat <= 32.72 && lng >= -117.5 && lng <= -114) return "BCA";
            if (lat >= 22.7 && lat <= 27 && lng >= -115 && lng <= -108) return "BCS";
            return "SIN";
        }
        function detectMargination({ lat, lng }) {
            if (lat < 22) return "muy_alta";
            if (lat < 26) return "alta";
            return "media";
        }
        function confirmAreaFunction() {
            map.removeControl(drawControl);
            document.getElementById("confirmAreaBtn").disabled = true;
            map.dragging.disable();
            map.doubleClickZoom.disable();
            map.scrollWheelZoom.disable();
            map.touchZoom.disable();
            document.getElementById("step2").classList.add("d-none");
            document.getElementById("step3").classList.remove("d-none");
        }

        /* =================== VALIDACIÓN DE INPUTS =================== */
        function validateInputs() {
            let valid = true;
            const validations = [
                { id: "capacidadInstalada", min: 0.0001 },
                { id: "eficienciaElectrica", min: 0.0001, max: 100 },
                { id: "factorPlanta", min: 0.0001, max: 100 },
                { id: "inversionPlaneada", min: 0.0001 },
                { id: "precioEnergia", min: 0.0001 },
                { id: "costoOM", min: 0.0001 },
                { id: "distanciaRed", min: 0 }
            ];
            validations.forEach(item => {
                const input = document.getElementById(item.id);
                const value = parseFloat(input.value);
                if (isNaN(value) || value < item.min || (item.max !== undefined && value > item.max)) {
                    valid = false;
                    input.classList.add("is-invalid");
                    if (!input.nextElementSibling || !input.nextElementSibling.classList.contains("invalid-feedback")) {
                        const feedback = document.createElement("div");
                        feedback.className = "invalid-feedback";
                        feedback.innerText = "Ingrese un valor numérico válido" +
                            (item.max !== undefined ? " (entre " + item.min + " y " + item.max + ")." : " mayor que 0.");
                        input.parentNode.insertBefore(feedback, input.nextSibling);
                    }
                } else {
                    input.classList.remove("is-invalid");
                    if (input.nextElementSibling && input.nextElementSibling.classList.contains("invalid-feedback")) {
                        input.nextElementSibling.remove();
                    }
                }
            });
            return valid;
        }

        /* =================== GENERACIÓN DEL REPORTE Y GRÁFICOS =================== */
        function calcPercentile(value, sortedArray) {
            let countBelow = 0;
            for (let i = 0; i < sortedArray.length; i++) {
                if (sortedArray[i] <= value) countBelow++;
                else break;
            }
            return (countBelow / sortedArray.length) * 100;
        }

        function generateReport() {
            if (!validateInputs()) {
                alert("Por favor, revise y corrija los campos numéricos.");
                return;
            }
            const loadingOverlay = document.getElementById("loadingOverlay");
            const progressBarFill = document.getElementById("progressBarFill");
            loadingOverlay.style.display = "flex";
            progressBarFill.style.width = "10%";
            progressBarFill.innerText = "10%";

            // Recoger datos del formulario
            const techType = document.getElementById("techType").value;
            const projectType = document.getElementById("projectType").value;
            const areaText = document.getElementById("areaValue").innerText;
            const area = parseFloat(areaText.replace(" km²", "")) || 0;
            const capacidadInstalada = parseFloat(document.getElementById("capacidadInstalada").value) || 0;
            const eficienciaElectrica = parseFloat(document.getElementById("eficienciaElectrica").value) || 0;
            const factorPlanta = parseFloat(document.getElementById("factorPlanta").value) || 0;
            const inversionPlaneada = parseFloat(document.getElementById("inversionPlaneada").value) || 0;
            const anioInicio = parseInt(document.getElementById("anioInicio").value) || 2023;
            const precioEnergia = parseFloat(document.getElementById("precioEnergia").value) || 0;
            const indiceMarginacion = parseFloat(document.getElementById("indiceMarginacion").value) || 0;
            const costoOM = parseFloat(document.getElementById("costoOM").value) || 0;
            const distanciaRed = parseFloat(document.getElementById("distanciaRed").value) || 0;
            let factorEmision = (techType === "Convencional") ? defaultFactorEmision : 0;
            document.getElementById("factorEmision").value = factorEmision.toFixed(3);

            progressBarFill.style.width = "20%";
            progressBarFill.innerText = "20%";

            const generacionEstimada = (capacidadInstalada * (factorPlanta / 100) * 8760) / 1000;
            const ingresosAnuales = generacionEstimada * 1000 * precioEnergia;
            const netoAnual = ingresosAnuales - costoOM;
            const anosAnalisis = 20;
            const vpn = (netoAnual * anosAnalisis) - inversionPlaneada;
            const tir = (netoAnual / inversionPlaneada) * 100;
            let emisionesProyecto = 0, emisionesReferencia = 0;
            if (techType === "Convencional") {
                emisionesProyecto = generacionEstimada * 1000 * factorEmision;
                emisionesReferencia = emisionesProyecto * 0.3;
            }

            progressBarFill.style.width = "30%";
            progressBarFill.innerText = "30%";

            let razones = [];
            if (distanciaRed > 50) {
                razones.push("La red de transmisión está muy lejos, lo que implica altos costos de interconexión.");
            }
            if (indiceMarginacion > 80) {
                razones.push("El área tiene un alto índice de marginación, lo que genera beneficios sociales importantes, aunque puede implicar retos regulatorios.");
            }
            if (vpn <= 0 || tir <= 15 || generacionEstimada < 50) {
                razones.push("La rentabilidad (VPN, TIR o generación) no es suficientemente alta.");
            }
            if (techType === "Convencional" && emisionesProyecto > 1e7) {
                razones.push("Las emisiones son muy elevadas, lo que podría dificultar la aprobación del proyecto.");
            }
            let decision = "";
            if (razones.length === 0) {
                decision = "El proyecto presenta indicadores positivos. Se recomienda avanzar con el proyecto.";
            } else {
                decision = "El proyecto tiene potencial, pero sugerimos revisar los siguientes aspectos para mejorar su viabilidad:<ul>" +
                    razones.map(r => `<li>${r}</li>`).join("") +
                    "</ul>Considera estas sugerencias como áreas de oportunidad para optimizar el proyecto.";
            }

            progressBarFill.style.width = "40%";
            progressBarFill.innerText = "40%";

            document.getElementById("finalReportSection").classList.remove("d-none");

            fetch("datos.json")
                .then(resp => resp.json())
                .then(dataHist => {
                    progressBarFill.style.width = "60%";
                    progressBarFill.innerText = "60%";

                    let possibleTechs = (techType === "Convencional") ? conventionalProjects : limpiaProjects;
                    const datosFiltrados = dataHist.filter(item => {
                        let tech = (item.Tecnología || "").trim();
                        return possibleTechs.includes(tech);
                    });
                    let analisisHistorico = "";
                    let chart4DataPromedio = [0, 0, 0];
                    if (datosFiltrados.length > 0) {
                        let arrAreas = [], arrCaps = [], arrInvs = [];
                        datosFiltrados.forEach(item => {
                            let aVal = parseFloat(item["Área final en km2"]);
                            if (!aVal || isNaN(aVal)) {
                                aVal = parseFloat(item["Área final en m2"]) ? parseFloat(item["Área final en m2"]) / 1000000 : 0;
                            }
                            arrAreas.push(aVal);
                            let cVal = parseFloat(item["Capacidad_autorizada_MW"]) || 0;
                            arrCaps.push(cVal);
                            let iVal = parseFloat(item["Inversión"]) || 0;
                            arrInvs.push(iVal);
                        });
                        arrAreas.sort((a, b) => a - b);
                        arrCaps.sort((a, b) => a - b);
                        arrInvs.sort((a, b) => a - b);
                        const n = datosFiltrados.length;
                        const promArea = arrAreas.reduce((sum, v) => sum + v, 0) / n;
                        const promCap = arrCaps.reduce((sum, v) => sum + v, 0) / n;
                        const promInv = arrInvs.reduce((sum, v) => sum + v, 0) / n;
                        const areaPercentile = calcPercentile(area, arrAreas);
                        const capPercentile = calcPercentile(capacidadInstalada, arrCaps);
                        analisisHistorico = `
            <p><strong>Análisis Histórico (Basado en ${n} permisos autorizados):</strong></p>
            <ul>
              <li>Área autorizada promedio: ${promArea.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} km².</li>
              <li>Capacidad autorizada promedio: ${promCap.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MW.</li>
              <li>Inversión promedio: $${promInv.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MXN.</li>
            </ul>
            <p>El área propuesta se encuentra en el percentil <strong>${areaPercentile.toFixed(1)}%</strong> y la capacidad en el percentil <strong>${capPercentile.toFixed(1)}%</strong> de la base histórica.</p>
          `;
                        chart4DataPromedio = [promArea, promCap, promInv];
                    } else {
                        analisisHistorico = "<p>No se encontraron datos históricos para la tecnología seleccionada.</p>";
                    }

                    progressBarFill.style.width = "70%";
                    progressBarFill.innerText = "70%";

                    let zoneHTML = `
          <h5>Características de la Zona</h5>
          <p><strong>Permisos cercanos:</strong> 15</p>
          <p><strong>Estado:</strong> Jalisco</p>
          <p><strong>Municipio:</strong> Guadalajara</p>
          <div id="zoneDataContent"></div>
        `;
                    document.getElementById("zoneDataContent").innerHTML = zoneHTML;

                    const reportHTML = `
          <div class="card bg-light">
            <div class="card-header text-center">
              <h4>Reporte Integral del Proyecto</h4>
            </div>
            <div class="card-body">
              <h5 class="card-title">Resumen del Proyecto</h5>
              <p><strong>Tipo de Tecnología:</strong> ${techType}</p>
              <p><strong>Tipo de Proyecto:</strong> ${projectType}</p>
              <p>
                <strong>Área Seleccionada:</strong>
                <span data-bs-toggle="tooltip" title="Área delimitada en el mapa"> ${area.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} km²</span>
              </p>
              <p>
                <strong>Capacidad Instalada:</strong>
                <span data-bs-toggle="tooltip" title="Capacidad total instalada en MW"> ${capacidadInstalada.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MW</span>
              </p>
              <p>
                <strong>Generación Estimada:</strong>
                <span data-bs-toggle="tooltip" title="(Capacidad Instalada × (Factor de Planta/100) × 8760)/1000"> ${generacionEstimada.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} GWh/año</span>
              </p>
              <p>
                <strong>Ingresos Anuales (antes de O&M):</strong>
                <span data-bs-toggle="tooltip" title="Generación Estimada × 1000 × Precio de la Energía"> $${ingresosAnuales.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MXN</span>
              </p>
              <p>
                <strong>Costo de O&M:</strong>
                <span data-bs-toggle="tooltip" title="Costo anual de operación y mantenimiento"> $${costoOM.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MXN/año</span>
              </p>
              <p>
                <strong>VPN (20 años):</strong>
                <span data-bs-toggle="tooltip" title="(Neto Anual × 20) − Inversión Planeada"> $${vpn.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MXN</span>
              </p>
              <p>
                <strong>TIR:</strong>
                <span data-bs-toggle="tooltip" title="(Neto Anual / Inversión Planeada) × 100"> ${tir.toFixed(2)}%</span>
              </p>
              ${techType === "Convencional"
                            ? `<p>
                      <strong>Emisiones Estimadas:</strong>
                      <span data-bs-toggle="tooltip" title="Generación Estimada × 1000 × Factor de Emisión"> ${emisionesProyecto.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kgCO₂eq/año</span>
                    </p>`
                            : `<p><strong>Beneficio Ambiental:</strong> Emisiones casi nulas.</p>`
                        }
              <p><strong>Índice de Marginación:</strong> ${indiceMarginacion}</p>
              <p><strong>Distancia a Red de Transmisión:</strong> ${distanciaRed.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} km</p>
              <p><strong>Factor de Emisión (CRE 2023):</strong> ${factorEmision.toFixed(3)} kgCO₂eq/MWh</p>
              <hr>
              ${analisisHistorico}
              <hr>
              <h5>Decisión de Inversión:</h5>
              <p>${decision}</p>
              <hr>
              <h5>Fórmulas de Cálculo:</h5>
              <ul>
                <li><strong>Generación Estimada (GWh/año):</strong> (Capacidad Instalada × (Factor de Planta/100) × 8760)/1000</li>
                <li><strong>Ingresos Anuales (MXN):</strong> Generación Estimada × 1000 × Precio de la Energía</li>
                <li><strong>Neto Anual (MXN):</strong> Ingresos Anuales − Costo de O&M</li>
                <li><strong>VPN (20 años, MXN):</strong> (Neto Anual × 20) − Inversión Planeada</li>
                <li><strong>TIR (%):</strong> (Neto Anual / Inversión Planeada) × 100</li>
                <li><strong>Emisiones (kgCO₂eq/año):</strong> Generación Estimada × 1000 × Factor de Emisión</li>
              </ul>
            </div>
          </div>
          `;
                    document.getElementById("reportContent").innerHTML = reportHTML;

                    progressBarFill.style.width = "70%";
                    progressBarFill.innerText = "70%";

                    // Gráficos existentes
                    const nYears = 8;
                    const returnsSIN = computeReturnsOverYears(generacionEstimada, preciosSistema.SIN, inversionPlaneada, nYears, costoOM);
                    const returnsBCA = computeReturnsOverYears(generacionEstimada, preciosSistema.BCA, inversionPlaneada, nYears, costoOM);
                    const returnsBCS = computeReturnsOverYears(generacionEstimada, preciosSistema.BCS, inversionPlaneada, nYears, costoOM);
                    Highcharts.chart('chartContainerReturns', {
                        chart: { type: 'line' },
                        title: { text: 'Retornos Futuros Acumulados e Inversión' },
                        xAxis: {
                            categories: Array.from({ length: nYears + 1 }, (_, i) => i.toString()),
                            title: { text: 'Años' }
                        },
                        yAxis: { title: { text: 'Retorno Acumulado (MXN)' } },
                        series: [
                            { name: 'Retorno SIN', data: returnsSIN },
                            { name: 'Retorno BCA', data: returnsBCA },
                            { name: 'Retorno BCS', data: returnsBCS }
                        ]
                    });

                    Highcharts.chart('chartContainerMargination', {
                        chart: { type: 'line' },
                        title: { text: `Evolución de la Marginación (${marginationTypeDetected})` },
                        xAxis: { categories: marginationYears.map(String), title: { text: 'Año' } },
                        yAxis: { title: { text: 'Índice de Marginación' } },
                        series: [{
                            name: `Marginación - ${marginationTypeDetected}`,
                            data: marginationData[marginationTypeDetected] || []
                        }]
                    });

                    let relArea = chart4DataPromedio[0] ? (area / chart4DataPromedio[0]) * 100 : 0;
                    let relCap = chart4DataPromedio[1] ? (capacidadInstalada / chart4DataPromedio[1]) * 100 : 0;
                    let relInv = chart4DataPromedio[2] ? (inversionPlaneada / chart4DataPromedio[2]) * 100 : 0;
                    Highcharts.chart('chartContainerComparison', {
                        chart: { polar: true, type: 'line' },
                        title: { text: 'Comparación Relativa (Propuesto vs. Promedio Histórico)' },
                        pane: { size: '80%' },
                        xAxis: { categories: ['Área (km²)', 'Capacidad (MW)', 'Inversión (MXN)'], tickmarkPlacement: 'on', lineWidth: 0 },
                        yAxis: { gridLineInterpolation: 'polygon', lineWidth: 0, min: 0, title: { text: 'Porcentaje (%)' } },
                        tooltip: { shared: true, pointFormatter: function () { return Highcharts.numberFormat(this.y, 1, ",", ".") + "%"; } },
                        series: [{
                            name: 'Propuesto',
                            data: [relArea, relCap, relInv],
                            pointPlacement: 'on'
                        }, {
                            name: 'Promedio Hist.',
                            data: [100, 100, 100],
                            pointPlacement: 'on'
                        }],
                        responsive: {
                            rules: [{
                                condition: { maxWidth: 500 },
                                chartOptions: { legend: { align: 'center', verticalAlign: 'bottom' }, pane: { size: '70%' } }
                            }]
                        }
                    });

                    // Gráfico: Comparación Energética: Convencional vs. Limpia
                    let totalGenConvencional = 0, totalGenLimpia = 0;
                    dataHist.forEach(item => {
                        const gen = parseFloat(item["Generacion_bruta_o_importacion_gwh"]) || 0;
                        const tech = (item.Tecnología || "").trim();
                        if (conventionalProjects.includes(tech)) {
                            totalGenConvencional += gen;
                        } else if (limpiaProjects.includes(tech)) {
                            totalGenLimpia += gen;
                        }
                    });
                    Highcharts.chart('chartContainerEnergyComparison', {
                        chart: { type: 'column' },
                        title: { text: 'Comparación Energética: Convencional vs. Limpia' },
                        xAxis: {
                            categories: ['Convencional', 'Limpia'],
                            title: { text: 'Tipo de Tecnología' }
                        },
                        yAxis: {
                            min: 0,
                            title: { text: 'Generación Bruta Total (GWh/año)' }
                        },
                        series: [{
                            name: 'Generación Histórica',
                            data: [totalGenConvencional, totalGenLimpia]
                        }]
                    });

                    // Gráfico de Radar: Comparación de Coeficientes de Desempeño
                    const promedioEficiencia = 20; // Ejemplo
                    const promedioFactorPlanta = 30; // Ejemplo
                    const promedioTIR = 18; // Ejemplo
                    Highcharts.chart('chartContainerRadar', {
                        chart: { polar: true, type: 'line' },
                        title: { text: 'Comparación de Coeficientes de Desempeño' },
                        pane: { size: '80%' },
                        xAxis: {
                            categories: ['Eficiencia Eléctrica (%)', 'Factor de Planta (%)', 'TIR (%)'],
                            tickmarkPlacement: 'on',
                            lineWidth: 0
                        },
                        yAxis: {
                            gridLineInterpolation: 'polygon',
                            lineWidth: 0,
                            min: 0
                        },
                        tooltip: {
                            shared: true,
                            pointFormatter: function () {
                                return Highcharts.numberFormat(this.y, 1, ",", ".") + " %";
                            }
                        },
                        series: [{
                            name: 'Propuesta',
                            data: [eficienciaElectrica, factorPlanta, tir],
                            pointPlacement: 'on'
                        }, {
                            name: 'Promedio Histórico',
                            data: [promedioEficiencia, promedioFactorPlanta, promedioTIR],
                            pointPlacement: 'on'
                        }]
                    });

                    // NUEVA Gráfica: Barras por Entidad Federativa
                    // Datos de ejemplo para la gráfica de barras
                    const estadosData = [
                        { state: "Jalisco", index: 35 },
                        { state: "Nuevo León", index: 50 },
                        { state: "Veracruz", index: 70 },
                        { state: "Puebla", index: 80 },
                        { state: "Chiapas", index: 90 }
                    ];
                    // Se asume que "Jalisco" es la entidad seleccionada (extraer de datos reales en producción)
                    const selectedState = "Jalisco";
                    const categoriesEstados = estadosData.map(item => item.state);
                    const dataEstados = estadosData.map(item => {
                        // Asigna el color de relleno según el índice: bajo (<40): verde, medio (40-70): amarillo, alto (>70): rojo.
                        let fillColor = item.index < 40 ? "#28a745" : (item.index <= 70 ? "#ffc107" : "#dc3545");
                        // Resalta la barra de la entidad seleccionada con un contorno dorado; las demás con contorno gris.
                        let borderColor = (item.state === selectedState) ? "#FFD700" : "#6c757d";
                        let borderWidth = (item.state === selectedState) ? 3 : 1;
                        return {
                            y: item.index,
                            color: fillColor,
                            borderColor: borderColor,
                            borderWidth: borderWidth,
                            dataLabels: {
                                enabled: true,
                                format: '{y}%'
                            }
                        };
                    });
                    Highcharts.chart('chartContainerState', {
                        chart: { type: 'column' },
                        title: { text: 'Índice de Pobreza Energética por Entidad Federativa' },
                        xAxis: {
                            categories: categoriesEstados,
                            title: { text: 'Entidad Federativa' }
                        },
                        yAxis: {
                            min: 0,
                            max: 100,
                            title: { text: 'Índice (%)' }
                        },
                        plotOptions: {
                            column: {
                                borderWidth: 2,
                                dataLabels: { enabled: true, format: '{point.y:.1f}%' }
                            }
                        },
                        series: [{
                            name: 'Índice',
                            data: dataEstados
                        }]
                    });

                    progressBarFill.style.width = "100%";
                    progressBarFill.innerText = "100%";
                    setTimeout(() => {
                        document.getElementById("loadingOverlay").style.display = "none";
                        document.getElementById("finalReportSection").scrollIntoView({ behavior: "smooth" });
                    }, 500);
                })
                .catch(error => {
                    console.error("Error al cargar datos históricos:", error);
                    document.getElementById("reportContent").innerHTML += "<p>Error al cargar datos históricos.</p>";
                    document.getElementById("loadingOverlay").style.display = "none";
                });
        }

        function computeReturnsOverYears(gwhBase, price, inversion, nYears, costoOM) {
            const ingresosAnuales = gwhBase * 1000 * price;
            let data = [];
            for (let i = 0; i <= nYears; i++) {
                data.push(((ingresosAnuales - costoOM) * i) - inversion);
            }
            return data;
        }

        // Botón para guardar PDF usando html2canvas y jsPDF
        document.getElementById("btnGuardarPDF").addEventListener("click", function () {
            setTimeout(() => {
                html2canvas(document.querySelector(".container")).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save('reporte_proyecto.pdf');
                });
            }, 500);
        });
    </script>
</body>

</html>